<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Dashboard - Enhanced</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgb(51, 65, 85); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgb(100, 116, 139); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgb(148, 163, 184); }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        
        .admin-card {
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .office-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgb(51, 65, 85);
            border-radius: 6px;
            font-size: 12px;
            margin: 2px;
        }
        
        .office-tag button {
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgb(71, 85, 105);
        }
        
        .office-tag button:hover {
            background: rgb(239, 68, 68);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // PART 1: API Configuration and Constants
        const SHEET_ID = '1asg-4czF_ITFPxvBpyRcjMLjhjl6XGRk0_FLsrQ4D6g';
        const SHEET_ID_2 = '1U0DAPmqFTSI343bls0sj732JsRb7a6E_QLwNLSqAklw';
        const SHEET_ID_3 = '1kPorRymNrDSzUXkCwliBWOllBvAILQDWtvrtdyZBTuo';
        const API_KEY = 'AIzaSyAeiFMlkhhDjEahdKksbS6HomSCbO9iQ50';
        const ADMIN_PASSWORD = 'admin123';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyazCKPIVEwO22zSrASgpua_OmZJyYtenwz570ufu1VJ2sxc3TPNwRFLN34y2v1DQSY/exec';

        const COLLECTION_SHEETS = [
            'CA-CH', 'CA-WC', 'CA-QH', 'CA-TS', 'CA-SPD',
            'WA-AR', 'WA-LW', 'WA-AL', 'WA-SS', 'WA-BD',
            'WA-BR', 'WA-NP', 'WA-FW', 'WA-WD', 'WA-FD',
            'WA-SM', 'WA-BL', 'WA-SP', 'WA-SH', 'WA-PY', 'WA-FF',
            'WA-TM', 'WA-UP', 'WA-DP', 'WA-AD', 'WA-WO-FD', 'WA-WO-BD', 'AK'
        ];

        const tasksList = [
            'Aging- Closed Denied Claims', 'Aging- Closed Paid Claims', 'Aging- Resubmit Claims',
            'Aging- Review Claims', 'Aging- Voided Claims', 'Allocation Correction Log',
            'Appointment Chart Update', 'Bank Tracker', 'Batching Claims', 'Batching Statement',
            'Billing- Inbound Call', 'Billing- Outbound Call', 'Call Listening', 'Claims Attachments',
            'Claims Not Sent', 'Compliance', 'Credentialing', 'Daily KPI Reports', 'Doctor Payroll',
            'Entering EOBs', 'Entering Kleer Payments', 'Entering Payments', 'FA Set-up',
            'Fax Data Cleaning', "Finalizing Pt's Ledger", 'Gateway Closing- CC',
            'Importing Fee Schedule to OD', 'Itemized Receipt', 'Kleer Set-up',
            'Korean Scheduled List', 'Korean Translation', 'Ledger Allocation', 'Medicaid Report',
            'Outstanding Claims Report', 'Processing CC Payments', 'Procedure Not Billed (Sent/Batched)',
            'Procedure not Billed Report', 'Receiving Pre-Determination (PA)',
            'Receiving Service Authorization (SA)', 'Reconciliation', 'Records Release',
            'Rejected Claims Resubmission', 'Retrieving EOBs/eChecks', 'Retrieving Fee Schedule',
            'Sending Appeal/MJ', 'Sending Medicaid Claims', 'Sending Private Claims',
            'Sending Pre-Determination (PA)', 'Sending Service Authorization (SA)',
            'Sending Statements', 'Sending to Collection Agency', 'Sorting of Korean Accounts',
            'Submitting Denied/Refund Letters', 'Void/Adjustment Request', 'WA Marketing Report',
            '20MIN Confirmation Call', '24HR Confirmation Call', '48HR Confirmation Call',
            'GA', 'Inbound Appt', 'Inbound Call', 'Inbound Text Appt', 'Inbound Text',
            'Labslip', 'Outbound Appt', 'Outbound Call', 'Outbound Text Appt', 'Outbound Text',
            'Patient Paperworks', 'Travel PA', 'Treatment Call', 'Scheduling VA Patients',
            'Checking VA Portal Status', 'Processing ADA & RFS Forms', 'Calling VA Facilities/Patients',
            'Submitting ADA/RFS/XRAYS/Implant Form', 'Handling VA-related Tasks',
            'Verification (M)', 'Verification (P)', 'Verification Tracker Update',
            'Email/Teams Checked', 'Meeting', 'Miscellaneous Tasks', 'Training', 'VM Set up',
            'Gathering Dental Info', 'Gathering Insurance Info', 'Verification',
            'Clinic Closing Report', 'Kakao Lab Monitoring', 'Coding'
        ];

        const taskMapping = {
            'aging- closed denied claims': 'Outstanding Claims',
            'aging- closed paid claims': 'Outstanding Claims',
            'aging- resubmit claims': 'Outstanding Claims',
            'aging- review claims': 'Outstanding Claims',
            'aging- voided claims': 'Outstanding Claims',
            'billing- inbound call': 'Billing Call',
            'billing- outbound call': 'Billing Call',
            'receiving pre-determination (pa)': 'Receiving PA/SA',
            'receiving service authorization (sa)': 'Receiving PA/SA',
            'sending medicaid claims': 'Sending Claims',
            'sending private claims': 'Sending Claims',
            'verification (m)': 'Verification (M)',
            'verification (p)': 'Verification (P)'
        };

        const taskLookup = {};
        tasksList.forEach(taskName => { taskLookup[taskName.toLowerCase().trim()] = taskName; });
        Object.entries(taskMapping).forEach(([original, standard]) => { taskLookup[original] = standard; });

        // Employee name normalization
        const employeeNameMapping = {
            'ADIVINAGRACIA': 'AD', 'ADIVINA': 'AD', '**AD': 'AD', 'ABARIOGA': 'AB', '**AB': 'AB',
            'BZARATE': 'BZ', '**BZ': 'BZ', 'GAGBUYA': 'GA', 'ISECONG': 'IS', 'HBAGAPORO': 'HGB',
            'JARREY': 'JA', 'RDELAPAZ': 'RD', 'KMAPAIT': 'KPM', 'GGUJILDE': 'GG', 'JMORTIZ': 'JM',
            'LGUARNES': 'LG', 'LSALAGANTIN': 'LSA', 'JSIMYUNN': 'JS', 'MAUGUSTO': 'MA',
            'MBONGO': 'MB', 'MBACLAYON': 'MCB', 'MSAQUIAN': 'MGS', 'NBOLIVAR': 'NB',
            'PTIPAN': 'PT', 'JMERCADO': 'RM', 'VRUZOL': 'VR', 'SADVINCULA': 'SPA',
            '**GA': 'GA', '**IS': 'IS', '**HGB': 'HGB', '**JA': 'JA', '**RD': 'RD',
            '**KPM': 'KPM', '**GG': 'GG', '**JM': 'JM', '**LG': 'LG', '**LSA': 'LSA',
            '**JS': 'JS', '**MA': 'MA', '**MB': 'MB', '**MCB': 'MCB', '**MGS': 'MGS',
            '**NB': 'NB', '**PT': 'PT', '**RM': 'RM', '**VR': 'VR', '**SPA': 'SPA',
            'CLIGASAN': 'JL', 'GCOLINARES': 'GC', 'CBONOSTRO': 'CB', 'DAULIDA': 'DMA',
            'EMPANGILINAN': 'EMP', 'JCUNANAN': 'JC', 'BMANALO': 'BM', 'PBENITEZ': 'PB',
            'NZAMBRANO': 'NZ', 'VLAGAN': 'VL', 'ISTACRUZ': 'ISC', 'LLAGAN': 'LL',
            'EDORONIO': 'ED', 'LVILLARES': 'LV', 'SSALVEJO': 'SMS', 'CCAPISPISAN': 'CDC',
            'JCADAVEZ': 'JRC', 'ADAUMAR': 'AMD', 'HALFONSO': 'HMA', 'JOGARIO': 'JP',
            'IMORGADO': 'IM', 'GPAYORAN': 'GP', 'WMEJARES': 'WM', 'RGUAVES': 'RG',
            'CCAPOY': 'CC', 'JINCENZO': 'JI', 'GDELACRUZ': 'GD', 'JHUAGON': 'JI',
            'MSECONG': 'IS', 'ABARIOGA': 'AB', 'JMORTIZ': 'RM',
            'CFAJARDO': 'CF', 'GZAMORA': 'GZ', 'JCBAUTISTA': 'JCB', 'JTLOPEZ': 'JTL',
            'KRIVERA': 'KR', 'MLCASTRO': 'MLC', 'RSANTOS': 'RS', 'BDZULETA': 'BDZ'
        };

        // Helper Functions
        const parseNumericValue = (value) => {
            if (value === null || value === undefined) return 0;
            if (typeof value === 'number') return value;
            const str = value.toString().trim();
            if (str === '' || str === '-') return 0;
            const cleaned = str.replace(/[$,\s]/g, '');
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        };

        const normalizeEmployeeName = (rawName) => {
            if (!rawName) return null;
            let name = rawName.trim().replace(/^["']|["']$/g, '');
            name = name.replace(/^\d+\.?\d*\s+/, '');
            if (name.includes(' - ')) name = name.split(' - ')[0].trim();
            name = name.replace(/\s+[RP]$/i, '');
            
            const upperName = name.toUpperCase();
            if (employeeNameMapping[upperName]) return employeeNameMapping[upperName];
            
            const noSpaces = upperName.replace(/\s+/g, '');
            if (employeeNameMapping[noSpaces]) return employeeNameMapping[noSpaces];
            
            if (name.length >= 2 && /^[a-z]+$/.test(name)) {
                const possibleInitials = name.substring(0, 2).toUpperCase();
                const match = name.match(/^([a-z])[aeiou]*([a-z])/i);
                if (match) {
                    const initials = (match[1] + match[2]).toUpperCase();
                    return initials;
                }
                return possibleInitials;
            }
            
            return name.toUpperCase();
        };

        const findTaskName = (taskName) => {
            const normalized = taskName.toLowerCase().trim();
            return taskLookup[normalized] || null;
        };

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            let dateOnly = dateStr.toString().trim();
            if (dateOnly.includes(' ')) dateOnly = dateOnly.split(' ')[0];
            if (dateOnly.includes('-')) {
                const parts = dateOnly.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const day = parseInt(parts[2], 10);
                    return new Date(year, month, day, 12, 0, 0, 0);
                }
            }
            if (dateOnly.includes('/')) {
                const parts = dateOnly.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0], 10) - 1;
                    const day = parseInt(parts[1], 10);
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day, 12, 0, 0, 0);
                }
            }
            return null;
        };

        const shiftWeekendToWeekday = (date) => {
            if (!date) return null;
            const dayOfWeek = date.getDay();
            const newDate = new Date(date);
            if (dayOfWeek === 0) newDate.setDate(newDate.getDate() + 1);
            else if (dayOfWeek === 6) newDate.setDate(newDate.getDate() - 1);
            return newDate;
        };

        const countWorkingDays = (startDate, endDate) => {
            if (!startDate || !endDate) return 0;
            let count = 0;
            let current = new Date(startDate);
            while (current <= endDate) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) count++;
                current.setDate(current.getDate() + 1);
            }
            return count;
        };

        const getPerformanceColor = (percentage) => {
            if (percentage >= 90) return { bg: 'from-emerald-500 to-green-400', text: 'text-emerald-300', icon: 'bg-emerald-600/20', border: 'border-emerald-400' };
            if (percentage >= 75) return { bg: 'from-lime-500 to-green-400', text: 'text-lime-300', icon: 'bg-lime-600/20', border: 'border-lime-400' };
            if (percentage >= 60) return { bg: 'from-yellow-500 to-amber-400', text: 'text-yellow-300', icon: 'bg-yellow-600/20', border: 'border-yellow-400' };
            if (percentage >= 40) return { bg: 'from-orange-500 to-yellow-400', text: 'text-orange-300', icon: 'bg-orange-600/20', border: 'border-orange-400' };
            return { bg: 'from-red-500 to-orange-400', text: 'text-red-300', icon: 'bg-red-600/20', border: 'border-red-400' };
        };

        // Admin Config Functions
        const fetchAdminConfig = async () => {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Admin_Config!A:I?key=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch Admin_Config');
                const result = await response.json();
                const rows = result.values || [];
                
                if (rows.length === 0) return { employees: [], goals: [], offices: new Set(), employeeCodes: new Set() };
                
                const data = rows.slice(1);
                const employees = [];
                const goals = [];
                const offices = new Set();
                const employeeCodes = new Set();
                
                data.forEach(row => {
                    const employeeCode = row[0] || '';
                    const department = row[1] || '';
                    const office = row[2] || '';
                    const state = row[3] || '';
                    const goalType = row[4] || '';
                    const goalValue = row[5] || '';
                    const effectiveMonth = row[6] || '';
                    const effectiveYear = row[7] || '';
                    
                    if (office) offices.add(office);
                    
                    if (employeeCode.trim()) {
                        employeeCodes.add(employeeCode);
                        employees.push({
                            employeeCode,
                            department,
                            office,
                            state,
                            effectiveMonth: parseInt(effectiveMonth) || 0,
                            effectiveYear: parseInt(effectiveYear) || 0
                        });
                    } else if (goalType.trim()) {
                        goals.push({
                            department,
                            office,
                            state,
                            goalType,
                            goalValue: parseFloat(goalValue) || 0,
                            effectiveMonth: parseInt(effectiveMonth) || 0,
                            effectiveYear: parseInt(effectiveYear) || 0
                        });
                    }
                });
                
                return { 
                    employees, 
                    goals, 
                    offices: Array.from(offices).sort(), 
                    employeeCodes: Array.from(employeeCodes).sort() 
                };
            } catch (error) {
                console.error('Error fetching admin config:', error);
                throw error;
            }
        };

        const appendToAdminConfig = async (rowData) => {
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'append',
                    values: [rowData]
                })
            });
            
            // Wait for write to complete
            await new Promise(resolve => setTimeout(resolve, 1000));
            return { success: true };
        } catch (error) {
            console.error('Error appending to admin config:', error);
            throw error;
        }
    };

        const getEmployeeAssignments = (employees, employeeCode, month, year) => {
            const applicable = employees.filter(emp => 
                emp.employeeCode === employeeCode &&
                (emp.effectiveYear < year || (emp.effectiveYear === year && emp.effectiveMonth <= month))
            );
            
            if (applicable.length === 0) return [];
            
            applicable.sort((a, b) => {
                if (b.effectiveYear !== a.effectiveYear) return b.effectiveYear - a.effectiveYear;
                return b.effectiveMonth - a.effectiveMonth;
            });
            
            // Return all assignments (for multiple offices)
            return applicable;
        };

        const getGoalForOffice = (goals, department, office, goalType, month, year) => {
            const applicable = goals.filter(goal => 
                goal.department === department &&
                goal.office === office &&
                goal.goalType === goalType &&
                (goal.effectiveYear < year || (goal.effectiveYear === year && goal.effectiveMonth <= month))
            );
            
            if (applicable.length === 0) return 0;
            
            applicable.sort((a, b) => {
                if (b.effectiveYear !== a.effectiveYear) return b.effectiveYear - a.effectiveYear;
                return b.effectiveMonth - a.effectiveMonth;
            });
            
            return applicable[0].goalValue || 0;
        };

        // Admin Modal Components
        const PasswordModal = ({ onClose, onSuccess }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === ADMIN_PASSWORD) {
                    onSuccess();
                } else {
                    setError('Incorrect password');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-3 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                            <h2 className="text-2xl font-bold text-white">Admin Access</h2>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="mb-6">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => { setPassword(e.target.value); setError(''); }}
                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-amber-500"
                                    placeholder="Enter admin password"
                                    autoFocus
                                />
                                {error && <p className="text-red-400 text-sm mt-2">{error}</p>}
                            </div>
                            
                            <div className="flex gap-3">
                                <button type="button" onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">
                                    Cancel
                                </button>
                                <button type="submit" className="flex-1 px-4 py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white rounded-xl transition-all font-semibold shadow-lg">
                                    Enter
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const AdminMenu = ({ onClose, onSelectOption }) => {
            const menuItems = [
                { id: 'goals', title: 'Goal Management', icon: 'üìä', desc: 'Set goals by office and month', color: 'from-blue-500 to-cyan-600' },
                { id: 'employees', title: 'Employee Assignment', icon: 'üë•', desc: 'Assign employees to departments', color: 'from-purple-500 to-pink-600' },
                { id: 'add-employee', title: 'Add Employee', icon: '‚ûï', desc: 'Add new employee codes', color: 'from-green-500 to-emerald-600' },
                { id: 'add-office', title: 'Add Office', icon: 'üè¢', desc: 'Add new office locations', color: 'from-orange-500 to-amber-600' }
            ];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-4xl w-full mx-4">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-3 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243m16.97-1.414l-6-6m-6-6l-6 6"/>
                                    </svg>
                                </div>
                                <h2 className="text-2xl font-bold text-white">Admin Dashboard</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {menuItems.map(item => (
                                <div key={item.id} onClick={() => onSelectOption(item.id)} className="admin-card bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-6 border border-slate-600 hover:border-slate-500 cursor-pointer">
                                    <div className="flex items-start gap-4">
                                        <div className={`bg-gradient-to-br ${item.color} p-4 rounded-xl text-3xl shadow-lg`}>{item.icon}</div>
                                        <div className="flex-1">
                                            <h3 className="text-xl font-bold text-white mb-2">{item.title}</h3>
                                            <p className="text-slate-400 text-sm">{item.desc}</p>
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-500">
                                            <polyline points="9 18 15 12 9 6"/>
                                        </svg>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const GoalManagement = ({ onClose, configData }) => {
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [goals, setGoals] = useState([]);
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            useEffect(() => {
                const initialGoals = configData.offices.map(office => {
                    const existingCollection = getGoalForOffice(configData.goals, 'AR Department', office, 'Collection', selectedMonth, selectedYear);
                    const existingProduction = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Production', selectedMonth, selectedYear);
                    const existingAppointment = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Appointment', selectedMonth, selectedYear);
                    const existingCall = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Call', selectedMonth, selectedYear);
                    const existingVerification = getGoalForOffice(configData.goals, 'Verification Department', office, 'Verification', selectedMonth, selectedYear);

                    return {
                        office,
                        collection: existingCollection || '',
                        production: existingProduction || '',
                        appointment: existingAppointment || '',
                        call: existingCall || '',
                        verification: existingVerification || ''
                    };
                });
                setGoals(initialGoals);
            }, [selectedMonth, selectedYear, configData]);

            const handleGoalChange = (office, goalType, value) => {
                setGoals(prev => prev.map(g => g.office === office ? { ...g, [goalType]: value } : g));
            };

            const handleSave = async () => {
                setLoading(true);
                setSuccess('');
                try {
                    const departments = {
                        collection: 'AR Department',
                        production: 'Outbound Department',
                        appointment: 'Outbound Department',
                        call: 'Outbound Department',
                        verification: 'Verification Department'
                    };

                    const goalTypes = {
                        collection: 'Collection',
                        production: 'Production',
                        appointment: 'Appointment',
                        call: 'Call',
                        verification: 'Verification'
                    };

                    const allRows = [];
                    const now = new Date().toLocaleDateString();
            
                    for (const goal of goals) {
                        for (const [key, value] of Object.entries(goal)) {
                            if (key !== 'office' && value && parseFloat(value) > 0) {
                                const rowData = ['', departments[key], goal.office, '', goalTypes[key], parseFloat(value), selectedMonth, selectedYear, now];
                                allRows.push(rowData);
                            }
                        }
                    }

                    if (allRows.length > 0) {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'append',
                            values: allRows 
                        })
                    });
                    
                    // Wait for write to complete
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }

                    setSuccess('Goals saved successfully!');
                    setTimeout(() => { onClose(); }, 1500);
                } catch (error) {
                    console.error('Error saving goals:', error);
                    alert('Failed to save goals: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-blue-500 to-cyan-600 p-3 rounded-xl"><span className="text-2xl">üìä</span></div>
                                <h2 className="text-2xl font-bold text-white">Goal Management</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="flex gap-4 mb-6">
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Month</label>
                                <select value={selectedMonth} onChange={(e) => setSelectedMonth(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                        <option key={m} value={m}>{new Date(2000, m-1).toLocaleString('default', { month: 'long' })}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Year</label>
                                <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {[2024, 2025, 2026].map(y => (<option key={y} value={y}>{y}</option>))}
                                </select>
                            </div>
                        </div>

                        {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-600">
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Office</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Collection</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Production</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Appointment</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Call</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Verification</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {goals.map(goal => (
                                        <tr key={goal.office} className="border-b border-slate-700 hover:bg-slate-700/30">
                                            <td className="py-3 px-4 text-white font-medium">{goal.office}</td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.collection} onChange={(e) => handleGoalChange(goal.office, 'collection', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.production} onChange={(e) => handleGoalChange(goal.office, 'production', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.appointment} onChange={(e) => handleGoalChange(goal.office, 'appointment', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.call} onChange={(e) => handleGoalChange(goal.office, 'call', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.verification} onChange={(e) => handleGoalChange(goal.office, 'verification', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                            <button onClick={handleSave} disabled={loading} className="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Saving...' : 'Save Goals'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const EmployeeAssignment = ({ onClose, configData }) => {
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [assignments, setAssignments] = useState([]);
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            useEffect(() => {
                const initialAssignments = configData.employeeCodes.map(empCode => {
                    const existingAssignments = getEmployeeAssignments(configData.employees, empCode, selectedMonth, selectedYear);
                    const latest = existingAssignments[0];
                    
                    // Get all offices for this employee
                    const offices = existingAssignments
                        .filter(a => a.office)
                        .map(a => a.office)
                        .filter((office, index, self) => self.indexOf(office) === index); // unique offices
                    
                    return {
                        employeeCode: empCode,
                        department: latest?.department || '',
                        offices: offices.length > 0 ? offices : [],
                        state: latest?.state || ''
                    };
                });
                setAssignments(initialAssignments);
            }, [selectedMonth, selectedYear, configData]);

            const handleAssignmentChange = (empCode, field, value) => {
                setAssignments(prev => prev.map(a => 
                    a.employeeCode === empCode ? { ...a, [field]: value } : a
                ));
            };

            const handleAddOffice = (empCode, office) => {
                if (!office) return;
                setAssignments(prev => prev.map(a => {
                    if (a.employeeCode === empCode && !a.offices.includes(office)) {
                        return { ...a, offices: [...a.offices, office] };
                    }
                    return a;
                }));
            };

            const handleRemoveOffice = (empCode, office) => {
                setAssignments(prev => prev.map(a => {
                    if (a.employeeCode === empCode) {
                        return { ...a, offices: a.offices.filter(o => o !== office) };
                    }
                    return a;
                }));
            };

            const handleSave = async () => {
                setLoading(true);
                setSuccess('');
                try {
                    const allRows = [];
                    const now = new Date().toLocaleDateString();
            
                    for (const assignment of assignments) {
                        if (assignment.department && assignment.offices.length > 0) {
                            // Create one row per office
                            for (const office of assignment.offices) {
                                const rowData = [assignment.employeeCode, assignment.department, office, assignment.state, '', '', selectedMonth, selectedYear, now];
                                allRows.push(rowData);
                            }
                        }
                    }

                    if (allRows.length > 0) {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'append',
                            values: allRows 
                        })
                    });
                    
                    // Wait for write to complete
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }

                    setSuccess('Assignments saved successfully!');
                    setTimeout(() => { onClose(); }, 1500);
                } catch (error) {
                    console.error('Error saving assignments:', error);
                    alert('Failed to save assignments: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-3 rounded-xl"><span className="text-2xl">üë•</span></div>
                                <h2 className="text-2xl font-bold text-white">Employee Assignment</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="flex gap-4 mb-6">
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Month</label>
                                <select value={selectedMonth} onChange={(e) => setSelectedMonth(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                        <option key={m} value={m}>{new Date(2000, m-1).toLocaleString('default', { month: 'long' })}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Year</label>
                                <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    {[2024, 2025, 2026].map(y => (<option key={y} value={y}>{y}</option>))}
                                </select>
                            </div>
                        </div>

                        {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-600">
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Employee</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Department</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Offices</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">State</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {assignments.map(assignment => (
                                        <tr key={assignment.employeeCode} className="border-b border-slate-700 hover:bg-slate-700/30">
                                            <td className="py-3 px-4 text-white font-medium">{assignment.employeeCode}</td>
                                            <td className="py-3 px-4">
                                                <select value={assignment.department} onChange={(e) => handleAssignmentChange(assignment.employeeCode, 'department', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                    <option value="">Select Department</option>
                                                    <option value="AR Department">AR Department</option>
                                                    <option value="Outbound Department">Outbound Department</option>
                                                    <option value="Verification Department">Verification Department</option>
                                                </select>
                                            </td>
                                            <td className="py-3 px-4">
                                                <div className="flex flex-wrap gap-2 mb-2">
                                                    {assignment.offices.map(office => (
                                                        <div key={office} className="office-tag text-white">
                                                            <span>{office}</span>
                                                            <button onClick={() => handleRemoveOffice(assignment.employeeCode, office)} className="text-white hover:text-red-400">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                                <select onChange={(e) => { handleAddOffice(assignment.employeeCode, e.target.value); e.target.value = ''; }} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                    <option value="">+ Add Office</option>
                                                    {configData.offices.filter(o => !assignment.offices.includes(o)).map(office => (
                                                        <option key={office} value={office}>{office}</option>
                                                    ))}
                                                </select>
                                            </td>
                                            <td className="py-3 px-4">
                                                <select value={assignment.state} onChange={(e) => handleAssignmentChange(assignment.employeeCode, 'state', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                    <option value="">Select State</option>
                                                    <option value="Alaska">Alaska</option>
                                                    <option value="Washington">Washington</option>
                                                    <option value="California">California</option>
                                                </select>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                            <button onClick={handleSave} disabled={loading} className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Saving...' : 'Save Assignments'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddEmployee = ({ onClose }) => {
            const [employeeCode, setEmployeeCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            const handleAdd = async () => {
                if (!employeeCode.trim()) {
                alert('Please enter an employee code');
                return;
            }

            setLoading(true);
            setSuccess('');
            try {
                const rowData = [employeeCode.trim().toUpperCase(), '', '', '', '', '', new Date().getMonth() + 1, new Date().getFullYear()];
                await appendToAdminConfig(rowData);
                setSuccess(`Employee ${employeeCode} added successfully!`);
                setEmployeeCode('');
                setTimeout(() => { onClose(); }, 1500);
            } catch (error) {
                console.error('Error adding employee:', error);
                alert('Failed to add employee: ' + error.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="bg-gradient-to-br from-green-500 to-emerald-600 p-3 rounded-xl"><span className="text-2xl">‚ûï</span></div>
                        <h2 className="text-2xl font-bold text-white">Add Employee</h2>
                    </div>

                    {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                    <div className="mb-6">
                        <label className="block text-slate-300 text-sm font-semibold mb-2">Employee Code</label>
                        <input type="text" value={employeeCode} onChange={(e) => setEmployeeCode(e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., JD, AB" autoFocus />
                        <p className="text-slate-400 text-xs mt-2">Enter employee initials (will be auto-capitalized)</p>
                    </div>

                    <div className="flex gap-3">
                        <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                        <button onClick={handleAdd} disabled={loading} className="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                            {loading ? 'Adding...' : 'Add Employee'}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const AddOffice = ({ onClose }) => {
        const [officeCode, setOfficeCode] = useState('');
        const [loading, setLoading] = useState(false);
        const [success, setSuccess] = useState('');

        const handleAdd = async () => {
            if (!officeCode.trim()) {
                alert('Please enter an office code');
                return;
            }

            setLoading(true);
            setSuccess('');
            try {
                const rowData = ['', 'AR Department', officeCode.trim().toUpperCase(), '', 'Collection', 0, new Date().getMonth() + 1, new Date().getFullYear()];
                await appendToAdminConfig(rowData);
                setSuccess(`Office ${officeCode} added successfully!`);
                setOfficeCode('');
                setTimeout(() => { onClose(); }, 1500);
            } catch (error) {
                console.error('Error adding office:', error);
                alert('Failed to add office: ' + error.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="bg-gradient-to-br from-orange-500 to-amber-600 p-3 rounded-xl"><span className="text-2xl">üè¢</span></div>
                        <h2 className="text-2xl font-bold text-white">Add Office</h2>
                    </div>

                    {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                    <div className="mb-6">
                        <label className="block text-slate-300 text-sm font-semibold mb-2">Office Code</label>
                        <input type="text" value={officeCode} onChange={(e) => setOfficeCode(e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="e.g., WA-AR, CA-CH" autoFocus />
                        <p className="text-slate-400 text-xs mt-2">Enter office code (will be auto-capitalized)</p>
                    </div>

                    <div className="flex gap-3">
                        <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                        <button onClick={handleAdd} disabled={loading} className="flex-1 px-4 py-3 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                            {loading ? 'Adding...' : 'Add Office'}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const PerformanceChart = ({ performanceData }) => {
        const chartRef = useRef(null);
        const chartInstance = useRef(null);

        useEffect(() => {
            if (!chartRef.current || !performanceData || performanceData.length === 0) return;
            if (chartInstance.current) chartInstance.current.destroy();

            const ctx = chartRef.current.getContext('2d');
            chartInstance.current = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: performanceData.map(d => d.label),
                    datasets: [{
                        label: 'Performance %',
                        data: performanceData.map(d => d.value),
                        borderColor: 'rgb(34, 211, 238)',
                        backgroundColor: 'rgba(34, 211, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(34, 211, 238)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: '#475569',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: { label: (context) => `Performance: ${context.parsed.y.toFixed(1)}%` }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#94a3b8', callback: (value) => value + '%' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            return () => { if (chartInstance.current) chartInstance.current.destroy(); };
        }, [performanceData]);

        return <div className="h-80"><canvas ref={chartRef}></canvas></div>;
    };

    // PART 3: Main Dashboard Component
        const PerformanceTracker = () => {
            // Admin state
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [showAdminMenu, setShowAdminMenu] = useState(false);
            const [adminView, setAdminView] = useState(null);
            const [configData, setConfigData] = useState({ employees: [], goals: [], offices: [], employeeCodes: [] });
            const [loadingConfig, setLoadingConfig] = useState(false);

            // Dashboard state
            const [data, setData] = useState([]);
            const [insPmtData, setInsPmtData] = useState([]);
            const [productionData, setProductionData] = useState([]);
            const [appointmentData, setAppointmentData] = useState([]);
            const [selectedName, setSelectedName] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [uniqueNames, setUniqueNames] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const fetchDataFromSheet = async () => {
                setLoading(true);
                setError('');
                try {
                    // Load admin config
                    const config = await fetchAdminConfig();
                    setConfigData(config);

                    // Fetch main data sheet
                    const url1 = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Data!A:I?key=${API_KEY}`;
                    const response1 = await fetch(url1);
                    if (!response1.ok) throw new Error(`Failed to fetch Data sheet: ${response1.statusText}`);
                    const result1 = await response1.json();
                    const rows1 = result1.values || [];

                    // Fetch Ins Pmt sheet
                    const url2 = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Ins Pmt!A:G?key=${API_KEY}`;
                    const response2 = await fetch(url2);
                    if (!response2.ok) throw new Error(`Failed to fetch Ins Pmt sheet: ${response2.statusText}`);
                    const result2 = await response2.json();
                    const rows2 = result2.values || [];

                    // Fetch collection sheets
                    const collectionResults = [];
                    for (const sheetName of COLLECTION_SHEETS) {
                        try {
                            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID_2}/values/${sheetName}!A:F?key=${API_KEY}`;
                            const response = await fetch(url);
                            if (response.ok) {
                                const result = await response.json();
                                collectionResults.push({ sheetName, rows: result.values || [] });
                            } else {
                                collectionResults.push({ sheetName, rows: [] });
                            }
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (err) {
                            console.warn(`Failed to fetch ${sheetName}:`, err);
                            collectionResults.push({ sheetName, rows: [] });
                        }
                    }

                    // Fetch production sheets
                    const productionResults = [];
                    for (const sheetName of COLLECTION_SHEETS) {
                        try {
                            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID_3}/values/${sheetName}!A:C?key=${API_KEY}`;
                            const response = await fetch(url);
                            if (response.ok) {
                                const result = await response.json();
                                productionResults.push({ sheetName, rows: result.values || [] });
                            } else {
                                productionResults.push({ sheetName, rows: [] });
                            }
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (err) {
                            console.warn(`Failed to fetch production from ${sheetName}:`, err);
                            productionResults.push({ sheetName, rows: [] });
                        }
                    }

                    // Fetch appointment sheets
                    const appointmentResults = [];
                    for (const sheetName of COLLECTION_SHEETS) {
                        try {
                            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID_3}/values/${sheetName}!A:D?key=${API_KEY}`;
                            const response = await fetch(url);
                            if (response.ok) {
                                const result = await response.json();
                                appointmentResults.push({ sheetName, rows: result.values || [] });
                            } else {
                                appointmentResults.push({ sheetName, rows: [] });
                            }
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (err) {
                            console.warn(`Failed to fetch appointments from ${sheetName}:`, err);
                            appointmentResults.push({ sheetName, rows: [] });
                        }
                    }

                    // Parse main data
                    const parsedData = rows1.slice(1).map(row => ({
                        date: row[0] || '', task: row[3] || '', amount: row[4] || '',
                        collectionAmount: row[5] || '', name: row[8] || '', office: row[2] || '', source: 'Data'
                    })).filter(row => row.name && row.name.trim() && row.task && row.task.trim() && row.date && row.date.trim());

                    // Parse Ins Pmt data
                    const parsedInsPmt = rows2.slice(1).map(row => ({
                        date: row[2] || '', amount: row[4] || '', name: row[6] || '', source: 'InsPmt'
                    })).filter(row => row.name && row.name.trim() && row.date && row.date.trim() && row.amount && row.amount.toString().trim());

                    // Parse collection data
                    const parsedCollectionData = [];
                    collectionResults.forEach(({ sheetName, rows }) => {
                        if (rows.length > 1) {
                            rows.slice(1).forEach(row => {
                                if (row.length >= 6) {
                                    const rawName = row[5] || '';
                                    const cleanName = normalizeEmployeeName(rawName);
                                    const dateValue = row[4] || '';
                                    const amountValue = row[2] || '';
                                    if (cleanName && dateValue && amountValue) {
                                        parsedCollectionData.push({ date: dateValue, amount: amountValue, name: cleanName, source: `Collection-${sheetName}` });
                                    }
                                }
                            });
                        }
                    });

                    // Parse production data
                    const parsedProductionData = [];
                    productionResults.forEach(({ sheetName, rows }) => {
                        if (rows.length > 1) {
                            rows.slice(1).forEach(row => {
                                if (row.length >= 3) {
                                    const rawName = row[2] || '';
                                    const cleanName = normalizeEmployeeName(rawName);
                                    const dateValue = row[0] || '';
                                    const amountValue = row[1] || '';
                                    if (cleanName && dateValue && amountValue) {
                                        parsedProductionData.push({ date: dateValue, amount: amountValue, name: cleanName, office: sheetName, source: `Production-${sheetName}` });
                                    }
                                }
                            });
                        }
                    });

                    // Parse appointment data
                    const parsedAppointmentData = [];
                    appointmentResults.forEach(({ sheetName, rows }) => {
                        if (rows.length > 1) {
                            rows.slice(1).forEach(row => {
                                if (row.length >= 4) {
                                    const rawName = row[2] || '';
                                    const cleanName = normalizeEmployeeName(rawName);
                                    const dateValue = row[0] || '';
                                    const appointmentCount = row[3] || '';
                                    if (cleanName && dateValue && appointmentCount) {
                                        const count = parseNumericValue(appointmentCount);
                                        if (count > 0) {
                                            parsedAppointmentData.push({ date: dateValue, name: cleanName, count: count, office: sheetName, source: `Appointment-${sheetName}` });
                                        }
                                    }
                                }
                            });
                        }
                    });

                    setData(parsedData);
                    const combinedInsPmt = [...parsedInsPmt, ...parsedCollectionData];
                    setInsPmtData(combinedInsPmt);
                    setProductionData(parsedProductionData);
                    setAppointmentData(parsedAppointmentData);

                    // Get unique names from config
                    const names = config.employeeCodes.sort();
                    setUniqueNames(names);

                } catch (err) {
                    console.error('Error fetching data:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchDataFromSheet(); }, []);

            const calculatePerformance = () => {
                if (!selectedName) return null;

                try {
                    const today = new Date();
                    const currentMonth = today.getMonth() + 1;
                    const currentYear = today.getFullYear();

                    // Get employee assignments (can be multiple offices)
                    const assignments = getEmployeeAssignments(configData.employees, selectedName, currentMonth, currentYear);
                    
                    if (assignments.length === 0) {
                        setError(`No assignment found for ${selectedName}`);
                        return null;
                    }

                    const primaryAssignment = assignments[0]; // Use most recent assignment for department/state
                    const assignedOffices = assignments.map(a => a.office).filter(o => o);

                    // Filter data for this employee
                    let filtered = data.filter(row => {
                        const normalized = normalizeEmployeeName(row.name);
                        return normalized === selectedName;
                    });
                    
                    let filteredInsPmt = insPmtData.filter(row => {
                        const normalized = normalizeEmployeeName(row.name);
                        return normalized === selectedName;
                    });

                    // Calculate working days
                    let numberOfDays = 1;
                    if (startDate && endDate) {
                        numberOfDays = Math.max(1, countWorkingDays(new Date(startDate), new Date(endDate)));
                    } else if (startDate || endDate) {
                        numberOfDays = 1;
                    } else {
                        const uniqueDates = new Set();
                        filtered.forEach(row => {
                            const rowDate = parseDate(row.date);
                            if (rowDate) {
                                const shiftedDate = shiftWeekendToWeekday(rowDate);
                                if (shiftedDate) uniqueDates.add(shiftedDate.toDateString());
                            }
                        });
                        filteredInsPmt.forEach(row => {
                            const rowDate = parseDate(row.date);
                            if (rowDate) {
                                const shiftedDate = shiftWeekendToWeekday(rowDate);
                                if (shiftedDate) uniqueDates.add(shiftedDate.toDateString());
                            }
                        });
                        numberOfDays = Math.max(1, uniqueDates.size);
                    }

                    // Apply date filters
                    if (startDate) {
                        const startDateObj = new Date(startDate);
                        filtered = filtered.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate >= startDateObj;
                        });
                        filteredInsPmt = filteredInsPmt.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate >= startDateObj;
                        });
                    }

                    if (endDate) {
                        const endDateObj = new Date(endDate);
                        filtered = filtered.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate <= endDateObj;
                        });
                        filteredInsPmt = filteredInsPmt.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate <= endDateObj;
                        });
                    }

                    const taskCounts = {};
                    const unlistedTasks = {};
                    let totalCollectionAmount = 0;
                    let totalProductionAmount = 0;
                    let totalTasks = 0;
                    let totalCompletedAppointments = 0;
                    let totalAppointments = 0;
                    let totalCalls = 0;
                    
                    const userDepartment = primaryAssignment.department;
                    const userState = primaryAssignment.state;

                    // Process main data sheet tasks
                    filtered.forEach(row => {
                        const taskName = row.task.trim();
                        const taskLower = taskName.toLowerCase();
                        const standardTaskName = findTaskName(taskName);
                        const amountValue = parseNumericValue(row.amount);
                        
                        if (amountValue > 0) {
                            if (standardTaskName) {
                                taskCounts[standardTaskName] = (taskCounts[standardTaskName] || 0) + amountValue;
                                totalTasks += amountValue;
                            } else {
                                unlistedTasks[taskName] = (unlistedTasks[taskName] || 0) + amountValue;
                                totalTasks += amountValue;
                            }
                        }
                        
                        // Outbound Department: Track appointments and calls
                        if (userDepartment === 'Outbound Department') {
                            if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt' || 
                                standardTaskName === 'Inbound Text Appt' || standardTaskName === 'Outbound Text Appt') {
                                totalAppointments += amountValue > 0 ? amountValue : 1;
                            }
                            if (standardTaskName === 'Outbound Call' || standardTaskName === 'Inbound Call') {
                                totalCalls += amountValue > 0 ? amountValue : 1;
                            }
                        }
                        
                        // AR Department: Track collection from collectionAmount column
                        if (userDepartment === 'AR Department' && taskLower === 'total balance collected') {
                            const collectionValue = parseNumericValue(row.collectionAmount);
                            if (collectionValue > 0) {
                                totalCollectionAmount += collectionValue;
                            }
                        }
                    });

                    // Process production data for Outbound Department
                    if (userDepartment === 'Outbound Department') {
                        let filteredProduction = productionData.filter(row => {
                            const normalized = normalizeEmployeeName(row.name);
                            return normalized === selectedName;
                        });
                        
                        if (startDate) {
                            const startDateObj = new Date(startDate);
                            filteredProduction = filteredProduction.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= startDateObj;
                            });
                        }

                        if (endDate) {
                            const endDateObj = new Date(endDate);
                            filteredProduction = filteredProduction.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate <= endDateObj;
                            });
                        }

                        filteredProduction.forEach(row => {
                            const amount = parseNumericValue(row.amount);
                            if (amount > 0) {
                                totalProductionAmount += amount;
                            }
                        });

                        // Process appointment data
                        let filteredAppointments = appointmentData.filter(row => {
                            const normalized = normalizeEmployeeName(row.name);
                            return normalized === selectedName;
                        });

                        if (startDate) {
                            const startDateObj = new Date(startDate);
                            filteredAppointments = filteredAppointments.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= startDateObj;
                            });
                        }

                        if (endDate) {
                            const endDateObj = new Date(endDate);
                            filteredAppointments = filteredAppointments.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate <= endDateObj;
                            });
                        }

                        totalCompletedAppointments = filteredAppointments.reduce((sum, row) => sum + (row.count || 0), 0);
                    }

                    // Add Ins Pmt / Collection sheet amounts to AR total
                    if (userDepartment === 'AR Department') {
                        filteredInsPmt.forEach(row => {
                            const amount = parseNumericValue(row.amount);
                            if (amount > 0) {
                                totalCollectionAmount += amount;
                            }
                        });
                    }

                    // Calculate goals using dynamic config - average across all assigned offices
                    let collectionGoal = 0;
                    let productionGoal = 0;
                    let appointmentGoal = 0;
                    let callGoal = 0;
                    let verificationGoal = 0;

                    if (assignedOffices.length > 0) {
                        assignedOffices.forEach(office => {
                            collectionGoal += getGoalForOffice(configData.goals, userDepartment, office, 'Collection', currentMonth, currentYear);
                            productionGoal += getGoalForOffice(configData.goals, userDepartment, office, 'Production', currentMonth, currentYear);
                            appointmentGoal += getGoalForOffice(configData.goals, userDepartment, office, 'Appointment', currentMonth, currentYear);
                            callGoal += getGoalForOffice(configData.goals, userDepartment, office, 'Call', currentMonth, currentYear);
                            verificationGoal += getGoalForOffice(configData.goals, userDepartment, office, 'Verification', currentMonth, currentYear);
                        });
                        
                        // Average the goals
                        const officeCount = assignedOffices.length;
                        collectionGoal = (collectionGoal / officeCount) * numberOfDays;
                        productionGoal = (productionGoal / officeCount) * numberOfDays;
                        appointmentGoal = (appointmentGoal / officeCount) * numberOfDays;
                        callGoal = (callGoal / officeCount) * numberOfDays;
                        verificationGoal = (verificationGoal / officeCount) * numberOfDays;
                    }

                    // Calculate state totals for percentage calculations
                    let stateCollectionTotal = 0, stateProductionTotal = 0, stateAppointmentTotal = 0, stateVerificationTotal = 0;
                    const stateTaskTotals = {};
                    
                    // Get all employees in same state
                    const employeesInState = configData.employeeCodes.filter(empCode => {
                        const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
                        return empAssignments.length > 0 && empAssignments[0].state === userState;
                    });

                    employeesInState.forEach(empName => {
                        let empFiltered = data.filter(row => {
                            const normalized = normalizeEmployeeName(row.name);
                            return normalized === empName;
                        });
                        let empFilteredInsPmt = insPmtData.filter(row => {
                            const normalized = normalizeEmployeeName(row.name);
                            return normalized === empName;
                        });

                        // Apply date filters to state totals
                        if (startDate) {
                            const startDateObj = new Date(startDate);
                            empFiltered = empFiltered.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= startDateObj;
                            });
                            empFilteredInsPmt = empFilteredInsPmt.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= startDateObj;
                            });
                        }

                        if (endDate) {
                            const endDateObj = new Date(endDate);
                            empFiltered = empFiltered.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate <= endDateObj;
                            });
                            empFilteredInsPmt = empFilteredInsPmt.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate <= endDateObj;
                            });
                        }

                        const empAssignments = getEmployeeAssignments(configData.employees, empName, currentMonth, currentYear);
                        const empDept = empAssignments[0]?.department;
                        
                        // Sum AR collections for state
                        if (empDept === 'AR Department') {
                            empFiltered.forEach(row => {
                                const taskLower = row.task.trim().toLowerCase();
                                if (taskLower === 'total balance collected') {
                                    const amount = parseNumericValue(row.collectionAmount);
                                    if (amount > 0) stateCollectionTotal += amount;
                                }
                            });
                            empFilteredInsPmt.forEach(row => {
                                const amount = parseNumericValue(row.amount);
                                if (amount > 0) stateCollectionTotal += amount;
                            });
                        }

                        // Sum Outbound production and appointments for state
                        if (empDept === 'Outbound Department') {
                            let empFilteredProduction = productionData.filter(row => {
                                const normalized = normalizeEmployeeName(row.name);
                                return normalized === empName;
                            });

                            if (startDate) {
                                const startDateObj = new Date(startDate);
                                empFilteredProduction = empFilteredProduction.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate >= startDateObj;
                                });
                            }

                            if (endDate) {
                                const endDateObj = new Date(endDate);
                                empFilteredProduction = empFilteredProduction.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate <= endDateObj;
                                });
                            }

                            empFilteredProduction.forEach(row => {
                                const amount = parseNumericValue(row.amount);
                                if (amount > 0) stateProductionTotal += amount;
                            });

                            let empFilteredAppointments = appointmentData.filter(row => {
                                const normalized = normalizeEmployeeName(row.name);
                                return normalized === empName;
                            });

                            if (startDate) {
                                const startDateObj = new Date(startDate);
                                empFilteredAppointments = empFilteredAppointments.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate >= startDateObj;
                                });
                            }

                            if (endDate) {
                                const endDateObj = new Date(endDate);
                                empFilteredAppointments = empFilteredAppointments.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate <= endDateObj;
                                });
                            }

                            stateAppointmentTotal += empFilteredAppointments.reduce((sum, row) => sum + (row.count || 0), 0);
                        }

                        // Sum Verification counts for state
                        if (empDept === 'Verification Department') {
                            empFiltered.forEach(row => {
                                const standardTaskName = findTaskName(row.task.trim());
                                if (standardTaskName === 'Verification' || 
                                    standardTaskName === 'Verification (M)' || 
                                    standardTaskName === 'Verification (P)') {
                                    const amountValue = parseNumericValue(row.amount);
                                    if (amountValue > 0) {
                                        stateVerificationTotal += amountValue;
                                    }
                                }
                            });
                        }

                        // Sum all task counts for state percentages
                        empFiltered.forEach(row => {
                            const standardTaskName = findTaskName(row.task.trim());
                            if (standardTaskName) {
                                const amountValue = parseNumericValue(row.amount);
                                if (amountValue > 0) {
                                    stateTaskTotals[standardTaskName] = (stateTaskTotals[standardTaskName] || 0) + amountValue;
                                }
                            }
                        });
                    });

                    // Calculate percentages relative to state
                    const collectionPercentage = stateCollectionTotal > 0 ? (totalCollectionAmount / stateCollectionTotal) * 100 : 0;
                    const productionPercentage = stateProductionTotal > 0 ? (totalProductionAmount / stateProductionTotal) * 100 : 0;
                    const appointmentPercentage = stateAppointmentTotal > 0 ? (totalCompletedAppointments / stateAppointmentTotal) * 100 : 0;
                    const userVerificationCount = (taskCounts['Verification'] || 0) + 
                                  (taskCounts['Verification (M)'] || 0) + 
                                  (taskCounts['Verification (P)'] || 0);
                    const verificationPercentage = stateVerificationTotal > 0 ? (userVerificationCount / stateVerificationTotal) * 100 : 0;

                    const taskPercentages = {};
                    Object.keys(taskCounts).forEach(taskName => {
                        const stateTotal = stateTaskTotals[taskName] || 0;
                        taskPercentages[taskName] = stateTotal > 0 ? (taskCounts[taskName] / stateTotal) * 100 : 0;
                    });

                    const sortedTasks = Object.entries(taskCounts).sort((a, b) => b[1] - a[1]);
                    const sortedUnlistedTasks = Object.entries(unlistedTasks).sort((a, b) => b[1] - a[1]);

                    // Calculate overall performance based on department
                    let overallPerformance = 0;
                    if (userDepartment === 'Outbound Department') {
                        const appointmentPerf = appointmentGoal > 0 ? (totalAppointments / appointmentGoal) * 100 : 0;
                        const callPerf = callGoal > 0 ? (totalCalls / callGoal) * 100 : 0;
                        const productionPerf = productionGoal > 0 ? (totalProductionAmount / productionGoal) * 100 : 0;
                        overallPerformance = Math.min(100, ((appointmentPerf + callPerf + productionPerf) / 3));
                    } else if (userDepartment === 'AR Department') {
                        const collectionPerf = collectionGoal > 0 ? (totalCollectionAmount / collectionGoal) * 100 : 0;
                        overallPerformance = Math.min(100, collectionPerf);
                    } else if (userDepartment === 'Verification Department') {
                        const verificationPerf = verificationGoal > 0 ? (userVerificationCount / verificationGoal) * 100 : 0;
                        overallPerformance = Math.min(100, verificationPerf);
                    }

                    // Performance chart data generation
                    let performanceChartData = [];
                    let dateRangeType = 'daily';

                    if (startDate && endDate) {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

                        if (daysDiff <= 7) {
                            dateRangeType = 'daily';
                            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                                const dayData = filtered.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate.toDateString() === d.toDateString();
                                });

                                let dayPerformance = 0;
                                if (userDepartment === 'Outbound Department') {
                                    let dayAppointments = 0, dayCalls = 0, dayProduction = 0;
                                    dayData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        const amountValue = parseNumericValue(row.amount);
                                        if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt') dayAppointments += amountValue;
                                        if (standardTaskName === 'Outbound Call') dayCalls += amountValue;
                                    });
                                    const dayProductionData = productionData.filter(row => {
                                        const normalized = normalizeEmployeeName(row.name);
                                        const rowDate = parseDate(row.date);
                                        return normalized === selectedName && rowDate && rowDate.toDateString() === d.toDateString();
                                    });
                                    dayProduction = dayProductionData.reduce((sum, row) => sum + parseNumericValue(row.amount), 0);
                                    
                                    const avgAppGoal = appointmentGoal / numberOfDays;
                                    const avgCallGoal = callGoal / numberOfDays;
                                    const avgProdGoal = productionGoal / numberOfDays;
                                    const appointmentPerf = avgAppGoal > 0 ? (dayAppointments / avgAppGoal) * 100 : 0;
                                    const callPerf = avgCallGoal > 0 ? (dayCalls / avgCallGoal) * 100 : 0;
                                    const productionPerf = avgProdGoal > 0 ? (dayProduction / avgProdGoal) * 100 : 0;
                                    dayPerformance = Math.min(100, ((appointmentPerf + callPerf + productionPerf) / 3));
                                } else if (userDepartment === 'AR Department') {
                                    let dayCollection = 0;
                                    dayData.forEach(row => {
                                        const taskLower = row.task.trim().toLowerCase();
                                        if (taskLower === 'total balance collected') {
                                            dayCollection += parseNumericValue(row.collectionAmount);
                                        }
                                    });
                                    const dayInsPmtData = filteredInsPmt.filter(row => {const rowDate = parseDate(row.date);
                                    return rowDate && rowDate.toDateString() === d.toDateString();
                                });
                                dayInsPmtData.forEach(row => {
                                    dayCollection += parseNumericValue(row.amount);
                                });
                                const avgCollGoal = collectionGoal / numberOfDays;
                                dayPerformance = avgCollGoal > 0 ? Math.min(100, (dayCollection / avgCollGoal) * 100) : 0;
                            } else if (userDepartment === 'Verification Department') {
                                let dayVerifications = 0;
                                dayData.forEach(row => {
                                    const standardTaskName = findTaskName(row.task.trim());
                                    if (standardTaskName === 'Verification' || 
                                        standardTaskName === 'Verification (M)' || 
                                        standardTaskName === 'Verification (P)') {
                                        dayVerifications += parseNumericValue(row.amount);
                                    }
                                });
                                const avgVerGoal = verificationGoal / numberOfDays;
                                dayPerformance = avgVerGoal > 0 ? Math.min(100, (dayVerifications / avgVerGoal) * 100) : 0;
                            }
                            performanceChartData.push({ label: `${d.getMonth() + 1}/${d.getDate()}`, value: dayPerformance });
                        }
                    } else if (daysDiff <= 30) {
                        dateRangeType = 'weekly';
                        const weeks = [];
                        let weekStart = new Date(start);
                        weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
                        while (weekStart <= end) {
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekEnd.getDate() + 6);
                            weeks.push({ start: new Date(weekStart), end: new Date(Math.min(weekEnd, end)) });
                            weekStart.setDate(weekStart.getDate() + 7);
                        }
                        weeks.forEach((week, index) => {
                            const weekData = filtered.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= week.start && rowDate <= week.end;
                            });
                            const weekDays = countWorkingDays(week.start, week.end);
                            let weekPerformance = 0;
                            
                            if (userDepartment === 'Outbound Department') {
                                let weekAppointments = 0, weekCalls = 0, weekProduction = 0;
                                weekData.forEach(row => {
                                    const standardTaskName = findTaskName(row.task.trim());
                                    const amountValue = parseNumericValue(row.amount);
                                    if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt') weekAppointments += amountValue;
                                    if (standardTaskName === 'Outbound Call') weekCalls += amountValue;
                                });
                                const weekProductionData = productionData.filter(row => {
                                    const normalized = normalizeEmployeeName(row.name);
                                    const rowDate = parseDate(row.date);
                                    return normalized === selectedName && rowDate && rowDate >= week.start && rowDate <= week.end;
                                });
                                weekProduction = weekProductionData.reduce((sum, row) => sum + parseNumericValue(row.amount), 0);
                                
                                const weekAppGoal = (appointmentGoal / numberOfDays) * weekDays;
                                const weekCallGoal = (callGoal / numberOfDays) * weekDays;
                                const weekProdGoal = (productionGoal / numberOfDays) * weekDays;
                                const appointmentPerf = weekAppGoal > 0 ? (weekAppointments / weekAppGoal) * 100 : 0;
                                const callPerf = weekCallGoal > 0 ? (weekCalls / weekCallGoal) * 100 : 0;
                                const productionPerf = weekProdGoal > 0 ? (weekProduction / weekProdGoal) * 100 : 0;
                                weekPerformance = Math.min(100, ((appointmentPerf + callPerf + productionPerf) / 3));
                            } else if (userDepartment === 'AR Department') {
                                let weekCollection = 0;
                                weekData.forEach(row => {
                                    const taskLower = row.task.trim().toLowerCase();
                                    if (taskLower === 'total balance collected') {
                                        weekCollection += parseNumericValue(row.collectionAmount);
                                    }
                                });
                                const weekInsPmtData = filteredInsPmt.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate >= week.start && rowDate <= week.end;
                                });
                                weekInsPmtData.forEach(row => {
                                    weekCollection += parseNumericValue(row.amount);
                                });
                                const weekCollGoal = (collectionGoal / numberOfDays) * weekDays;
                                weekPerformance = weekCollGoal > 0 ? Math.min(100, (weekCollection / weekCollGoal) * 100) : 0;
                            } else if (userDepartment === 'Verification Department') {
                                let weekVerifications = 0;
                                weekData.forEach(row => {
                                    const standardTaskName = findTaskName(row.task.trim());
                                    if (standardTaskName === 'Verification' || 
                                        standardTaskName === 'Verification (M)' || 
                                        standardTaskName === 'Verification (P)') {
                                        weekVerifications += parseNumericValue(row.amount);
                                    }
                                });
                                const weekVerGoal = (verificationGoal / numberOfDays) * weekDays;
                                weekPerformance = weekVerGoal > 0 ? Math.min(100, (weekVerifications / weekVerGoal) * 100) : 0;
                            }
                            performanceChartData.push({ label: `Week ${index + 1}`, value: weekPerformance });
                        });
                    } else {
                        dateRangeType = 'monthly';
                        const months = [];
                        let monthStart = new Date(start.getFullYear(), start.getMonth(), 1);
                        while (monthStart <= end) {
                            const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
                            months.push({
                                start: new Date(Math.max(monthStart, start)),
                                end: new Date(Math.min(monthEnd, end)),
                                label: monthStart.toLocaleString('default', { month: 'short', year: 'numeric' })
                            });
                            monthStart.setMonth(monthStart.getMonth() + 1);
                        }
                        months.forEach((month) => {
                            const monthData = filtered.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= month.start && rowDate <= month.end;
                            });
                            const monthDays = countWorkingDays(month.start, month.end);
                            let monthPerformance = 0;
                            
                            if (userDepartment === 'Outbound Department') {
                                let monthAppointments = 0, monthCalls = 0, monthProduction = 0;
                                monthData.forEach(row => {
                                    const standardTaskName = findTaskName(row.task.trim());
                                    const amountValue = parseNumericValue(row.amount);
                                    if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt') monthAppointments += amountValue;
                                    if (standardTaskName === 'Outbound Call') monthCalls += amountValue;
                                });
                                const monthProductionData = productionData.filter(row => {
                                    const normalized = normalizeEmployeeName(row.name);
                                    const rowDate = parseDate(row.date);
                                    return normalized === selectedName && rowDate && rowDate >= month.start && rowDate <= month.end;
                                });
                                monthProduction = monthProductionData.reduce((sum, row) => sum + parseNumericValue(row.amount), 0);
                                
                                const monthAppGoal = (appointmentGoal / numberOfDays) * monthDays;
                                const monthCallGoal = (callGoal / numberOfDays) * monthDays;
                                const monthProdGoal = (productionGoal / numberOfDays) * monthDays;
                                const appointmentPerf = monthAppGoal > 0 ? (monthAppointments / monthAppGoal) * 100 : 0;
                                const callPerf = monthCallGoal > 0 ? (monthCalls / monthCallGoal) * 100 : 0;
                                const productionPerf = monthProdGoal > 0 ? (monthProduction / monthProdGoal) * 100 : 0;
                                monthPerformance = Math.min(100, ((appointmentPerf + callPerf + productionPerf) / 3));
                            } else if (userDepartment === 'AR Department') {
                                let monthCollection = 0;
                                monthData.forEach(row => {
                                    const taskLower = row.task.trim().toLowerCase();
                                    if (taskLower === 'total balance collected') {
                                        monthCollection += parseNumericValue(row.collectionAmount);
                                    }
                                });
                                const monthInsPmtData = filteredInsPmt.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate >= month.start && rowDate <= month.end;
                                });
                                monthInsPmtData.forEach(row => {
                                    monthCollection += parseNumericValue(row.amount);
                                });
                                const monthCollGoal = (collectionGoal / numberOfDays) * monthDays;
                                monthPerformance = monthCollGoal > 0 ? Math.min(100, (monthCollection / monthCollGoal) * 100) : 0;
                            } else if (userDepartment === 'Verification Department') {
                                let monthVerifications = 0;
                                monthData.forEach(row => {
                                    const standardTaskName = findTaskName(row.task.trim());
                                    if (standardTaskName === 'Verification' || 
                                        standardTaskName === 'Verification (M)' || 
                                        standardTaskName === 'Verification (P)') {
                                        monthVerifications += parseNumericValue(row.amount);
                                    }
                                });
                                const monthVerGoal = (verificationGoal / numberOfDays) * monthDays;
                                monthPerformance = monthVerGoal > 0 ? Math.min(100, (monthVerifications / monthVerGoal) * 100) : 0;
                            }
                            performanceChartData.push({ label: month.label, value: monthPerformance });
                        });
                    }
                }

                return {
                    taskCounts: sortedTasks, 
                    unlistedTasks: sortedUnlistedTasks, 
                    taskPercentages,
                    totalCollectionAmount: totalCollectionAmount.toFixed(2),
                    totalProductionAmount: totalProductionAmount.toFixed(2),
                    collectionPercentage: collectionPercentage.toFixed(1),
                    productionPercentage: productionPercentage.toFixed(1),
                    appointmentPercentage: appointmentPercentage.toFixed(1),
                    verificationPercentage: verificationPercentage.toFixed(1),
                    overallPerformance: Math.round(overallPerformance),
                    totalTasks: Math.round(totalTasks), 
                    department: userDepartment, 
                    state: userState,
                    offices: assignedOffices,
                    totalAppointments, 
                    totalCalls, 
                    totalCompletedAppointments, 
                    numberOfDays,
                    appointmentGoal: appointmentGoal,
                    callGoal: callGoal,
                    collectionGoal: collectionGoal,
                    productionGoal: productionGoal,
                    verificationCount: userVerificationCount,
                    verificationGoal: verificationGoal,
                    performanceChartData, 
                    dateRangeType
                };
            } catch (error) {
                console.error('Error in calculatePerformance:', error);
                setError(`Calculation error: ${error.message}`);
                return null;
            }
        };

        const performance = calculatePerformance();
        const perfColor = performance ? getPerformanceColor(performance.overallPerformance) : null;

        // Admin handlers
        const handleAdminClick = () => {
            setShowPasswordModal(true);
        };

        const handlePasswordSuccess = async () => {
            setShowPasswordModal(false);
            setLoadingConfig(true);
            try {
                const data = await fetchAdminConfig();
                setConfigData(data);
                setShowAdminMenu(true);
            } catch (error) {
                alert('Failed to load configuration: ' + error.message);
            } finally {
                setLoadingConfig(false);
            }
        };

        const handleAdminMenuSelect = (option) => {
            setShowAdminMenu(false);
            setAdminView(option);
        };

        const handleCloseAdminView = async () => {
            setAdminView(null);
            setShowAdminMenu(true);
            try {
                const data = await fetchAdminConfig();
                setConfigData(data);
                await fetchDataFromSheet();
            } catch (error) {
                console.error('Failed to refresh config:', error);
            }
        };
    return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-3 rounded-xl shadow-lg shadow-cyan-500/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                        <rect x="4" y="2" width="16" height="20" rx="2"/>
                                        <line x1="8" y1="6" x2="16" y2="6"/>
                                    </svg>
                                </div>
                                <h1 className="text-3xl font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">KPI Dashboard</h1>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 bg-slate-800/80 backdrop-blur px-4 py-3 rounded-xl border border-slate-600 shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                    </svg>
                                    <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-transparent text-white text-sm focus:outline-none" />
                                    <span className="text-slate-400 font-bold">-</span>
                                    <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-transparent text-white text-sm focus:outline-none" />
                                </div>

                                <div className="relative">
                                    <select value={selectedName} onChange={(e) => setSelectedName(e.target.value)} className="bg-slate-800 text-white border border-slate-600 rounded-xl px-4 py-3 pr-10 appearance-none cursor-pointer hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all shadow-lg font-medium" style={{minWidth: '160px'}}>
                                        <option value="">Select User</option>
                                        {uniqueNames.map(name => <option key={name} value={name}>{name}</option>)}
                                    </select>
                                    <svg className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>

                                <button onClick={fetchDataFromSheet} disabled={loading} className="flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all shadow-lg shadow-cyan-500/30 font-semibold">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                    </svg>
                                    {loading ? 'Refreshing...' : 'Refresh'}
                                </button>

                                <button onClick={handleAdminClick} className="flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white rounded-xl transition-all shadow-lg shadow-amber-500/30 font-semibold">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243m16.97-1.414l-6-6m-6-6l-6 6"/>
                                    </svg>
                                    Admin
                                </button>
                            </div>
                        </div>

                        {error && <div className="mb-6 p-4 bg-red-900/50 border border-red-700 rounded-xl text-red-200 text-sm shadow-lg">{error}</div>}

                        {loading && (
                            <div className="text-center py-20">
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 inline-block shadow-2xl">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                                    <p className="text-slate-300 text-lg">Loading data...</p>
                                </div>
                            </div>
                        )}

                        {!loading && performance && selectedName && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-cyan-900/20 rounded-2xl p-6 border border-cyan-500/30 hover:border-cyan-400 hover:shadow-2xl hover:shadow-cyan-500/20 transition-all relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 w-40 h-40 bg-cyan-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-2.5 rounded-lg shadow-lg shadow-cyan-500/50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"/>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                                    </svg>
                                                </div>
                                                <h3 className="text-cyan-200 text-sm font-semibold">
                                                    {performance.department === 'AR Department' ? 'Total Collection' : performance.department === 'Outbound Department' ? 'Total Production' : 'Total Verifications'}
                                                </h3>
                                            </div>
                                            <p className="text-white text-3xl font-bold mb-2">
                                                {performance.department === 'AR Department' ? `$${parseFloat(performance.totalCollectionAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : performance.department === 'Outbound Department' ? `$${parseFloat(performance.totalProductionAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : performance.verificationCount}
                                            </p>
                                            <div className="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                                                    <polyline points="17 6 23 6 23 12"/>
                                                </svg>
                                                <span className="text-cyan-300 text-sm font-bold">
                                                    {performance.department === 'AR Department' ? `${performance.collectionPercentage}%` : performance.department === 'Outbound Department' ? `${performance.productionPercentage}%` : `${performance.verificationPercentage}%`} of state
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-purple-900/20 rounded-2xl p-6 border border-purple-500/30 hover:border-purple-400 hover:shadow-2xl hover:shadow-purple-500/20 transition-all relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 w-40 h-40 bg-purple-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-2.5 rounded-lg shadow-lg shadow-purple-500/50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                                    </svg>
                                                </div>
                                                <h3 className="text-purple-200 text-sm font-semibold">
                                                    {performance.department === 'AR Department' ? 'Collection Goal' : performance.department === 'Outbound Department' ? 'Production Goal' : 'Verification Goal'}
                                                </h3>
                                            </div>
                                            <p className="text-white text-3xl font-bold mb-2">
                                                {performance.department === 'AR Department' && performance.collectionGoal ? `$${parseFloat(performance.collectionGoal).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : performance.department === 'Outbound Department' && performance.productionGoal ? `$${parseFloat(performance.productionGoal).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : Math.round(performance.verificationGoal || 0)}
                                            </p>
                                            <p className="text-purple-300 text-sm font-medium">{performance.numberOfDays} working {performance.numberOfDays === 1 ? 'day' : 'days'}</p>
                                        </div>
                                    </div>

                                    {performance.department === 'Outbound Department' && (
                                        <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-amber-900/20 rounded-2xl p-6 border border-amber-500/30 hover:border-amber-400 hover:shadow-2xl hover:shadow-amber-500/20 transition-all relative overflow-hidden group">
                                            <div className="absolute top-0 right-0 w-40 h-40 bg-amber-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                            <div className="relative z-10">
                                                <div className="flex items-center gap-3 mb-4">
                                                    <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-2.5 rounded-lg shadow-lg shadow-amber-500/50">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                                            <polyline points="22 4 12 14.01 9 11.01"/>
                                                        </svg>
                                                    </div>
                                                    <h3 className="text-amber-200 text-sm font-semibold">Completed Appts</h3>
                                                </div>
                                                <p className="text-white text-3xl font-bold mb-2">{performance.totalCompletedAppointments || 0}</p>
                                                <div className="flex items-center gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                                                    </svg>
                                                    <span className="text-amber-300 text-sm font-bold">{performance.appointmentPercentage}% of state</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {perfColor && (
                                        <div className={`bg-gradient-to-br ${perfColor.bg} rounded-2xl p-6 border-2 ${perfColor.border} hover:shadow-2xl transition-all relative overflow-hidden group shadow-xl`}>
                                            <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                            <div className="relative z-10">
                                                <div className="flex items-center gap-3 mb-4">
                                                    <div className="bg-white/20 p-2.5 rounded-lg backdrop-blur">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                            <circle cx="12" cy="12" r="10"/>
                                                            <polyline points="12 6 12 12 16 14"/>
                                                        </svg>
                                                    </div>
                                                    <h3 className="text-white text-sm font-semibold">Overall Performance</h3>
                                                </div>
                                                <p className="text-white text-5xl font-black mb-2 drop-shadow-lg">{performance.overallPerformance}%</p>
                                                <p className="text-white/90 text-sm font-medium">
                                                    {performance.offices.length > 1 ? `${performance.offices.length} Offices: ${performance.offices.join(', ')}` : `Office: ${performance.offices[0] || 'N/A'}`}
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-600 shadow-2xl">
                                        <div className="flex items-center gap-3 mb-6">
                                            <div className="bg-gradient-to-br from-blue-500 to-cyan-600 p-2.5 rounded-lg shadow-lg shadow-blue-500/50">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 className="text-xl font-bold text-white">Performance Over Time</h3>
                                                <p className="text-slate-400 text-sm">
                                                    {performance.dateRangeType === 'daily' ? 'Daily Performance (‚â§7 days)' : performance.dateRangeType === 'weekly' ? 'Weekly Performance (‚â§30 days)' : 'Monthly Performance (>30 days)'}
                                                </p>
                                            </div>
                                        </div>
                                        <PerformanceChart performanceData={performance.performanceChartData} />
                                    </div>

                                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-600 shadow-2xl">
                                        <div className="flex items-center gap-3 mb-6">
                                            <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-2.5 rounded-lg shadow-lg shadow-purple-500/50">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                                </svg>
                                            </div>
                                            <h3 className="text-xl font-bold text-white">Top Tasks</h3>
                                        </div>
                                        <div className="space-y-2 max-h-80 overflow-y-auto custom-scrollbar pr-2">
                                            {performance.taskCounts.map(([taskName, count], index) => (
                                                <div key={taskName} className="bg-slate-700/40 rounded-lg p-3 hover:bg-slate-700/60 transition-all border border-slate-600/50 hover:border-slate-500">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <div className="flex-1 min-w-0">
                                                            <h4 className="text-white font-medium text-sm truncate">{taskName}</h4>
                                                            <div className="flex items-center gap-2 mt-1">
                                                                <span className="text-slate-400 text-xs">{Math.round(count)} tasks</span>
                                                                <span className="text-slate-600">‚Ä¢</span>
                                                                <span className="text-cyan-400 text-xs font-semibold">{performance.taskPercentages[taskName]?.toFixed(1) || 0}% of state</span>
                                                            </div>
                                                        </div>
                                                        <div className="text-right shrink-0">
                                                            <div className="bg-cyan-500/10 px-2 py-1 rounded text-cyan-300 text-xs font-bold">#{index + 1}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}

                                            {performance.unlistedTasks.length > 0 && (
                                                <>
                                                    <div className="pt-3 pb-1">
                                                        <h4 className="text-amber-400 font-semibold text-xs uppercase tracking-wide">Other Tasks</h4>
                                                    </div>
                                                    {performance.unlistedTasks.map(([taskName, count]) => (
                                                        <div key={taskName} className="bg-amber-900/20 rounded-lg p-3 hover:bg-amber-900/30 transition-all border border-amber-700/30">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex-1 pr-4">
                                                                    <h4 className="text-amber-200 font-medium text-sm">{taskName}</h4>
                                                                    <div className="flex items-center gap-2 mt-1">
                                                                        <span className="text-amber-400/70 text-xs">{Math.round(count)} tasks</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </>
                                            )}

                                            {performance.taskCounts.length === 0 && performance.unlistedTasks.length === 0 && (
                                                <div className="text-center py-8 text-slate-400"><p className="text-sm">No tasks found</p></div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {!loading && !selectedName && (
                            <div className="text-center py-20">
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 inline-block shadow-2xl">
                                    <div className="bg-gradient-to-br from-blue-600/30 to-blue-500/20 p-4 rounded-full inline-block mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                    </div>
                                    <p className="text-slate-300 mt-4 text-lg">Select an employee to view performance data</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {showPasswordModal && (
                        <PasswordModal 
                            onClose={() => setShowPasswordModal(false)}
                            onSuccess={handlePasswordSuccess}
                        />
                    )}

                    {showAdminMenu && (
                        <AdminMenu 
                            onClose={() => setShowAdminMenu(false)}
                            onSelectOption={handleAdminMenuSelect}
                        />
                    )}

                    {adminView === 'goals' && (
                        <GoalManagement 
                            onClose={handleCloseAdminView}
                            configData={configData}
                        />
                    )}

                    {adminView === 'employees' && (
                        <EmployeeAssignment 
                            onClose={handleCloseAdminView}
                            configData={configData}
                        />
                    )}

                    {adminView === 'add-employee' && (
                        <AddEmployee onClose={handleCloseAdminView} />
                    )}

                    {adminView === 'add-office' && (
                        <AddOffice onClose={handleCloseAdminView} />
                    )}

                    {loadingConfig && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                            <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 shadow-2xl">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                                <p className="text-slate-300 text-lg">Loading configuration...</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<PerformanceTracker />, document.getElementById('root'));
    </script>
</body>
</html>


