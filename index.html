<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Dashboard - Admin</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgb(51, 65, 85); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgb(100, 116, 139); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgb(148, 163, 184); }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        
        .admin-card {
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // PART 1: API Configuration
        const SHEET_ID = '1asg-4czF_ITFPxvBpyRcjMLjhjl6XGRk0_FLsrQ4D6g';
        const SHEET_ID_2 = '1U0DAPmqFTSI343bls0sj732JsRb7a6E_QLwNLSqAklw';
        const SHEET_ID_3 = '1kPorRymNrDSzUXkCwliBWOllBvAILQDWtvrtdyZBTuo';
        const API_KEY = 'AIzaSyAeiFMlkhhDjEahdKksbS6HomSCbO9iQ50';
        const ADMIN_PASSWORD = 'admin123'; // Change this password

        const COLLECTION_SHEETS = [
            'CA-CH', 'CA-WC', 'CA-QH', 'CA-TS', 'CA-SPD',
            'WA-AR', 'WA-LW', 'WA-AL', 'WA-SS', 'WA-BD',
            'WA-BR', 'WA-NP', 'WA-FW', 'WA-WD', 'WA-FD',
            'WA-SM', 'WA-BL', 'WA-SP', 'WA-SH', 'WA-PY', 'WA-FF',
            'WA-TM', 'WA-UP', 'WA-DP', 'WA-AD', 'WA-WO-FD', 'WA-WO-BD', 'AK'
        ];

        // PART 2: Task Mapping
        const tasksList = [
            'Aging- Closed Denied Claims', 'Aging- Closed Paid Claims', 'Aging- Resubmit Claims',
            'Aging- Review Claims', 'Aging- Voided Claims', 'Allocation Correction Log',
            'Appointment Chart Update', 'Bank Tracker', 'Batching Claims', 'Batching Statement',
            'Billing- Inbound Call', 'Billing- Outbound Call', 'Call Listening', 'Claims Attachments',
            'Claims Not Sent', 'Compliance', 'Credentialing', 'Daily KPI Reports', 'Doctor Payroll',
            'Entering EOBs', 'Entering Kleer Payments', 'Entering Payments', 'FA Set-up',
            'Fax Data Cleaning', "Finalizing Pt's Ledger", 'Gateway Closing- CC',
            'Importing Fee Schedule to OD', 'Itemized Receipt', 'Kleer Set-up',
            'Korean Scheduled List', 'Korean Translation', 'Ledger Allocation', 'Medicaid Report',
            'Outstanding Claims Report', 'Processing CC Payments', 'Procedure Not Billed (Sent/Batched)',
            'Procedure not Billed Report', 'Receiving Pre-Determination (PA)',
            'Receiving Service Authorization (SA)', 'Reconciliation', 'Records Release',
            'Rejected Claims Resubmission', 'Retrieving EOBs/eChecks', 'Retrieving Fee Schedule',
            'Sending Appeal/MJ', 'Sending Medicaid Claims', 'Sending Private Claims',
            'Sending Pre-Determination (PA)', 'Sending Service Authorization (SA)',
            'Sending Statements', 'Sending to Collection Agency', 'Sorting of Korean Accounts',
            'Submitting Denied/Refund Letters', 'Void/Adjustment Request', 'WA Marketing Report',
            '20MIN Confirmation Call', '24HR Confirmation Call', '48HR Confirmation Call',
            'GA', 'Inbound Appt', 'Inbound Call', 'Inbound Text Appt', 'Inbound Text',
            'Labslip', 'Outbound Appt', 'Outbound Call', 'Outbound Text Appt', 'Outbound Text',
            'Patient Paperworks', 'Travel PA', 'Treatment Call', 'Scheduling VA Patients',
            'Checking VA Portal Status', 'Processing ADA & RFS Forms', 'Calling VA Facilities/Patients',
            'Submitting ADA/RFS/XRAYS/Implant Form', 'Handling VA-related Tasks',
            'Verification (M)', 'Verification (P)', 'Verification Tracker Update',
            'Email/Teams Checked', 'Meeting', 'Miscellaneous Tasks', 'Training', 'VM Set up',
            'Gathering Dental Info', 'Gathering Insurance Info', 'Verification',
            'Clinic Closing Report', 'Kakao Lab Monitoring', 'Coding'
        ];

        const taskMapping = {
            'aging- closed denied claims': 'Outstanding Claims',
            'aging- closed paid claims': 'Outstanding Claims',
            'aging- resubmit claims': 'Outstanding Claims',
            'aging- review claims': 'Outstanding Claims',
            'aging- voided claims': 'Outstanding Claims',
            'billing- inbound call': 'Billing Call',
            'billing- outbound call': 'Billing Call',
            'receiving pre-determination (pa)': 'Receiving PA/SA',
            'receiving service authorization (sa)': 'Receiving PA/SA',
            'sending medicaid claims': 'Sending Claims',
            'sending private claims': 'Sending Claims',
            'verification (m)': 'Verification (M)',
            'verification (p)': 'Verification (P)'
        };

        const taskLookup = {};
        tasksList.forEach(taskName => { taskLookup[taskName.toLowerCase().trim()] = taskName; });
        Object.entries(taskMapping).forEach(([original, standard]) => { taskLookup[original] = standard; });

        // PART 2: Helper Functions
        const parseNumericValue = (value) => {
            if (value === null || value === undefined) return 0;
            if (typeof value === 'number') return value;
            const str = value.toString().trim();
            if (str === '' || str === '-') return 0;
            const cleaned = str.replace(/[$,\s]/g, '');
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        };

        const findTaskName = (taskName) => {
            const normalized = taskName.toLowerCase().trim();
            return taskLookup[normalized] || null;
        };

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            let dateOnly = dateStr.toString().trim();
            if (dateOnly.includes(' ')) dateOnly = dateOnly.split(' ')[0];
            if (dateOnly.includes('-')) {
                const parts = dateOnly.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const day = parseInt(parts[2], 10);
                    return new Date(year, month, day, 12, 0, 0, 0);
                }
            }
            if (dateOnly.includes('/')) {
                const parts = dateOnly.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0], 10) - 1;
                    const day = parseInt(parts[1], 10);
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day, 12, 0, 0, 0);
                }
            }
            return null;
        };

        const shiftWeekendToWeekday = (date) => {
            if (!date) return null;
            const dayOfWeek = date.getDay();
            const newDate = new Date(date);
            if (dayOfWeek === 0) newDate.setDate(newDate.getDate() + 1);
            else if (dayOfWeek === 6) newDate.setDate(newDate.getDate() - 1);
            return newDate;
        };

        const countWorkingDays = (startDate, endDate) => {
            if (!startDate || !endDate) return 0;
            let count = 0;
            let current = new Date(startDate);
            while (current <= endDate) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) count++;
                current.setDate(current.getDate() + 1);
            }
            return count;
        };

        const getPerformanceColor = (percentage) => {
            if (percentage >= 90) return { bg: 'from-emerald-500 to-green-400', text: 'text-emerald-300', icon: 'bg-emerald-600/20', border: 'border-emerald-400' };
            if (percentage >= 75) return { bg: 'from-lime-500 to-green-400', text: 'text-lime-300', icon: 'bg-lime-600/20', border: 'border-lime-400' };
            if (percentage >= 60) return { bg: 'from-yellow-500 to-amber-400', text: 'text-yellow-300', icon: 'bg-yellow-600/20', border: 'border-yellow-400' };
            if (percentage >= 40) return { bg: 'from-orange-500 to-yellow-400', text: 'text-orange-300', icon: 'bg-orange-600/20', border: 'border-orange-400' };
            return { bg: 'from-red-500 to-orange-400', text: 'text-red-300', icon: 'bg-red-600/20', border: 'border-red-400' };
        };

        // PART 3: Admin Modal Components
        const PasswordModal = ({ onClose, onSuccess }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === ADMIN_PASSWORD) {
                    onSuccess();
                } else {
                    setError('Incorrect password');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-3 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                            <h2 className="text-2xl font-bold text-white">Admin Access</h2>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="mb-6">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => { setPassword(e.target.value); setError(''); }}
                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-amber-500"
                                    placeholder="Enter admin password"
                                    autoFocus
                                />
                                {error && <p className="text-red-400 text-sm mt-2">{error}</p>}
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 px-4 py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white rounded-xl transition-all font-semibold shadow-lg"
                                >
                                    Enter
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const AdminMenu = ({ onClose, onSelectOption }) => {
            const menuItems = [
                { id: 'goals', title: 'Goal Management', icon: 'üìä', desc: 'Set goals by office and month', color: 'from-blue-500 to-cyan-600' },
                { id: 'employees', title: 'Employee Assignment', icon: 'üë•', desc: 'Assign employees to departments', color: 'from-purple-500 to-pink-600' },
                { id: 'add-employee', title: 'Add Employee', icon: '‚ûï', desc: 'Add new employee codes', color: 'from-green-500 to-emerald-600' },
                { id: 'add-office', title: 'Add Office', icon: 'üè¢', desc: 'Add new office locations', color: 'from-orange-500 to-amber-600' }
            ];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-4xl w-full mx-4">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-3 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243m16.97-1.414l-6-6m-6-6l-6 6"/>
                                    </svg>
                                </div>
                                <h2 className="text-2xl font-bold text-white">Admin Dashboard</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {menuItems.map(item => (
                                <div
                                    key={item.id}
                                    onClick={() => onSelectOption(item.id)}
                                    className="admin-card bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-6 border border-slate-600 hover:border-slate-500 cursor-pointer"
                                >
                                    <div className="flex items-start gap-4">
                                        <div className={`bg-gradient-to-br ${item.color} p-4 rounded-xl text-3xl shadow-lg`}>
                                            {item.icon}
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-xl font-bold text-white mb-2">{item.title}</h3>
                                            <p className="text-slate-400 text-sm">{item.desc}</p>
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-500">
                                            <polyline points="9 18 15 12 9 6"/>
                                        </svg>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // PART 4: Google Sheets API Functions
        const fetchAdminConfig = async () => {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Admin_Config!A:I?key=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch Admin_Config');
                const result = await response.json();
                const rows = result.values || [];
                
                if (rows.length === 0) return { employees: [], goals: [], offices: new Set(), employeeCodes: new Set() };
                
                const headers = rows[0];
                const data = rows.slice(1);
                
                const employees = [];
                const goals = [];
                const offices = new Set();
                const employeeCodes = new Set();
                
                data.forEach(row => {
                    const employeeCode = row[0] || '';
                    const department = row[1] || '';
                    const office = row[2] || '';
                    const state = row[3] || '';
                    const goalType = row[4] || '';
                    const goalValue = row[5] || '';
                    const effectiveMonth = row[6] || '';
                    const effectiveYear = row[7] || '';
                    
                    if (office) offices.add(office);
                    
                    if (employeeCode.trim()) {
                        employeeCodes.add(employeeCode);
                        employees.push({
                            employeeCode,
                            department,
                            office,
                            state,
                            effectiveMonth: parseInt(effectiveMonth) || 0,
                            effectiveYear: parseInt(effectiveYear) || 0
                        });
                    } else if (goalType.trim()) {
                        goals.push({
                            department,
                            office,
                            state,
                            goalType,
                            goalValue: parseFloat(goalValue) || 0,
                            effectiveMonth: parseInt(effectiveMonth) || 0,
                            effectiveYear: parseInt(effectiveYear) || 0
                        });
                    }
                });
                
                return { employees, goals, offices: Array.from(offices).sort(), employeeCodes: Array.from(employeeCodes).sort() };
            } catch (error) {
                console.error('Error fetching admin config:', error);
                throw error;
            }
        };
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwrzZZYDF8U0P7JhDxZ7KSg93Ludykl8yOMMtzWL7ptnEblSKx3cZcp44VOVJf-A7qv/exec'; // Paste the URL from step 2

const appendToAdminConfig = async (rowData) => {
    try {
        const now = new Date().toLocaleDateString();
        const fullRow = [...rowData, now];
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                values: [fullRow]
            })
        });
        
        return { success: true };
    } catch (error) {
        console.error('Error appending to admin config:', error);
        throw error;
    }
};
        
        const getEmployeeAssignment = (employees, employeeCode, month, year) => {
            const applicable = employees.filter(emp => 
                emp.employeeCode === employeeCode &&
                (emp.effectiveYear < year || (emp.effectiveYear === year && emp.effectiveMonth <= month))
            );
            
            if (applicable.length === 0) return null;
            
            applicable.sort((a, b) => {
                if (b.effectiveYear !== a.effectiveYear) return b.effectiveYear - a.effectiveYear;
                return b.effectiveMonth - a.effectiveMonth;
            });
            
            return applicable[0];
        };
        
        const getGoalForOffice = (goals, department, office, goalType, month, year) => {
            const applicable = goals.filter(goal => 
                goal.department === department &&
                goal.office === office &&
                goal.goalType === goalType &&
                (goal.effectiveYear < year || (goal.effectiveYear === year && goal.effectiveMonth <= month))
            );
            
            if (applicable.length === 0) return 0;
            
            applicable.sort((a, b) => {
                if (b.effectiveYear !== a.effectiveYear) return b.effectiveYear - a.effectiveYear;
                return b.effectiveMonth - a.effectiveMonth;
            });
            
            return applicable[0].goalValue || 0;
        };

        // PART 5: Goal Management Component
        const GoalManagement = ({ onClose, configData }) => {
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [goals, setGoals] = useState([]);
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            useEffect(() => {
                const initialGoals = configData.offices.map(office => {
                    const existingCollection = getGoalForOffice(configData.goals, 'AR Department', office, 'Collection', selectedMonth, selectedYear);
                    const existingProduction = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Production', selectedMonth, selectedYear);
                    const existingAppointment = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Appointment', selectedMonth, selectedYear);
                    const existingCall = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Call', selectedMonth, selectedYear);
                    const existingVerification = getGoalForOffice(configData.goals, 'Verification Department', office, 'Verification', selectedMonth, selectedYear);

                    return {
                        office,
                        collection: existingCollection || '',
                        production: existingProduction || '',
                        appointment: existingAppointment || '',
                        call: existingCall || '',
                        verification: existingVerification || ''
                    };
                });
                setGoals(initialGoals);
            }, [selectedMonth, selectedYear, configData]);

            const handleGoalChange = (office, goalType, value) => {
                setGoals(prev => prev.map(g => 
                    g.office === office ? { ...g, [goalType]: value } : g
                ));
            };

            const handleSave = async () => {
                setLoading(true);
                setSuccess('');
                try {
            const departments = {
                collection: 'AR Department',
                production: 'Outbound Department',
                appointment: 'Outbound Department',
                call: 'Outbound Department',
                verification: 'Verification Department'
                };

            const goalTypes = {
                collection: 'Collection',
                production: 'Production',
                appointment: 'Appointment',
                call: 'Call',
                verification: 'Verification'
                };

             // BATCH: Collect all rows first
                const allRows = [];
                const now = new Date().toLocaleDateString();
        
                for (const goal of goals) {
                    for (const [key, value] of Object.entries(goal)) {
                        if (key !== 'office' && value && parseFloat(value) > 0) {
                            const rowData = [
                                '',
                                departments[key],
                                goal.office,
                                '',
                                goalTypes[key],
                                parseFloat(value),
                                selectedMonth,
                                selectedYear,
                                now
                            ];
                            allRows.push(rowData);
                        }
                    }
                }

            // Single batch API call
                if (allRows.length > 0) {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Admin_Config!A:I:append?valueInputOption=RAW&key=${API_KEY}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            values: allRows
                        })
                    });
            
              if (!response.ok) throw new Error('Failed to save goals');
            }

                setSuccess('Goals saved successfully!');
                setTimeout(() => {
                    onClose();
                }, 1500);
            } catch (error) {
                console.error('Error saving goals:', error);
                alert('Failed to save goals: ' + error.message);
            } finally {
                setLoading(false);
            }
        };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-blue-500 to-cyan-600 p-3 rounded-xl">
                                    <span className="text-2xl">üìä</span>
                                </div>
                                <h2 className="text-2xl font-bold text-white">Goal Management</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="flex gap-4 mb-6">
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Month</label>
                                <select value={selectedMonth} onChange={(e) => setSelectedMonth(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                        <option key={m} value={m}>{new Date(2000, m-1).toLocaleString('default', { month: 'long' })}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Year</label>
                                <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {[2024, 2025, 2026].map(y => (
                                        <option key={y} value={y}>{y}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        {success && (
                            <div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">
                                {success}
                            </div>
                        )}

                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-600">
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Office</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Collection</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Production</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Appointment</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Call</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Verification</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {goals.map(goal => (
                                        <tr key={goal.office} className="border-b border-slate-700 hover:bg-slate-700/30">
                                            <td className="py-3 px-4 text-white font-medium">{goal.office}</td>
                                            <td className="py-3 px-4">
                                                <input
                                                    type="number"
                                                    value={goal.collection}
                                                    onChange={(e) => handleGoalChange(goal.office, 'collection', e.target.value)}
                                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    placeholder="0"
                                                />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input
                                                    type="number"
                                                    value={goal.production}
                                                    onChange={(e) => handleGoalChange(goal.office, 'production', e.target.value)}
                                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    placeholder="0"
                                                />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input
                                                    type="number"
                                                    value={goal.appointment}
                                                    onChange={(e) => handleGoalChange(goal.office, 'appointment', e.target.value)}
                                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    placeholder="0"
                                                />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input
                                                    type="number"
                                                    value={goal.call}
                                                    onChange={(e) => handleGoalChange(goal.office, 'call', e.target.value)}
                                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    placeholder="0"
                                                />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input
                                                    type="number"
                                                    value={goal.verification}
                                                    onChange={(e) => handleGoalChange(goal.office, 'verification', e.target.value)}
                                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    placeholder="0"
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">
                                Cancel
                            </button>
                            <button onClick={handleSave} disabled={loading} className="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Saving...' : 'Save Goals'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // PART 6: Employee Assignment Component
        const EmployeeAssignment = ({ onClose, configData }) => {
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [assignments, setAssignments] = useState([]);
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            useEffect(() => {
                const initialAssignments = configData.employeeCodes.map(empCode => {
                    const existing = getEmployeeAssignment(configData.employees, empCode, selectedMonth, selectedYear);
                    return {
                        employeeCode: empCode,
                        department: existing?.department || '',
                        office: existing?.office || '',
                        state: existing?.state || ''
                    };
                });
                setAssignments(initialAssignments);
            }, [selectedMonth, selectedYear, configData]);

            const handleAssignmentChange = (empCode, field, value) => {
                setAssignments(prev => prev.map(a => 
                    a.employeeCode === empCode ? { ...a, [field]: value } : a
                ));
            };

            const handleSave = async () => {
                setLoading(true);
                setSuccess('');
                try {
            // BATCH: Collect all rows first
                const allRows = [];
                const now = new Date().toLocaleDateString();
        
                for (const assignment of assignments) {
                    if (assignment.department && assignment.office) {
                        const rowData = [
                            assignment.employeeCode,
                    assignment.department,
                    assignment.office,
                    assignment.state,
                    '',
                    '',
                    selectedMonth,
                    selectedYear,
                    now
                ];
                allRows.push(rowData);
            }
        }

        // Single batch API call
        if (allRows.length > 0) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Admin_Config!A:I:append?valueInputOption=RAW&key=${API_KEY}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    values: allRows
                })
            });
            
            if (!response.ok) throw new Error('Failed to save assignments');
        }

        setSuccess('Assignments saved successfully!');
        setTimeout(() => {
            onClose();
        }, 1500);
    } catch (error) {
        console.error('Error saving assignments:', error);
        alert('Failed to save assignments: ' + error.message);
    } finally {
        setLoading(false);
    }
};

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-3 rounded-xl">
                                    <span className="text-2xl">üë•</span>
                                </div>
                                <h2 className="text-2xl font-bold text-white">Employee Assignment</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="flex gap-4 mb-6">
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Month</label>
                                <select value={selectedMonth} onChange={(e) => setSelectedMonth(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                        <option key={m} value={m}>{new Date(2000, m-1).toLocaleString('default', { month: 'long' })}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Year</label>
                                <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    {[2024, 2025, 2026].map(y => (
                                        <option key={y} value={y}>{y}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        {success && (
                            <div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">
                                {success}
                            </div>
                        )}

                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-600">
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Employee Code</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Department</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Office</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">State</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {assignments.map(assignment => (
                                        <tr key={assignment.employeeCode} className="border-b border-slate-700 hover:bg-slate-700/30">
                                            <td className="py-3 px-4 text-white font-medium">{assignment.employeeCode}</td>
                                            <td className="py-3 px-4">
                                                <select
                                                    value={assignment.department}
                                                    onChange={(e) => handleAssignmentChange(assignment.employeeCode, 'department', e.target.value)}
                                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                >
                                                    <option value="">Select Department</option>
                                                    <option value="AR Department">AR Department</option>
                                                    <option value="Outbound Department">Outbound Department</option>
                                                    <option value="Verification Department">Verification Department</option>
                                                </select>
                                            </td>
                                            <td className="py-3 px-4">
                                                <select
                                                    value={assignment.office}
                                                    onChange={(e) => handleAssignmentChange(assignment.employeeCode, 'office', e.target.value)}
                                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                >
                                                    <option value="">Select Office</option>
                                                    {configData.offices.map(office => (
                                                        <option key={office} value={office}>{office}</option>
                                                    ))}
                                                </select>
                                            </td>
                                            <td className="py-3 px-4">
                                                <select
                                                    value={assignment.state}
                                                    onChange={(e) => handleAssignmentChange(assignment.employeeCode, 'state', e.target.value)}
                                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                >
                                                    <option value="">Select State</option>
                                                    <option value="Alaska">Alaska</option>
                                                    <option value="Washington">Washington</option>
                                                    <option value="California">California</option>
                                                </select>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">
                                Cancel
                            </button>
                            <button onClick={handleSave} disabled={loading} className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Saving...' : 'Save Assignments'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // PART 7: Add Employee/Office Components
        const AddEmployee = ({ onClose }) => {
            const [employeeCode, setEmployeeCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            const handleAdd = async () => {
                if (!employeeCode.trim()) {
                    alert('Please enter an employee code');
                    return;
                }

                setLoading(true);
                setSuccess('');
                try {
                    const rowData = [
                        employeeCode.trim().toUpperCase(),
                        '',
                        '',
                        '',
                        '',
                        '',
                        new Date().getMonth() + 1,
                        new Date().getFullYear()
                    ];
                    await appendToAdminConfig(rowData);
                    setSuccess(`Employee ${employeeCode} added successfully!`);
                    setEmployeeCode('');
                    setTimeout(() => {
                        onClose();
                    }, 1500);
                } catch (error) {
                    console.error('Error adding employee:', error);
                    alert('Failed to add employee: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="bg-gradient-to-br from-green-500 to-emerald-600 p-3 rounded-xl">
                                <span className="text-2xl">‚ûï</span>
                            </div>
                            <h2 className="text-2xl font-bold text-white">Add Employee</h2>
                        </div>

                        {success && (
                            <div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">
                                {success}
                            </div>
                        )}

                        <div className="mb-6">
                            <label className="block text-slate-300 text-sm font-semibold mb-2">Employee Code</label>
                            <input
                                type="text"
                                value={employeeCode}
                                onChange={(e) => setEmployeeCode(e.target.value)}
                                className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500"
                                placeholder="e.g., JD, AB"
                                autoFocus
                            />
                            <p className="text-slate-400 text-xs mt-2">Enter employee initials (will be auto-capitalized)</p>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">
                                Cancel
                            </button>
                            <button onClick={handleAdd} disabled={loading} className="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Adding...' : 'Add Employee'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddOffice = ({ onClose }) => {
            const [officeCode, setOfficeCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            const handleAdd = async () => {
                if (!officeCode.trim()) {
                    alert('Please enter an office code');
                    return;
                }

                setLoading(true);
                setSuccess('');
                try {
                    const rowData = [
                        '',
                        'AR Department',
                        officeCode.trim().toUpperCase(),
                        '',
                        'Collection',
                        0,
                        new Date().getMonth() + 1,
                        new Date().getFullYear()
                    ];
                    await appendToAdminConfig(rowData);
                    setSuccess(`Office ${officeCode} added successfully!`);
                    setOfficeCode('');
                    setTimeout(() => {
                        onClose();
                    }, 1500);
                } catch (error) {
                    console.error('Error adding office:', error);
                    alert('Failed to add office: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="bg-gradient-to-br from-orange-500 to-amber-600 p-3 rounded-xl">
                                <span className="text-2xl">üè¢</span>
                            </div>
                            <h2 className="text-2xl font-bold text-white">Add Office</h2>
                        </div>

                        {success && (
                            <div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">
                                {success}
                            </div>
                        )}

                        <div className="mb-6">
                            <label className="block text-slate-300 text-sm font-semibold mb-2">Office Code</label>
                            <input
                                type="text"
                                value={officeCode}
                                onChange={(e) => setOfficeCode(e.target.value)}
                                className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                placeholder="e.g., WA-AR, CA-CH"
                                autoFocus
                            />
                            <p className="text-slate-400 text-xs mt-2">Enter office code (will be auto-capitalized)</p>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">
                                Cancel
                            </button>
                            <button onClick={handleAdd} disabled={loading} className="flex-1 px-4 py-3 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Adding...' : 'Add Office'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // PART 8: Performance Chart Component (from original dashboard)
        const PerformanceChart = ({ performanceData }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !performanceData || performanceData.length === 0) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: performanceData.map(d => d.label),
                        datasets: [{
                            label: 'Performance %',
                            data: performanceData.map(d => d.value),
                            borderColor: 'rgb(34, 211, 238)',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgb(34, 211, 238)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#cbd5e1',
                                borderColor: '#475569',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: { label: (context) => `Performance: ${context.parsed.y.toFixed(1)}%` }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { color: '#94a3b8', callback: (value) => value + '%' },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [performanceData]);

            return <div className="h-80"><canvas ref={chartRef}></canvas></div>;
        };

        // PART 9: Main KPI Dashboard (integrated with admin)
        const App = () => {
            // Admin state
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [showAdminMenu, setShowAdminMenu] = useState(false);
            const [adminView, setAdminView] = useState(null);
            const [configData, setConfigData] = useState({ employees: [], goals: [], offices: [], employeeCodes: [] });
            const [loadingConfig, setLoadingConfig] = useState(false);

            // Dashboard state (from original)
            const [data, setData] = useState([]);
            const [uniqueNames, setUniqueNames] = useState([]);
            const [selectedName, setSelectedName] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [performance, setPerformance] = useState(null);

            // Fetch dashboard data on mount
            useEffect(() => {
                fetchDashboardData();
            }, []);

            const fetchDashboardData = async () => {
                setLoading(true);
                setError('');
                try {
                    // Load admin config first
                    const config = await fetchAdminConfig();
                    setConfigData(config);

                    // Load main data sheet
                    const url1 = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Data!A:I?key=${API_KEY}`;
                    const response1 = await fetch(url1);
                    if (!response1.ok) throw new Error('Failed to fetch Data sheet');
                    const result1 = await response1.json();
                    const rows1 = result1.values || [];

                    const parsedData = rows1.slice(1).map(row => ({
                        date: row[0] || '',
                        task: row[3] || '',
                        amount: row[4] || '',
                        collectionAmount: row[5] || '',
                        name: row[8] || ''
                    })).filter(row => row.name && row.task && row.date);

                    setData(parsedData);

                    // Extract unique employee names from config
                    const names = config.employeeCodes.sort();
                    setUniqueNames(names);

                } catch (err) {
                    console.error('Error fetching data:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Calculate performance whenever selection changes
            useEffect(() => {
                if (selectedName && data.length > 0) {
                    calculatePerformance();
                }
            }, [selectedName, startDate, endDate, data, configData]);

            const calculatePerformance = () => {
                if (!selectedName) {
                    setPerformance(null);
                    return;
                }

                try {
                    // Get employee's current assignment
                    const today = new Date();
                    const currentMonth = today.getMonth() + 1;
                    const currentYear = today.getFullYear();
                    
                    const assignment = getEmployeeAssignment(configData.employees, selectedName, currentMonth, currentYear);
                    
                    if (!assignment) {
                        setError(`No assignment found for ${selectedName}`);
                        setPerformance(null);
                        return;
                    }

                    // Filter data for this employee
                    let filtered = data.filter(row => row.name.trim() === selectedName);

                    // Apply date filters
                    if (startDate) {
                        const startDateObj = new Date(startDate);
                        filtered = filtered.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate >= startDateObj;
                        });
                    }

                    if (endDate) {
                        const endDateObj = new Date(endDate);
                        filtered = filtered.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate <= endDateObj;
                        });
                    }

                    // Calculate working days
                    let numberOfDays = 1;
                    if (startDate && endDate) {
                        numberOfDays = Math.max(1, countWorkingDays(new Date(startDate), new Date(endDate)));
                    }

                    // Process tasks and calculate totals
                    const taskCounts = {};
                    let totalCollectionAmount = 0;
                    let totalTasks = 0;

                    filtered.forEach(row => {
                        const taskName = row.task.trim();
                        const standardTaskName = findTaskName(taskName);
                        const amountValue = parseNumericValue(row.amount);

                        if (standardTaskName && amountValue > 0) {
                            taskCounts[standardTaskName] = (taskCounts[standardTaskName] || 0) + amountValue;
                            totalTasks += amountValue;
                        }

                        // AR Department: Track collection
                        if (assignment.department === 'AR Department' && taskName.toLowerCase() === 'total balance collected') {
                            const collectionValue = parseNumericValue(row.collectionAmount);
                            if (collectionValue > 0) {
                                totalCollectionAmount += collectionValue;
                            }
                        }
                    });

                    // Get goals for this employee's office
                    const collectionGoal = getGoalForOffice(configData.goals, assignment.department, assignment.office, 'Collection', currentMonth, currentYear) * numberOfDays;
                    const productionGoal = getGoalForOffice(configData.goals, assignment.department, assignment.office, 'Production', currentMonth, currentYear) * numberOfDays;
                    const appointmentGoal = getGoalForOffice(configData.goals, assignment.department, assignment.office, 'Appointment', currentMonth, currentYear) * numberOfDays;
                    const callGoal = getGoalForOffice(configData.goals, assignment.department, assignment.office, 'Call', currentMonth, currentYear) * numberOfDays;
                    const verificationGoal = getGoalForOffice(configData.goals, assignment.department, assignment.office, 'Verification', currentMonth, currentYear) * numberOfDays;

                    // Calculate overall performance based on department
                    let overallPerformance = 0;
                    if (assignment.department === 'AR Department' && collectionGoal > 0) {
                        overallPerformance = Math.min(100, (totalCollectionAmount / collectionGoal) * 100);
                    }

                    const sortedTasks = Object.entries(taskCounts).sort((a, b) => b[1] - a[1]);
                    const perfColor = getPerformanceColor(overallPerformance);

                    setPerformance({
                        taskCounts: sortedTasks,
                        totalCollectionAmount: totalCollectionAmount.toFixed(2),
                        collectionGoal: collectionGoal.toFixed(2),
                        overallPerformance: Math.round(overallPerformance),
                        totalTasks: Math.round(totalTasks),
                        department: assignment.department,
                        office: assignment.office,
                        state: assignment.state,
                        numberOfDays,
                        perfColor
                    });

                } catch (error) {
                    console.error('Error calculating performance:', error);
                    setError(`Calculation error: ${error.message}`);
                    setPerformance(null);
                }
            };

            // Admin handlers
            const handleAdminClick = () => {
                setShowPasswordModal(true);
            };

            const handlePasswordSuccess = async () => {
                setShowPasswordModal(false);
                setLoadingConfig(true);
                try {
                    const data = await fetchAdminConfig();
                    setConfigData(data);
                    setShowAdminMenu(true);
                } catch (error) {
                    alert('Failed to load configuration: ' + error.message);
                } finally {
                    setLoadingConfig(false);
                }
            };

            const handleAdminMenuSelect = (option) => {
                setShowAdminMenu(false);
                setAdminView(option);
            };

            const handleCloseAdminView = async () => {
                setAdminView(null);
                setShowAdminMenu(true); // Return to admin menu instead of closing
                try {
                    const data = await fetchAdminConfig();
                    setConfigData(data);
                    await fetchDashboardData();
                } catch (error) {
                    console.error('Failed to refresh config:', error);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-3 rounded-xl shadow-lg shadow-cyan-500/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                        <rect x="4" y="2" width="16" height="20" rx="2"/>
                                        <line x1="8" y1="6" x2="16" y2="6"/>
                                    </svg>
                                </div>
                                <h1 className="text-3xl font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">KPI Dashboard</h1>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 bg-slate-800/80 backdrop-blur px-4 py-3 rounded-xl border border-slate-600 shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                    </svg>
                                    <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-transparent text-white text-sm focus:outline-none" />
                                    <span className="text-slate-400 font-bold">-</span>
                                    <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-transparent text-white text-sm focus:outline-none" />
                                </div>

                                <div className="relative">
                                    <select value={selectedName} onChange={(e) => setSelectedName(e.target.value)} className="bg-slate-800 text-white border border-slate-600 rounded-xl px-4 py-3 pr-10 appearance-none cursor-pointer hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all shadow-lg font-medium" style={{minWidth: '160px'}}>
                                        <option value="">Select User</option>
                                        {uniqueNames.map(name => <option key={name} value={name}>{name}</option>)}
                                    </select>
                                    <svg className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>

                                <button onClick={fetchDashboardData} disabled={loading} className="flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all shadow-lg shadow-cyan-500/30 font-semibold">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                    </svg>
                                    {loading ? 'Refreshing...' : 'Refresh'}
                                </button>

                                <button 
                                    onClick={handleAdminClick}
                                    className="flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white rounded-xl transition-all shadow-lg shadow-amber-500/30 font-semibold"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243m16.97-1.414l-6-6m-6-6l-6 6"/>
                                    </svg>
                                    Admin
                                </button>
                            </div>
                        </div>

                        {error && <div className="mb-6 p-4 bg-red-900/50 border border-red-700 rounded-xl text-red-200 text-sm shadow-lg">{error}</div>}

                        {/* Loading State */}
                        {loading && (
                            <div className="text-center py-20">
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 inline-block shadow-2xl">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                                    <p className="text-slate-300 text-lg">Loading data...</p>
                                </div>
                            </div>
                        )}

                        {/* Performance Display */}
                        {!loading && performance && selectedName && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    {/* Collection/Production Card */}
                                    <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-cyan-900/20 rounded-2xl p-6 border border-cyan-500/30 hover:border-cyan-400 hover:shadow-2xl hover:shadow-cyan-500/20 transition-all relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 w-40 h-40 bg-cyan-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-2.5 rounded-lg shadow-lg shadow-cyan-500/50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"/>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                                    </svg>
                                                </div>
                                                <h3 className="text-cyan-200 text-sm font-semibold">
                                                    {performance.department === 'AR Department' ? 'Total Collection' : 'Total Production'}
                                                </h3>
                                            </div>
                                            <p className="text-white text-3xl font-bold mb-2">
                                                ${parseFloat(performance.totalCollectionAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                            </p>
                                            <p className="text-cyan-300 text-sm font-medium">
                                                Goal: ${parseFloat(performance.collectionGoal).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                            </p>
                                        </div>
                                    </div>

                                    {/* Office Card */}
                                    <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-purple-900/20 rounded-2xl p-6 border border-purple-500/30 hover:border-purple-400 hover:shadow-2xl hover:shadow-purple-500/20 transition-all relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 w-40 h-40 bg-purple-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-2.5 rounded-lg shadow-lg shadow-purple-500/50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                                        <polyline points="9 22 9 12 15 12 15 22"/>
                                                    </svg>
                                                </div>
                                                <h3 className="text-purple-200 text-sm font-semibold">Office Location</h3>
                                            </div>
                                            <p className="text-white text-2xl font-bold mb-2">{performance.office}</p>
                                            <p className="text-purple-300 text-sm font-medium">
                                                {performance.department} ‚Ä¢ {performance.state || 'N/A'}
                                            </p>
                                        </div>
                                    </div>

                                    {/* Performance Score Card */}
                                    <div className={`bg-gradient-to-br from-slate-800 via-slate-800 to-emerald-900/20 rounded-2xl p-6 border border-${performance.perfColor.border}/30 hover:border-${performance.perfColor.border} hover:shadow-2xl transition-all relative overflow-hidden group`}>
                                        <div className={`absolute top-0 right-0 w-40 h-40 bg-gradient-to-br ${performance.perfColor.bg} opacity-10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500`}></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className={`bg-gradient-to-br ${performance.perfColor.bg} p-2.5 rounded-lg shadow-lg`}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                                    </svg>
                                                </div>
                                                <h3 className={`${performance.perfColor.text} text-sm font-semibold`}>Overall Performance</h3>
                                            </div>
                                            <p className="text-white text-3xl font-bold mb-2">{performance.overallPerformance}%</p>
                                            <div className="w-full bg-slate-700 rounded-full h-2.5 mb-2">
                                                <div className={`bg-gradient-to-r ${performance.perfColor.bg} h-2.5 rounded-full transition-all duration-500`} style={{width: `${Math.min(100, performance.overallPerformance)}%`}}></div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Working Days Card */}
                                    <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-amber-900/20 rounded-2xl p-6 border border-amber-500/30 hover:border-amber-400 hover:shadow-2xl hover:shadow-amber-500/20 transition-all relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 w-40 h-40 bg-amber-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-2.5 rounded-lg shadow-lg shadow-amber-500/50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                                    </svg>
                                                </div>
                                                <h3 className="text-amber-200 text-sm font-semibold">Working Days</h3>
                                            </div>
                                            <p className="text-white text-3xl font-bold mb-2">{performance.numberOfDays}</p>
                                            <p className="text-amber-300 text-sm font-medium">Total Tasks: {performance.totalTasks}</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Task Breakdown Table */}
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-600 shadow-2xl">
                                    <div className="flex items-center gap-3 mb-6">
                                        <div className="bg-gradient-to-br from-indigo-500 to-purple-600 p-3 rounded-xl shadow-lg shadow-indigo-500/50">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                <line x1="8" y1="6" x2="21" y2="6"/>
                                                <line x1="8" y1="12" x2="21" y2="12"/>
                                                <line x1="8" y1="18" x2="21" y2="18"/>
                                                <line x1="3" y1="6" x2="3.01" y2="6"/>
                                                <line x1="3" y1="12" x2="3.01" y2="12"/>
                                                <line x1="3" y1="18" x2="3.01" y2="18"/>
                                            </svg>
                                        </div>
                                        <h2 className="text-2xl font-bold text-white">Task Breakdown</h2>
                                    </div>
                                    
                                    <div className="overflow-x-auto custom-scrollbar">
                                        <table className="w-full">
                                            <thead>
                                                <tr className="border-b border-slate-600">
                                                    <th className="text-left py-4 px-4 text-slate-300 font-semibold">Rank</th>
                                                    <th className="text-left py-4 px-4 text-slate-300 font-semibold">Task Name</th>
                                                    <th className="text-right py-4 px-4 text-slate-300 font-semibold">Count</th>
                                                    <th className="text-right py-4 px-4 text-slate-300 font-semibold">Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {performance.taskCounts.map(([taskName, count], index) => {
                                                    const percentage = performance.totalTasks > 0 ? (count / performance.totalTasks * 100).toFixed(1) : 0;
                                                    return (
                                                        <tr key={taskName} className="border-b border-slate-700 hover:bg-slate-700/30 transition-colors">
                                                            <td className="py-4 px-4">
                                                                <span className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 text-white text-sm font-bold shadow-lg">
                                                                    {index + 1}
                                                                </span>
                                                            </td>
                                                            <td className="py-4 px-4 text-white font-medium">{taskName}</td>
                                                            <td className="py-4 px-4 text-right text-cyan-300 font-bold text-lg">{Math.round(count)}</td>
                                                            <td className="py-4 px-4 text-right">
                                                                <div className="flex items-center justify-end gap-3">
                                                                    <div className="w-24 bg-slate-700 rounded-full h-2">
                                                                        <div className="bg-gradient-to-r from-cyan-500 to-blue-600 h-2 rounded-full transition-all duration-500" style={{width: `${percentage}%`}}></div>
                                                                    </div>
                                                                    <span className="text-slate-300 font-semibold min-w-[3rem]">{percentage}%</span>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Empty State */}
                        {!loading && !performance && !error && (
                            <div className="text-center py-20">
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 inline-block shadow-2xl">
                                    <div className="bg-gradient-to-br from-slate-700 to-slate-800 p-6 rounded-full inline-block mb-6">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-400">
                                            <circle cx="12" cy="12" r="10"/>
                                            <line x1="12" y1="16" x2="12" y2="12"/>
                                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                                        </svg>
                                    </div>
                                    <h2 className="text-2xl font-bold text-white mb-3">Select an Employee</h2>
                                    <p className="text-slate-400 text-lg">Choose a user from the dropdown to view their performance metrics</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Admin Modals */}
                    {showPasswordModal && (
                        <PasswordModal 
                            onClose={() => setShowPasswordModal(false)}
                            onSuccess={handlePasswordSuccess}
                        />
                    )}

                    {showAdminMenu && (
                        <AdminMenu 
                            onClose={() => setShowAdminMenu(false)}
                            onSelectOption={handleAdminMenuSelect}
                        />
                    )}

                    {adminView === 'goals' && (
                        <GoalManagement 
                            onClose={handleCloseAdminView}
                            configData={configData}
                        />
                    )}

                    {adminView === 'employees' && (
                        <EmployeeAssignment 
                            onClose={handleCloseAdminView}
                            configData={configData}
                        />
                    )}

                    {adminView === 'add-employee' && (
                        <AddEmployee onClose={handleCloseAdminView} />
                    )}

                    {adminView === 'add-office' && (
                        <AddOffice onClose={handleCloseAdminView} />
                    )}

                    {loadingConfig && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                            <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 shadow-2xl">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                                <p className="text-slate-300 text-lg">Loading configuration...</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>



