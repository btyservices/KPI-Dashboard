<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Dashboard - Enhanced</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgb(51, 65, 85); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgb(100, 116, 139); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgb(148, 163, 184); }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        
        .admin-card {
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .office-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgb(51, 65, 85);
            border-radius: 6px;
            font-size: 12px;
            margin: 2px;
        }
        
        .office-tag button {
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgb(71, 85, 105);
        }
        
        .office-tag button:hover {
            background: rgb(239, 68, 68);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // PART 1: API Configuration and Constants
        const SHEET_ID = '1asg-4czF_ITFPxvBpyRcjMLjhjl6XGRk0_FLsrQ4D6g';
        const SHEET_ID_2 = '1U0DAPmqFTSI343bls0sj732JsRb7a6E_QLwNLSqAklw';
        const SHEET_ID_3 = '1kPorRymNrDSzUXkCwliBWOllBvAILQDWtvrtdyZBTuo';
        const API_KEY = 'AIzaSyAeiFMlkhhDjEahdKksbS6HomSCbO9iQ50';
        const ADMIN_PASSWORD = 'admin123';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyCjajsUGm5W64Yv-KF_-J1Ze7DvX7qwSUwe7RIlWqnVG7evrb_aSaU0hXiwOeUr4HK/exec';
        const CONSOLIDATED_API_URL = 'https://script.google.com/macros/s/AKfycbxffVY9J4C3SzswFjmhZd6-KSlFI3HMQUfVbXlHVxick3OT187jXtEhJbmgm4NMJsew/exec';

        const COLLECTION_SHEETS = [
            'CA-CH', 'CA-WC', 'CA-QH', 'CA-TS', 'CA-SPD',
            'WA-AR', 'WA-LW', 'WA-AL', 'WA-SS', 'WA-BD',
            'WA-BR', 'WA-NP', 'WA-FW', 'WA-WD', 'WA-FD',
            'WA-SM', 'WA-BL', 'WA-SP', 'WA-SH', 'WA-PY', 'WA-FF',
            'WA-TM', 'WA-UP', 'WA-DP', 'WA-AD', 'WA-WO-FD', 'WA-WO-BD', 'AK'
        ];

        const tasksList = [
            'Aging- Closed Denied Claims', 'Aging- Closed Paid Claims', 'Aging- Resubmit Claims',
            'Aging- Review Claims', 'Aging- Voided Claims', 'Allocation Correction Log',
            'Appointment Chart Update', 'Bank Tracker', 'Batching Claims', 'Batching Statement',
            'Billing- Inbound Call', 'Billing- Outbound Call', 'Call Listening', 'Claims Attachments',
            'Claims Not Sent', 'Compliance', 'Credentialing', 'Daily KPI Reports', 'Doctor Payroll',
            'Entering EOBs', 'Entering Kleer Payments', 'Entering Payments', 'FA Set-up',
            'Fax Data Cleaning', "Finalizing Pt's Ledger", 'Gateway Closing- CC',
            'Importing Fee Schedule to OD', 'Itemized Receipt', 'Kleer Set-up',
            'Korean Scheduled List', 'Korean Translation', 'Ledger Allocation', 'Medicaid Report',
            'Outstanding Claims Report', 'Processing CC Payments', 'Procedure Not Billed (Sent/Batched)',
            'Procedure not Billed Report', 'Receiving Pre-Determination (PA)',
            'Receiving Service Authorization (SA)', 'Reconciliation', 'Records Release',
            'Rejected Claims Resubmission', 'Retrieving EOBs/eChecks', 'Retrieving Fee Schedule',
            'Sending Appeal/MJ', 'Sending Medicaid Claims', 'Sending Private Claims',
            'Sending Pre-Determination (PA)', 'Sending Service Authorization (SA)',
            'Sending Statements', 'Sending to Collection Agency', 'Sorting of Korean Accounts',
            'Submitting Denied/Refund Letters', 'Void/Adjustment Request', 'WA Marketing Report',
            '20MIN Confirmation Call', '24HR Confirmation Call', '48HR Confirmation Call',
            'GA', 'Inbound Appt', 'Inbound Call', 'Inbound Text Appt', 'Inbound Text',
            'Labslip', 'Outbound Appt', 'Outbound Call', 'Outbound Text Appt', 'Outbound Text',
            'Patient Paperworks', 'Travel PA', 'Treatment Call', 'Scheduling VA Patients',
            'Checking VA Portal Status', 'Processing ADA & RFS Forms', 'Calling VA Facilities/Patients',
            'Submitting ADA/RFS/XRAYS/Implant Form', 'Handling VA-related Tasks',
            'Verification (M)', 'Verification (P)', 'Verification Tracker Update',
            'Email/Teams Checked', 'Meeting', 'Miscellaneous Tasks', 'Training', 'VM Set up',
            'Gathering Dental Info', 'Gathering Insurance Info', 'Verification',
            'Clinic Closing Report', 'Kakao Lab Monitoring', 'Coding'
        ];

        const taskMapping = {
            'aging- closed denied claims': 'Outstanding Claims',
            'aging- closed paid claims': 'Outstanding Claims',
            'aging- resubmit claims': 'Outstanding Claims',
            'aging- review claims': 'Outstanding Claims',
            'aging- voided claims': 'Outstanding Claims',
            'billing- inbound call': 'Billing Call',
            'billing- outbound call': 'Billing Call',
            'receiving pre-determination (pa)': 'Receiving PA/SA',
            'receiving service authorization (sa)': 'Receiving PA/SA',
            'sending medicaid claims': 'Sending Claims',
            'sending private claims': 'Sending Claims',
            'verification (m)': 'Verification (M)',
            'verification (p)': 'Verification (P)'
        };

        const taskLookup = {};
        tasksList.forEach(taskName => { taskLookup[taskName.toLowerCase().trim()] = taskName; });
        Object.entries(taskMapping).forEach(([original, standard]) => { taskLookup[original] = standard; });

        // Employee name normalization
        const employeeNameMapping = {
            'ADIVINAGRACIA': 'AD', 'ADIVINA': 'AD', '**AD': 'AD', 'ABARIOGA': 'AB', '**AB': 'AB',
            'BZARATE': 'BZ', '**BZ': 'BZ', 'GAGBUYA': 'GA', 'ISECONG': 'IS', 'HBAGAPORO': 'HGB',
            'JARREY': 'JA', 'RDELAPAZ': 'RD', 'KMAPAIT': 'KPM', 'GGUJILDE': 'GG', 'JMORTIZ': 'JM',
            'LGUARNES': 'LG', 'LSALAGANTIN': 'LSA', 'JSIMYUNN': 'JS', 'MAUGUSTO': 'MA',
            'MBONGO': 'MB', 'MBACLAYON': 'MCB', 'MSAQUIAN': 'MGS', 'NBOLIVAR': 'NB',
            'PTIPAN': 'PT', 'JMERCADO': 'RM', 'VRUZOL': 'VR', 'SADVINCULA': 'SPA',
            '**GA': 'GA', '**IS': 'IS', '**HGB': 'HGB', '**JA': 'JA', '**RD': 'RD',
            '**KPM': 'KPM', '**GG': 'GG', '**JM': 'JM', '**LG': 'LG', '**LSA': 'LSA',
            '**JS': 'JS', '**MA': 'MA', '**MB': 'MB', '**MCB': 'MCB', '**MGS': 'MGS',
            '**NB': 'NB', '**PT': 'PT', '**RM': 'RM', '**VR': 'VR', '**SPA': 'SPA',
            'CLIGASAN': 'JL', 'GCOLINARES': 'GC', 'CBONOSTRO': 'CB', 'DAULIDA': 'DMA',
            'EMPANGILINAN': 'EMP', 'JCUNANAN': 'JC', 'BMANALO': 'BM', 'PBENITEZ': 'PB',
            'NZAMBRANO': 'NZ', 'VLAGAN': 'VL', 'ISTACRUZ': 'ISC', 'LLAGAN': 'LL',
            'EDORONIO': 'ED', 'LVILLARES': 'LV', 'SSALVEJO': 'SMS', 'CCAPISPISAN': 'CDC',
            'ADAUMAR': 'AMD', 'HALFONSO': 'HMA', 'JOGARIO': 'JP',
            'IMORGADO': 'IM', 'WMEJARES': 'WM', 'RGUAVES': 'RG',
            'CCAPOY': 'CC', 'JINCENZO': 'JI', 'GDELACRUZ': 'GD',
            'CFAJUTAG': 'CF', 'JCBONOSTRO': 'JCB', 'JTLUCING': 'JTL',
            'KREGALADO': 'KR', 'MLCUYOG': 'MLC', 'BDZAPANTA': 'BDZ'
        };

        // Helper Functions
        const parseNumericValue = (value) => {
            if (value === null || value === undefined) return 0;
            if (typeof value === 'number') return value;
            const str = value.toString().trim();
            if (str === '' || str === '-') return 0;
            const cleaned = str.replace(/[$,\s]/g, '');
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        };

        const normalizeEmployeeName = (rawName) => {
            if (!rawName) return null;
            let name = rawName.trim().replace(/^["']|["']$/g, '');
            name = name.replace(/^\d+\.?\d*\s+/, '');
            if (name.includes(' - ')) name = name.split(' - ')[0].trim();
            name = name.replace(/\s+[RP]$/i, '');
            
            const upperName = name.toUpperCase();
            if (employeeNameMapping[upperName]) return employeeNameMapping[upperName];
            
            const noSpaces = upperName.replace(/\s+/g, '');
            if (employeeNameMapping[noSpaces]) return employeeNameMapping[noSpaces];
            
            if (name.length >= 2 && /^[a-z]+$/.test(name)) {
                const possibleInitials = name.substring(0, 2).toUpperCase();
                const match = name.match(/^([a-z])[aeiou]*([a-z])/i);
                if (match) {
                    const initials = (match[1] + match[2]).toUpperCase();
                    return initials;
                }
                return possibleInitials;
            }
            
            return name.toUpperCase();
        };

        const findTaskName = (taskName) => {
            const normalized = taskName.toLowerCase().trim();
            return taskLookup[normalized] || null;
        };

        const parseDate = (dateStr) => {
    if (!dateStr) return null;
    let dateOnly = dateStr.toString().trim();
    if (dateOnly.includes(' ')) dateOnly = dateOnly.split(' ')[0];
    
    if (dateOnly.includes('-')) {
        const parts = dateOnly.split('-');
        if (parts.length === 3) {
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const day = parseInt(parts[2], 10);
            // Use UTC to avoid timezone shifts
            return new Date(Date.UTC(year, month, day, 0, 0, 0, 0));
        }
    }
    if (dateOnly.includes('/')) {
        const parts = dateOnly.split('/');
        if (parts.length === 3) {
            const month = parseInt(parts[0], 10) - 1;
            const day = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            // Use UTC to avoid timezone shifts
            return new Date(Date.UTC(year, month, day, 0, 0, 0, 0));
        }
    }
    return null;
};

        const shiftWeekendToWeekday = (date, workSchedule = 'Mon-Fri') => {
    if (!date) return null;
    const newDate = new Date(date);
    
    // Keep shifting until we find a working day
    let attempts = 0;
    while (!isWorkingDay(newDate, workSchedule) && attempts < 7) {
        newDate.setUTCDate(newDate.getUTCDate() + 1);
        attempts++;
    }
    
    return attempts < 7 ? newDate : date;
};

        const isWorkingDay = (date, workSchedule) => {
    if (!date || !workSchedule) return false;
    
    const dayOfWeek = date.getUTCDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
    
    switch(workSchedule.toLowerCase()) {
        case 'mon-fri':
            return dayOfWeek >= 1 && dayOfWeek <= 5;
        case 'sun-thu':
            return dayOfWeek >= 0 && dayOfWeek <= 4;
        case 'mon-sat':
            return dayOfWeek >= 1 && dayOfWeek <= 6;
        case 'sun-sat':
            return dayOfWeek >= 0 && dayOfWeek <= 6;
        default:
            return dayOfWeek >= 1 && dayOfWeek <= 5;
    }
};

        const detectWorkSchedule = (employeeData, productionData = [], appointmentData = [], employeeName = '') => {
    const daysWorked = new Set();
    
    // Check main data (includes all tasks: AR collections, Outbound calls, Verification tasks, etc.)
    employeeData.forEach(row => {
        const rowDate = parseDate(row.date);
        if (rowDate) {
            daysWorked.add(rowDate.getUTCDay());
        }
    });
    
    // Check production data (Outbound Department)
    productionData.forEach(row => {
        const normalized = normalizeEmployeeName(row.name);
        if (normalized === employeeName) {
            const rowDate = parseDate(row.date);
            if (rowDate) {
                daysWorked.add(rowDate.getUTCDay());
            }
        }
    });
    
    // Check appointment data (Outbound Department)
    appointmentData.forEach(row => {
        const normalized = normalizeEmployeeName(row.name);
        if (normalized === employeeName) {
            const rowDate = parseDate(row.date);
            if (rowDate) {
                daysWorked.add(rowDate.getUTCDay());
            }
        }
    });
    
    const daysArray = Array.from(daysWorked).sort();
    const dayNames = daysArray.map(d => ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][d]);
    console.log(`üìÖ Days worked by ${employeeName}:`, dayNames.join(', '));
    
    // Check if they work on Sunday (day 0)
    if (daysWorked.has(0)) {
        return 'Sun-Thu';
    }
    
    // Check if they work on Friday (day 5)
    if (daysWorked.has(5)) {
        return 'Mon-Fri';
    }
    
    // Default to Mon-Fri if we can't determine
    return 'Mon-Fri';
};

        const countWorkingDays = (startDate, endDate, workSchedule = 'Mon-Fri') => {
    if (!startDate || !endDate) return 0;
    let count = 0;
    let current = new Date(startDate);
    while (current <= endDate) {
        if (isWorkingDay(current, workSchedule)) count++;
        current.setUTCDate(current.getUTCDate() + 1);
    }
    return count;
};

        const getPerformanceColor = (percentage) => {
            if (percentage >= 90) return { bg: 'from-emerald-500 to-green-400', text: 'text-emerald-300', icon: 'bg-emerald-600/20', border: 'border-emerald-400' };
            if (percentage >= 75) return { bg: 'from-lime-500 to-green-400', text: 'text-lime-300', icon: 'bg-lime-600/20', border: 'border-lime-400' };
            if (percentage >= 60) return { bg: 'from-yellow-500 to-amber-400', text: 'text-yellow-300', icon: 'bg-yellow-600/20', border: 'border-yellow-400' };
            if (percentage >= 40) return { bg: 'from-orange-500 to-yellow-400', text: 'text-orange-300', icon: 'bg-orange-600/20', border: 'border-orange-400' };
            return { bg: 'from-red-500 to-orange-400', text: 'text-red-300', icon: 'bg-red-600/20', border: 'border-red-400' };
        };

        // Admin Config Functions
        const fetchAdminConfig = async () => {
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Admin_Config!A:I?key=${API_KEY}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch Admin_Config');
        const result = await response.json();
        const rows = result.values || [];
        
        if (rows.length === 0) return { employees: [], goals: [], offices: new Set(), employeeCodes: new Set() };
        
        const data = rows.slice(1); // Skip header row
        const employees = [];
        const goals = [];
        const offices = new Set();
        const employeeCodes = new Set();
        
        data.forEach(row => {
            const employeeCode = row[0] || '';
            const department = row[1] || '';
            const office = row[2] || '';
            const state = row[3] || '';
            const goalType = row[4] || '';
            const goalValue = row[5] || '';
            const effectiveMonth = row[6] || '';
            const effectiveYear = row[7] || '';
            
            if (office) offices.add(office);
            
            // Add employee code if it exists (regardless of whether it has assignments)
            if (employeeCode.trim()) {
                employeeCodes.add(employeeCode.trim());
            }
            
            // Employee row: has employeeCode, department, office, and state
            if (employeeCode.trim() && department.trim()) {
                employees.push({
                    employeeCode: employeeCode.trim(),
                    department: department.trim(),
                    office: office.trim(),
                    state: state.trim(),
                    effectiveMonth: parseInt(effectiveMonth) || 0,
                    effectiveYear: parseInt(effectiveYear) || 0
                });
            }
            
            // Goal row: has goalType and goalValue
            if (goalType.trim() && goalValue) {
                goals.push({
                    department: department.trim(),
                    office: office.trim(),
                    state: state.trim(),
                    goalType: goalType.trim(),
                    goalValue: parseFloat(goalValue) || 0,
                    effectiveMonth: parseInt(effectiveMonth) || 0,
                    effectiveYear: parseInt(effectiveYear) || 0
                });
            }
        });
        
        console.log('‚úÖ Fetched config:', { 
            employeeCount: employees.length, 
            goalCount: goals.length,
            officeCount: offices.size,
            employeeCodeCount: employeeCodes.size,
            sampleEmployees: employees.slice(0, 5)
        });
        
        return { 
            employees, 
            goals, 
            offices: Array.from(offices).sort(), 
            employeeCodes: Array.from(employeeCodes).sort() 
        };
    } catch (error) {
        console.error('Error fetching admin config:', error);
        throw error;
    }
};

        const appendToAdminConfig = async (rowData) => {
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'append',
                    values: [rowData]
                })
            });
            
            // Wait for write to complete
            await new Promise(resolve => setTimeout(resolve, 1000));
            return { success: true };
        } catch (error) {
            console.error('Error appending to admin config:', error);
            throw error;
        }
    };

        const getEmployeeAssignments = (employees, employeeCode, month, year, exactMatch = false) => {
    let applicable;
    
    if (exactMatch) {
        // Only get assignments for the EXACT month and year
        applicable = employees.filter(emp => 
            emp.employeeCode === employeeCode &&
            emp.effectiveMonth === month &&
            emp.effectiveYear === year
        );
    } else {
        // Get all assignments up to and including this month/year
        applicable = employees.filter(emp => 
            emp.employeeCode === employeeCode &&
            (emp.effectiveYear < year || (emp.effectiveYear === year && emp.effectiveMonth <= month))
        );
    }
    
    console.log(`üîç Looking for ${employeeCode} in ${month}/${year} (exact: ${exactMatch}):`, applicable);
    
    if (applicable.length === 0) return [];
    
    applicable.sort((a, b) => {
        if (b.effectiveYear !== a.effectiveYear) return b.effectiveYear - a.effectiveYear;
        return b.effectiveMonth - a.effectiveMonth;
    });
    
    return applicable;
};

        const getGoalForOffice = (goals, department, office, goalType, month, year) => {
            const applicable = goals.filter(goal => 
                goal.department === department &&
                goal.office === office &&
                goal.goalType === goalType &&
                (goal.effectiveYear < year || (goal.effectiveYear === year && goal.effectiveMonth <= month))
            );
            
            if (applicable.length === 0) return 0;
            
            applicable.sort((a, b) => {
                if (b.effectiveYear !== a.effectiveYear) return b.effectiveYear - a.effectiveYear;
                return b.effectiveMonth - a.effectiveMonth;
            });
            
            return applicable[0].goalValue || 0;
        };

        // Chart Components
        const PerformanceChart = ({ performanceData }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !performanceData || performanceData.length === 0) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: performanceData.map(d => d.label),
                        datasets: [{
                            label: 'Performance %',
                            data: performanceData.map(d => d.value),
                            borderColor: 'rgb(34, 211, 238)',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgb(34, 211, 238)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#cbd5e1',
                                borderColor: '#475569',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: { label: (context) => `Performance: ${context.parsed.y.toFixed(1)}%` }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { color: '#94a3b8', callback: (value) => value + '%' },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [performanceData]);

            return <div className="h-80"><canvas ref={chartRef}></canvas></div>;
        };

        // NEW: Pie Chart Component
        const PieChart = ({ data, title }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !data || data.length === 0) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [{
                            data: data.map(d => d.value),
                            backgroundColor: [
                                'rgba(34, 211, 238, 0.8)',
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(251, 191, 36, 0.8)'
                            ],
                            borderColor: [
                                'rgb(34, 211, 238)',
                                'rgb(168, 85, 247)',
                                'rgb(251, 191, 36)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: '#cbd5e1',
                                    padding: 15,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#cbd5e1',
                                borderColor: '#475569',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: (value, context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return percentage + '%';
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'datalabels',
                        afterDatasetsDraw: (chart) => {
                            const ctx = chart.ctx;
                            chart.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                if (!meta.hidden) {
                                    meta.data.forEach((element, index) => {
                                        const data = dataset.data[index];
                                        const total = dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((data / total) * 100).toFixed(1);
                                        
                                        const {x, y} = element.tooltipPosition();
                                        
                                        ctx.fillStyle = '#fff';
                                        ctx.font = 'bold 14px sans-serif';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.fillText(percentage + '%', x, y);
                                    });
                                }
                            });
                        }
                    }]
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <div className="h-64"><canvas ref={chartRef}></canvas></div>;
        };

        // NEW: Radar Chart Component
        const RadarChart = ({ data, title }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !data || data.length === 0) return;
                if (chartInstance.current) chartInstance.current.destroy();

                // Calculate max value and set a reasonable cap for the scale
                const values = data.map(d => d.value).sort((a, b) => b - a);
                const maxValue = values[0];
                
                // Cap the scale at median * 3 or max/2, whichever gives better visibility
                const median = values[Math.floor(values.length / 2)];
                let suggestedMax = Math.max(median * 3, maxValue * 0.6);
                
                // Round to nice number
                if (suggestedMax > 100) {
                    suggestedMax = Math.ceil(suggestedMax / 100) * 100;
                } else if (suggestedMax > 50) {
                    suggestedMax = Math.ceil(suggestedMax / 50) * 50;
                } else {
                    suggestedMax = Math.ceil(suggestedMax / 10) * 10;
                }
                
                // Ensure max value fits
                if (maxValue > suggestedMax) {
                    suggestedMax = Math.ceil(maxValue * 1.1 / 100) * 100;
                }

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [{
                            label: 'Task Distribution',
                            data: data.map(d => d.value),
                            backgroundColor: 'rgba(34, 211, 238, 0.2)',
                            borderColor: 'rgb(34, 211, 238)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgb(34, 211, 238)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(34, 211, 238)',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: suggestedMax,
                                ticks: { 
                                    color: '#94a3b8',
                                    backdropColor: 'transparent',
                                    stepSize: Math.ceil(suggestedMax / 5),
                                    display: false // Hide the scale numbers
                                },
                                grid: { color: 'rgba(148, 163, 184, 0.2)' },
                                pointLabels: { 
                                    color: '#cbd5e1',
                                    font: { size: 11 }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#cbd5e1',
                                borderColor: '#475569',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: (context) => `${context.label}: ${context.parsed.r.toFixed(0)}`
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'valueLabels',
                        afterDatasetsDraw: (chart) => {
                            const ctx = chart.ctx;
                            const dataset = chart.data.datasets[0];
                            const meta = chart.getDatasetMeta(0);
                            
                            meta.data.forEach((point, index) => {
                                const value = dataset.data[index];
                                
                                ctx.fillStyle = '#fff';
                                ctx.font = 'bold 11px sans-serif';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.strokeStyle = '#1e293b';
                                ctx.lineWidth = 3;
                                
                                // Draw text with outline for better visibility
                                ctx.strokeText(value.toFixed(0), point.x, point.y);
                                ctx.fillText(value.toFixed(0), point.x, point.y);
                            });
                        }
                    }]
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <div className="h-80"><canvas ref={chartRef}></canvas></div>;
        };

        // Admin Modal Components
        const PasswordModal = ({ onClose, onSuccess }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === ADMIN_PASSWORD) {
                    onSuccess();
                } else {
                    setError('Incorrect password');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-3 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                            <h2 className="text-2xl font-bold text-white">Admin Access</h2>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="mb-6">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => { setPassword(e.target.value); setError(''); }}
                                    className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-amber-500"
                                    placeholder="Enter admin password"
                                    autoFocus
                                />
                                {error && <p className="text-red-400 text-sm mt-2">{error}</p>}
                            </div>
                            
                            <div className="flex gap-3">
                                <button type="button" onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">
                                    Cancel
                                </button>
                                <button type="submit" className="flex-1 px-4 py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white rounded-xl transition-all font-semibold shadow-lg">
                                    Enter
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const AdminMenu = ({ onClose, onSelectOption }) => {
            const menuItems = [
                { id: 'goals', title: 'Goal Management', icon: 'üìä', desc: 'Set goals by office and month', color: 'from-blue-500 to-cyan-600' },
                { id: 'employees', title: 'Employee Assignment', icon: 'üë•', desc: 'Assign employees to departments', color: 'from-purple-500 to-pink-600' },
                { id: 'add-employee', title: 'Add Employee', icon: '‚ûï', desc: 'Add new employee codes', color: 'from-green-500 to-emerald-600' },
                { id: 'add-office', title: 'Add Office', icon: 'üè¢', desc: 'Add new office locations', color: 'from-orange-500 to-amber-600' },
                { id: 'delete-employee', title: 'Delete Employee', icon: 'üóëÔ∏è', desc: 'Remove employee and all assignments', color: 'from-red-500 to-rose-600' },
                { id: 'delete-office', title: 'Delete Office', icon: 'üèöÔ∏è', desc: 'Remove office and all data', color: 'from-red-500 to-rose-600' }
            ];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-4xl w-full mx-4">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-3 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243m16.97-1.414l-6-6m-6-6l-6 6"/>
                                    </svg>
                                </div>
                                <h2 className="text-2xl font-bold text-white">Admin Dashboard</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {menuItems.map(item => (
                                <div key={item.id} onClick={() => onSelectOption(item.id)} className="admin-card bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-6 border border-slate-600 hover:border-slate-500 cursor-pointer">
                                    <div className="flex items-start gap-4">
                                        <div className={`bg-gradient-to-br ${item.color} p-4 rounded-xl text-3xl shadow-lg`}>{item.icon}</div>
                                        <div className="flex-1">
                                            <h3 className="text-xl font-bold text-white mb-2">{item.title}</h3>
                                            <p className="text-slate-400 text-sm">{item.desc}</p>
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-500">
                                            <polyline points="9 18 15 12 9 6"/>
                                        </svg>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const DeleteEmployee = ({ onClose, configData, onRefresh }) => {
            const [selectedEmployee, setSelectedEmployee] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            const handleDelete = async () => {
                if (!selectedEmployee) {
                    alert('Please select an employee to delete');
                    return;
                }

                if (!confirm(`Are you sure you want to delete employee "${selectedEmployee}"? This will remove all their assignments and cannot be undone.`)) {
                    return;
                }

                setLoading(true);
                setSuccess('');
                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'delete',
                            criteria: {
                                employeeCode: selectedEmployee
                            }
                        })
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    setSuccess(`Employee ${selectedEmployee} deleted successfully!`);
                    setTimeout(() => { onRefresh(); onClose(); }, 1500);
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    alert('Failed to delete employee: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="bg-gradient-to-br from-red-500 to-rose-600 p-3 rounded-xl"><span className="text-2xl">üóëÔ∏è</span></div>
                            <h2 className="text-2xl font-bold text-white">Delete Employee</h2>
                        </div>

                        {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                        <div className="mb-6">
                            <label className="block text-slate-300 text-sm font-semibold mb-2">Select Employee</label>
                            <select value={selectedEmployee} onChange={(e) => setSelectedEmployee(e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-500" autoFocus>
                                <option value="">Choose employee...</option>
                                {configData.employeeCodes.map(code => (
                                    <option key={code} value={code}>{code}</option>
                                ))}
                            </select>
                            <p className="text-red-400 text-xs mt-2">‚ö†Ô∏è This will permanently delete all assignments for this employee</p>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                            <button onClick={handleDelete} disabled={loading || !selectedEmployee} className="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-500 hover:to-rose-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Deleting...' : 'Delete Employee'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const DeleteOffice = ({ onClose, configData, onRefresh }) => {
            const [selectedOffice, setSelectedOffice] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            const handleDelete = async () => {
                if (!selectedOffice) {
                    alert('Please select an office to delete');
                    return;
                }

                if (!confirm(`Are you sure you want to delete office "${selectedOffice}"? This will remove all goals and assignments for this office and cannot be undone.`)) {
                    return;
                }

                setLoading(true);
                setSuccess('');
                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'delete',
                            criteria: {
                                office: selectedOffice
                            }
                        })
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    setSuccess(`Office ${selectedOffice} deleted successfully!`);
                    setTimeout(() => { onRefresh(); onClose(); }, 1500);
                } catch (error) {
                    console.error('Error deleting office:', error);
                    alert('Failed to delete office: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="bg-gradient-to-br from-red-500 to-rose-600 p-3 rounded-xl"><span className="text-2xl">üóëÔ∏è</span></div>
                            <h2 className="text-2xl font-bold text-white">Delete Office</h2>
                        </div>

                        {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                        <div className="mb-6">
                            <label className="block text-slate-300 text-sm font-semibold mb-2">Select Office</label>
                            <select value={selectedOffice} onChange={(e) => setSelectedOffice(e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-500" autoFocus>
                                <option value="">Choose office...</option>
                                {configData.offices.map(office => (
                                    <option key={office} value={office}>{office}</option>
                                ))}
                            </select>
                            <p className="text-red-400 text-xs mt-2">‚ö†Ô∏è This will permanently delete all goals and assignments for this office</p>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                            <button onClick={handleDelete} disabled={loading || !selectedOffice} className="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-500 hover:to-rose-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Deleting...' : 'Delete Office'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const GoalManagement = ({ onClose, configData }) => {
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [goals, setGoals] = useState([]);
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            useEffect(() => {
                const initialGoals = configData.offices.map(office => {
                    const existingCollection = getGoalForOffice(configData.goals, 'AR Department', office, 'Collection', selectedMonth, selectedYear);
                    const existingProduction = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Production', selectedMonth, selectedYear);
                    const existingAppointment = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Appointment', selectedMonth, selectedYear);
                    const existingCall = getGoalForOffice(configData.goals, 'Outbound Department', office, 'Call', selectedMonth, selectedYear);
                    const existingVerification = getGoalForOffice(configData.goals, 'Verification Department', office, 'Verification', selectedMonth, selectedYear);

                    return {
                        office,
                        collection: existingCollection || '',
                        production: existingProduction || '',
                        appointment: existingAppointment || '',
                        call: existingCall || '',
                        verification: existingVerification || ''
                    };
                });
                setGoals(initialGoals);
            }, [selectedMonth, selectedYear, configData]);

            const handleGoalChange = (office, goalType, value) => {
                setGoals(prev => prev.map(g => g.office === office ? { ...g, [goalType]: value } : g));
            };

            const handleSave = async () => {
    setLoading(true);
    setSuccess('');
    try {
        const departments = {
            collection: 'AR Department',
            production: 'Outbound Department',
            appointment: 'Outbound Department',
            call: 'Outbound Department',
            verification: 'Verification Department'
        };

        const goalTypes = {
            collection: 'Collection',
            production: 'Production',
            appointment: 'Appointment',
            call: 'Call',
            verification: 'Verification'
        };

        let totalDeleted = 0;
        let totalAdded = 0;
        const now = new Date().toLocaleDateString();

        for (const goal of goals) {
            for (const [key, value] of Object.entries(goal)) {
                if (key !== 'office' && value && parseFloat(value) > 0) {
                    // Get the original value from config
                    const originalValue = getGoalForOffice(
                        configData.goals, 
                        departments[key], 
                        goal.office, 
                        goalTypes[key], 
                        selectedMonth, 
                        selectedYear
                    );
                    
                    // Check if value actually changed
                    const hasChanged = parseFloat(value) !== parseFloat(originalValue || 0);
                    
                    // Find existing goals for this exact month/year
                    const existingGoals = configData.goals.filter(g => 
                        g.department === departments[key] &&
                        g.office === goal.office &&
                        g.goalType === goalTypes[key] &&
                        g.effectiveMonth === selectedMonth &&
                        g.effectiveYear === selectedYear
                    );
                    
                    // Only save if changed OR if no goal exists for this month
                    const shouldSave = hasChanged || existingGoals.length === 0;
                    
                    if (shouldSave) {
                        const newRow = [
                            '',
                            departments[key], 
                            goal.office, 
                            '',
                            goalTypes[key], 
                            parseFloat(value), 
                            selectedMonth, 
                            selectedYear, 
                            now
                        ];
                        
                        await fetch(SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                action: 'deleteAndReplace',
                                criteria: {
                                    department: departments[key],
                                    office: goal.office,
                                    goalType: goalTypes[key],
                                    month: selectedMonth,
                                    year: selectedYear
                                },
                                values: [newRow]
                            })
                        });
                        
                        totalDeleted += existingGoals.length;
                        totalAdded += 1;
                        
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                }
            }
        }

        await new Promise(resolve => setTimeout(resolve, 2000));
        
        if (totalAdded > 0) {
            setSuccess(`Successfully updated! Replaced ${totalDeleted} old row(s) with ${totalAdded} new row(s).`);
        } else {
            setSuccess('No changes detected - nothing to save.');
        }

        setTimeout(() => { onClose(); }, 2500);
    } catch (error) {
        console.error('Error saving goals:', error);
        alert('Failed to save goals: ' + error.message);
    } finally {
        setLoading(false);
    }
};

        return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-blue-500 to-cyan-600 p-3 rounded-xl"><span className="text-2xl">üìä</span></div>
                                <h2 className="text-2xl font-bold text-white">Goal Management</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="flex gap-4 mb-6">
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Month</label>
                                <select value={selectedMonth} onChange={(e) => setSelectedMonth(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                        <option key={m} value={m}>{new Date(2000, m-1).toLocaleString('default', { month: 'long' })}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Year</label>
                                <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {[2024, 2025, 2026].map(y => (<option key={y} value={y}>{y}</option>))}
                                </select>
                            </div>
                        </div>

                        {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                        <div className="overflow-x-auto max-h-96 custom-scrollbar">
                            <table className="w-full">
                                <thead className="sticky top-0 bg-slate-800 z-10">
                                    <tr className="border-b border-slate-600">
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Office</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Collection</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Production</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Appointment</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Call</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Verification</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {goals.map(goal => (
                                        <tr key={goal.office} className="border-b border-slate-700 hover:bg-slate-700/30">
                                            <td className="py-3 px-4 text-white font-medium">{goal.office}</td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.collection} onChange={(e) => handleGoalChange(goal.office, 'collection', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.production} onChange={(e) => handleGoalChange(goal.office, 'production', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.appointment} onChange={(e) => handleGoalChange(goal.office, 'appointment', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.call} onChange={(e) => handleGoalChange(goal.office, 'call', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                            <td className="py-3 px-4">
                                                <input type="number" value={goal.verification} onChange={(e) => handleGoalChange(goal.office, 'verification', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                            <button onClick={handleSave} disabled={loading} className="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Saving...' : 'Save Goals'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const EmployeeAssignment = ({ onClose, configData }) => {
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [assignments, setAssignments] = useState([]);
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            useEffect(() => {
    const initialAssignments = configData.employeeCodes.map(empCode => {
        const existingAssignments = getEmployeeAssignments(configData.employees, empCode, selectedMonth, selectedYear, true);
        const latest = existingAssignments[0];
        
        // Get all offices for this employee
        const offices = existingAssignments
            .filter(a => a.office)
            .map(a => a.office)
            .filter((office, index, self) => self.indexOf(office) === index); // unique offices
        
        return {
            employeeCode: empCode,
            department: latest?.department || '',
            offices: offices.length > 0 ? offices : [],
            state: latest?.state || '',
            originalConfig: {
                department: latest?.department || '',
                offices: offices.length > 0 ? offices : [],
                state: latest?.state || ''
            }
        };
    });
    setAssignments(initialAssignments);
}, [selectedMonth, selectedYear, configData]);

            const handleAssignmentChange = (empCode, field, value) => {
                setAssignments(prev => prev.map(a => 
                    a.employeeCode === empCode ? { ...a, [field]: value } : a
                ));
            };

            const handleAddOffice = (empCode, office) => {
                if (!office) return;
                setAssignments(prev => prev.map(a => {
                    if (a.employeeCode === empCode && !a.offices.includes(office)) {
                        return { ...a, offices: [...a.offices, office] };
                    }
                    return a;
                }));
            };

            const handleRemoveOffice = (empCode, office) => {
                setAssignments(prev => prev.map(a => {
                    if (a.employeeCode === empCode) {
                        return { ...a, offices: a.offices.filter(o => o !== office) };
                    }
                    return a;
                }));
            };

    const handleSave = async () => {
    setLoading(true);
    setSuccess('');
    try {
        let totalDeleted = 0;
        let totalAdded = 0;
        
        for (const assignment of assignments) {
            // Skip if no department or no offices selected
            if (!assignment.department || assignment.offices.length === 0) {
                continue;
            }
            
            const hasChanged = 
                assignment.department !== (assignment.originalConfig?.department || '') ||
                assignment.state !== (assignment.originalConfig?.state || '') ||
                assignment.offices.length !== (assignment.originalConfig?.offices || []).length ||
                !assignment.offices.every(office => (assignment.originalConfig?.offices || []).includes(office));
            
            const existingForMonth = getEmployeeAssignments(
                configData.employees, 
                assignment.employeeCode, 
                selectedMonth, 
                selectedYear, 
                true
            );
            
            const shouldSave = hasChanged || existingForMonth.length === 0;
            
            if (shouldSave && assignment.department && assignment.offices.length > 0) {
                const newRows = [];
                for (const office of assignment.offices) {
                    newRows.push([
                        assignment.employeeCode, 
                        assignment.department, 
                        office, 
                        assignment.state, 
                        '', 
                        '', 
                        selectedMonth, 
                        selectedYear, 
                        new Date().toLocaleDateString()
                    ]);
                }
                
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'deleteAndReplace',
                        criteria: {
                            employeeCode: assignment.employeeCode,
                            month: selectedMonth,
                            year: selectedYear
                        },
                        values: newRows
                    })
                });
                
                totalDeleted += existingForMonth.length;
                totalAdded += newRows.length;
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        await new Promise(resolve => setTimeout(resolve, 2000));
        
        if (totalAdded > 0) {
            setSuccess(`Successfully updated! Replaced ${totalDeleted} old row(s) with ${totalAdded} new row(s).`);
        } else {
            setSuccess('No changes detected - nothing to save.');
        }
        
        setTimeout(() => { onClose(); }, 2500);
    } catch (error) {
        console.error('Error saving assignments:', error);
        alert('Failed to save assignments: ' + error.message);
    } finally {
        setLoading(false);
    }
};

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-3 rounded-xl"><span className="text-2xl">üë•</span></div>
                                <h2 className="text-2xl font-bold text-white">Employee Assignment</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>

                        <div className="flex gap-4 mb-6">
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Month</label>
                                <select value={selectedMonth} onChange={(e) => setSelectedMonth(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                        <option key={m} value={m}>{new Date(2000, m-1).toLocaleString('default', { month: 'long' })}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex-1">
                                <label className="block text-slate-300 text-sm font-semibold mb-2">Year</label>
                                <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    {[2024, 2025, 2026].map(y => (<option key={y} value={y}>{y}</option>))}
                                </select>
                            </div>
                        </div>

                        {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-slate-600">
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Employee</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Department</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">Offices</th>
                                        <th className="text-left py-3 px-4 text-slate-300 font-semibold">State</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {assignments.length === 0 ? (
                                        <tr>
                                            <td colSpan="4" className="text-center py-8 text-slate-400">
                                                <p className="text-sm">No employees found. Please add employees first.</p>
                                            </td>
                                        </tr>
                                    ) : (
                                        assignments.map(assignment => (
                                            <tr key={assignment.employeeCode} className="border-b border-slate-700 hover:bg-slate-700/30">
                                            <td className="py-3 px-4 text-white font-medium">{assignment.employeeCode}</td>
                                            <td className="py-3 px-4">
                                                <select value={assignment.department} onChange={(e) => handleAssignmentChange(assignment.employeeCode, 'department', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                    <option value="">Select Department</option>
                                                    <option value="AR Department">AR Department</option>
                                                    <option value="Outbound Department">Outbound Department</option>
                                                    <option value="Verification Department">Verification Department</option>
                                                </select>
                                            </td>
                                            <td className="py-3 px-4">
                                                <div className="flex flex-wrap gap-2 mb-2">
                                                    {assignment.offices.map(office => (
                                                        <div key={office} className="office-tag text-white">
                                                            <span>{office}</span>
                                                            <button onClick={() => handleRemoveOffice(assignment.employeeCode, office)} className="text-white hover:text-red-400">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                                <select onChange={(e) => { handleAddOffice(assignment.employeeCode, e.target.value); e.target.value = ''; }} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                    <option value="">+ Add Office</option>
                                                    {configData.offices.filter(o => !assignment.offices.includes(o)).map(office => (
                                                        <option key={office} value={office}>{office}</option>
                                                    ))}
                                                </select>
                                            </td>
                                            <td className="py-3 px-4">
                                                <select value={assignment.state} onChange={(e) => handleAssignmentChange(assignment.employeeCode, 'state', e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                    <option value="">Select State</option>
                                                    <option value="Alaska">Alaska</option>
                                                    <option value="Washington">Washington</option>
                                                    <option value="California">California</option>
                                                </select>
                                            </td>
                                        </tr>
                                    ))
                                    )}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                            <button onClick={handleSave} disabled={loading} className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                                {loading ? 'Saving...' : 'Save Assignments'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

    const AddEmployee = ({ onClose }) => {
            const [employeeCode, setEmployeeCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            const handleAdd = async () => {
                if (!employeeCode.trim()) {
                alert('Please enter an employee code');
                return;
            }

            setLoading(true);
            setSuccess('');
            try {
                const rowData = [employeeCode.trim().toUpperCase(), '', '', '', '', '', new Date().getMonth() + 1, new Date().getFullYear()];
                await appendToAdminConfig(rowData);
                setSuccess(`Employee ${employeeCode} added successfully!`);
                setEmployeeCode('');
                setTimeout(() => { onClose(); }, 1500);
            } catch (error) {
                console.error('Error adding employee:', error);
                alert('Failed to add employee: ' + error.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="bg-gradient-to-br from-green-500 to-emerald-600 p-3 rounded-xl"><span className="text-2xl">‚ûï</span></div>
                        <h2 className="text-2xl font-bold text-white">Add Employee</h2>
                    </div>

                    {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                    <div className="mb-6">
                        <label className="block text-slate-300 text-sm font-semibold mb-2">Employee Code</label>
                        <input type="text" value={employeeCode} onChange={(e) => setEmployeeCode(e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., JD, AB" autoFocus />
                        <p className="text-slate-400 text-xs mt-2">Enter employee initials (will be auto-capitalized)</p>
                    </div>

                    <div className="flex gap-3">
                        <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                        <button onClick={handleAdd} disabled={loading} className="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                            {loading ? 'Adding...' : 'Add Employee'}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const AddOffice = ({ onClose }) => {
        const [officeCode, setOfficeCode] = useState('');
        const [loading, setLoading] = useState(false);
        const [success, setSuccess] = useState('');

        const handleAdd = async () => {
            if (!officeCode.trim()) {
                alert('Please enter an office code');
                return;
            }

            setLoading(true);
            setSuccess('');
            try {
                const rowData = ['', 'AR Department', officeCode.trim().toUpperCase(), '', 'Collection', 0, new Date().getMonth() + 1, new Date().getFullYear()];
                await appendToAdminConfig(rowData);
                setSuccess(`Office ${officeCode} added successfully!`);
                setOfficeCode('');
                setTimeout(() => { onClose(); }, 1500);
            } catch (error) {
                console.error('Error adding office:', error);
                alert('Failed to add office: ' + error.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600 shadow-2xl max-w-md w-full mx-4">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="bg-gradient-to-br from-orange-500 to-amber-600 p-3 rounded-xl"><span className="text-2xl">üè¢</span></div>
                        <h2 className="text-2xl font-bold text-white">Add Office</h2>
                    </div>

                    {success && (<div className="mb-4 p-4 bg-green-900/50 border border-green-700 rounded-xl text-green-200">{success}</div>)}

                    <div className="mb-6">
                        <label className="block text-slate-300 text-sm font-semibold mb-2">Office Code</label>
                        <input type="text" value={officeCode} onChange={(e) => setOfficeCode(e.target.value)} className="w-full bg-slate-700 text-white border border-slate-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="e.g., WA-AR, CA-CH" autoFocus />
                        <p className="text-slate-400 text-xs mt-2">Enter office code (will be auto-capitalized)</p>
                    </div>

                    <div className="flex gap-3">
                        <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all font-semibold">Cancel</button>
                        <button onClick={handleAdd} disabled={loading} className="flex-1 px-4 py-3 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all font-semibold shadow-lg">
                            {loading ? 'Adding...' : 'Add Office'}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // PART 3: Main Dashboard Component
        const PerformanceTracker = () => {
            // Admin state
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [showAdminMenu, setShowAdminMenu] = useState(false);
            const [adminView, setAdminView] = useState(null);
            const [configData, setConfigData] = useState({ employees: [], goals: [], offices: [], employeeCodes: [] });
            const [loadingConfig, setLoadingConfig] = useState(false);

            // Dashboard state
            const [data, setData] = useState([]);
            const [insPmtData, setInsPmtData] = useState([]);
            const [productionData, setProductionData] = useState([]);
            const [appointmentData, setAppointmentData] = useState([]);
            const [selectedName, setSelectedName] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [uniqueNames, setUniqueNames] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [performance, setPerformance] = useState(null);
            
            // Chart options state
            const [pieChartScope, setPieChartScope] = useState('state'); // 'state' or 'overall'
            const [outboundMetric, setOutboundMetric] = useState('production'); // 'production', 'calls', 'appointments'

            const fetchDataFromSheet = async () => {
    setLoading(true);
    setError('');
    try {
        // Load admin config
        const config = await fetchAdminConfig();
        setConfigData(config);

        // Fetch main data sheet (keep this - it has task data)
        const url1 = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Data!A:I?key=${API_KEY}`;
        const response1 = await fetch(url1);
        if (!response1.ok) throw new Error(`Failed to fetch Data sheet: ${response1.statusText}`);
        const result1 = await response1.json();
        const rows1 = result1.values || [];

        // Fetch Ins Pmt sheet (keep this - it has collection data)
        const url2 = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Ins Pmt!A:G?key=${API_KEY}`;
        const response2 = await fetch(url2);
        if (!response2.ok) throw new Error(`Failed to fetch Ins Pmt sheet: ${response2.statusText}`);
        const result2 = await response2.json();
        const rows2 = result2.values || [];

        // ‚ú® NEW: Use consolidated API for production, appointments, and collections
        console.log('Fetching data from consolidated API...');
        const apiResponse = await fetch(`${CONSOLIDATED_API_URL}?action=getAllData`);
        if (!apiResponse.ok) throw new Error('Failed to fetch from consolidated API');
        const apiData = await apiResponse.json();
        
        console.log('‚úÖ Consolidated API response:', apiData);

        // Parse main data (unchanged)
        const parsedData = rows1.slice(1).map(row => ({
            date: row[0] || '',
            task: row[3] || '',
            amount: row[4] || '',
            collectionAmount: row[5] || '',
            name: row[8] || '',
            office: row[2] || '',
            source: 'Data'
        })).filter(row => row.name && row.name.trim() && row.task && row.task.trim() && row.date && row.date.trim());

        // Parse Ins Pmt data (unchanged)
        const parsedInsPmt = rows2.slice(1).map(row => ({
            date: row[4] || '',
            amount: row[2] || '',
            name: normalizeEmployeeName(row[5] || ''),
            source: 'InsPmt'
        })).filter(row => row.name && row.date && row.date.trim() && row.amount && row.amount.toString().trim());

        // ‚ú® NEW: Parse collections from API
        const parsedCollectionData = (apiData.collections || []).map(item => ({
            date: item.date,
            amount: item.amount,
            name: normalizeEmployeeName(item.name),
            source: `Collection-${item.office}`
        }));

        // ‚ú® NEW: Parse production from API
        const parsedProductionData = (apiData.production || []).map(item => ({
            date: item.date,
            amount: item.amount,
            name: normalizeEmployeeName(item.name),
            office: item.office,
            source: `Production-${item.office}`
        }));

        // ‚ú® NEW: Parse appointments from API
        const parsedAppointmentData = (apiData.appointments || []).map(item => ({
            date: item.date,
            name: normalizeEmployeeName(item.name),
            count: item.count,
            office: item.office,
            source: `Appointment-${item.office}`
        }));

        console.log('‚úÖ All data fetched successfully');
        console.log('Collections:', parsedCollectionData.length);
        console.log('Production:', parsedProductionData.length);
        console.log('Appointments:', parsedAppointmentData.length);

        setData(parsedData);
        const combinedInsPmt = [...parsedInsPmt, ...parsedCollectionData];
        setInsPmtData(combinedInsPmt);
        setProductionData(parsedProductionData);
        setAppointmentData(parsedAppointmentData);

        // Get unique names from config
        const names = config.employeeCodes.sort();
        setUniqueNames(names);

    } catch (err) {
        console.error('Error fetching data:', err);
        setError(err.message);
    } finally {
        setLoading(false);
    }
};

            useEffect(() => { fetchDataFromSheet(); }, []);

    const calculatePerformance = () => {
                if (!selectedName) return null;

                try {
                    const today = new Date();
                    const currentMonth = today.getMonth() + 1;
                    const currentYear = today.getFullYear();

                    // Get employee assignments for display purposes (use current month for state/dept info)
const assignments = getEmployeeAssignments(configData.employees, selectedName, currentMonth, currentYear);

if (assignments.length === 0) {
    console.warn(`‚ö†Ô∏è No assignments found for ${selectedName} in ${currentMonth}/${currentYear}`);
    return {
        taskCounts: [],
        unlistedTasks: [],
        taskPercentages: {},
        totalCollectionAmount: '0.00',
        totalProductionAmount: '0.00',
        collectionPercentage: '0.0',
        productionPercentage: '0.0',
        appointmentPercentage: '0.0',
        verificationPercentage: '0.0',
        overallPerformance: 0,
        totalTasks: 0,
        department: 'Unassigned',
        state: 'N/A',
        offices: [],
        totalAppointments: 0,
        totalCalls: 0,
        totalCompletedAppointments: 0,
        numberOfDays: 0,
        appointmentGoal: 0,
        callGoal: 0,
        collectionGoal: 0,
        productionGoal: 0,
        verificationCount: 0,
        verificationGoal: 0,
        performanceChartData: [],
        dateRangeType: 'daily',
        pieChartData: [],
        radarChartData: []
    };
}

const primaryAssignment = assignments[0];

// Get unique offices only (remove duplicates)
const assignedOffices = [...new Set(assignments.map(a => a.office).filter(o => o))];

console.log(`üìã Employee Info - Name: ${selectedName}, Dept: ${primaryAssignment.department}, State: ${primaryAssignment.state}, Offices: ${assignedOffices.join(', ')}`);

                    // Filter data for this employee
let filtered = data.filter(row => {
    const normalized = normalizeEmployeeName(row.name);
    return normalized === selectedName;
});

let filteredInsPmt = insPmtData.filter(row => {
    const normalized = normalizeEmployeeName(row.name);
    return normalized === selectedName;
});

// NEW: Detect work schedule from the employee's actual work data
const allEmployeeData = [...filtered, ...filteredInsPmt];
const workSchedule = detectWorkSchedule(allEmployeeData);

console.log(`üìã Employee Info - Name: ${selectedName}, Detected Schedule: ${workSchedule}`);

// Calculate working days
let numberOfDays = 1;
let actualWorkingDays = 1; 
                    
// NEW: track actual working days separately
if (startDate && endDate) {
    const [startYear, startMonth, startDay] = startDate.split('-');
    const [endYear, endMonth, endDay] = endDate.split('-');
    const start = new Date(Date.UTC(parseInt(startYear), parseInt(startMonth) - 1, parseInt(startDay)));
    const end = new Date(Date.UTC(parseInt(endYear), parseInt(endMonth) - 1, parseInt(endDay)));
    
    if (start.toDateString() === end.toDateString()) {
        actualWorkingDays = isWorkingDay(start, workSchedule) ? 1 : 0;
        numberOfDays = Math.max(1, actualWorkingDays);
        console.log(`üìÜ Same date selected: ${start.toDateString()}, is working day: ${actualWorkingDays === 1}, schedule: ${workSchedule}`);
    } else {
        actualWorkingDays = countWorkingDays(start, end, workSchedule);
        numberOfDays = Math.max(1, actualWorkingDays);
    }
} else if (startDate || endDate) {
    const dateStr = startDate || endDate;
    const [year, month, day] = dateStr.split('-');
    const singleDate = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day)));
    actualWorkingDays = isWorkingDay(singleDate, workSchedule) ? 1 : 0;
    numberOfDays = Math.max(1, actualWorkingDays);
} else {
    // No date filter - count unique working days from data based on detected schedule
    const uniqueDates = new Set();
    filtered.forEach(row => {
        const rowDate = parseDate(row.date);
        if (rowDate && isWorkingDay(rowDate, workSchedule)) {
            uniqueDates.add(rowDate.toDateString());
        }
    });
    filteredInsPmt.forEach(row => {
        const rowDate = parseDate(row.date);
        if (rowDate && isWorkingDay(rowDate, workSchedule)) {
            uniqueDates.add(rowDate.toDateString());
        }
    });
    actualWorkingDays = Math.max(1, uniqueDates.size);
    numberOfDays = actualWorkingDays;
}

console.log(`üìä Working days: ${actualWorkingDays}, Display days: ${numberOfDays}`);

                    // Apply date filters
                    if (startDate) {
                        const startDateObj = new Date(startDate);
                        filtered = filtered.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate >= startDateObj;
                        });
                        filteredInsPmt = filteredInsPmt.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate >= startDateObj;
                        });
                    }

                    if (endDate) {
                        const endDateObj = new Date(endDate);
                        filtered = filtered.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate <= endDateObj;
                        });
                        filteredInsPmt = filteredInsPmt.filter(row => {
                            const rowDate = parseDate(row.date);
                            return rowDate && rowDate <= endDateObj;
                        });
                    }

                    const taskCounts = {};
                    const unlistedTasks = {};
                    let totalCollectionAmount = 0;
                    let totalProductionAmount = 0;
                    let totalTasks = 0;
                    let totalCompletedAppointments = 0;
                    let totalAppointments = 0;
                    let totalCalls = 0;
                    
                    const userDepartment = primaryAssignment.department;
                    const userState = primaryAssignment.state;

                    // Process main data sheet tasks
                    filtered.forEach(row => {
                        const taskName = row.task.trim();
                        const taskLower = taskName.toLowerCase();
                        const standardTaskName = findTaskName(taskName);
                        const amountValue = parseNumericValue(row.amount);
                        
                        if (amountValue > 0) {
                            if (standardTaskName) {
                                taskCounts[standardTaskName] = (taskCounts[standardTaskName] || 0) + amountValue;
                                totalTasks += amountValue;
                            } else {
                                unlistedTasks[taskName] = (unlistedTasks[taskName] || 0) + amountValue;
                                totalTasks += amountValue;
                            }
                        }
                        
                        // Outbound Department: Track appointments and calls
                        if (userDepartment === 'Outbound Department') {
                            if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt' || 
                                standardTaskName === 'Inbound Text Appt' || standardTaskName === 'Outbound Text Appt') {
                                totalAppointments += amountValue > 0 ? amountValue : 1;
                            }
                            if (standardTaskName === 'Outbound Call' || standardTaskName === 'Inbound Call') {
                                totalCalls += amountValue > 0 ? amountValue : 1;
                            }
                        }
                        
                        // AR Department: Track collection from collectionAmount column
                        if (userDepartment === 'AR Department' && taskLower === 'total balance collected') {
                            const collectionValue = parseNumericValue(row.collectionAmount);
                            if (collectionValue > 0) {
                                totalCollectionAmount += collectionValue;
                            }
                        }
                    });

                    // Process production data for Outbound Department
                    if (userDepartment === 'Outbound Department') {
                        let filteredProduction = productionData.filter(row => {
                            const normalized = normalizeEmployeeName(row.name);
                            return normalized === selectedName;
                        });
                        
                        if (startDate) {
                            const startDateObj = new Date(startDate);
                            filteredProduction = filteredProduction.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= startDateObj;
                            });
                        }

                        if (endDate) {
                            const endDateObj = new Date(endDate);
                            filteredProduction = filteredProduction.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate <= endDateObj;
                            });
                        }

                        filteredProduction.forEach(row => {
                            const amount = parseNumericValue(row.amount);
                            if (amount > 0) {
                                totalProductionAmount += amount;
                            }
                        });

                        // Process appointment data
                        let filteredAppointments = appointmentData.filter(row => {
                            const normalized = normalizeEmployeeName(row.name);
                            return normalized === selectedName;
                        });

                        if (startDate) {
                            const startDateObj = new Date(startDate);
                            filteredAppointments = filteredAppointments.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= startDateObj;
                            });
                        }

                        if (endDate) {
                            const endDateObj = new Date(endDate);
                            filteredAppointments = filteredAppointments.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate <= endDateObj;
                            });
                        }

                        totalCompletedAppointments = filteredAppointments.reduce((sum, row) => sum + (row.count || 0), 0);
                    }

                    // Add Ins Pmt / Collection sheet amounts to AR total
                    if (userDepartment === 'AR Department') {
                        filteredInsPmt.forEach(row => {
                            const amount = parseNumericValue(row.amount);
                            if (amount > 0) {
                                totalCollectionAmount += amount;
                            }
                        });
                    }

    // Calculate goals month-by-month for the selected date range
// Track goals per office for weighted performance calculation
let officeGoals = {}; // { officeName: { collection: X, production: Y, ... } }
let collectionGoal = 0;
let productionGoal = 0;
let appointmentGoal = 0;
let callGoal = 0;
let verificationGoal = 0;

// Determine the date range to calculate goals for
let goalStartDate, goalEndDate;

if (startDate && endDate) {
    goalStartDate = new Date(startDate);
    goalEndDate = new Date(endDate);
    console.log(`üéØ Date range: ${goalStartDate.toDateString()} to ${goalEndDate.toDateString()}`);
} else if (startDate) {
    goalStartDate = new Date(startDate);
    goalEndDate = new Date(startDate);
    console.log(`üéØ Single start date: ${goalStartDate.toDateString()}`);
} else if (endDate) {
    goalStartDate = new Date(endDate);
    goalEndDate = new Date(endDate);
    console.log(`üéØ Single end date: ${goalEndDate.toDateString()}`);
} else {
    // If no date range selected, use current month
    goalStartDate = new Date(currentYear, currentMonth - 1, 1);
    goalEndDate = new Date(currentYear, currentMonth, 0); // Last day of current month
    console.log(`üéØ No dates - using current month: ${goalStartDate.toDateString()} to ${goalEndDate.toDateString()}`);
}

// Important: Ensure endDate is inclusive for same-day scenarios
if (goalStartDate.toDateString() === goalEndDate.toDateString()) {
    console.log(`‚ö†Ô∏è Same date detected - ensuring full day coverage`);
}

// Initialize sets to track months and years
const displayMonths = new Set();
const displayYears = new Set();

// Loop through each month in the date range
let currentDate = new Date(goalStartDate.getFullYear(), goalStartDate.getMonth(), 1);
const endMonth = new Date(goalEndDate.getFullYear(), goalEndDate.getMonth(), 1);

while (currentDate <= endMonth) {
    const month = currentDate.getMonth() + 1;
    const year = currentDate.getFullYear();
    
    // Track which months we're covering
    displayMonths.add(month);
    displayYears.add(year);
    
    // Get assignments for THIS specific month
    const monthAssignments = getEmployeeAssignments(configData.employees, selectedName, month, year);
    
    if (monthAssignments.length > 0) {
        const monthOffices = monthAssignments.map(a => a.office).filter(o => o);
        
        console.log(`üìÖ ${month}/${year} - Offices:`, monthOffices);
        
        // Calculate the date range for THIS month only
const firstDayOfMonth = new Date(year, month - 1, 1);
const lastDayOfMonth = new Date(year, month, 0);

const monthStart = goalStartDate > firstDayOfMonth ? new Date(goalStartDate) : firstDayOfMonth;
const monthEnd = goalEndDate < lastDayOfMonth ? new Date(goalEndDate) : lastDayOfMonth;
        
        let daysInThisMonth = countWorkingDays(monthStart, monthEnd);

// For single-day selections, use actualWorkingDays instead
if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    if (start.toDateString() === end.toDateString()) {
        daysInThisMonth = actualWorkingDays;
    }
}

console.log(`üìÖ ${month}/${year} - Working days in range: ${daysInThisMonth}`);
        
        // NEW: Calculate AVERAGE goal for this month, then add to total
        if (monthOffices.length > 0) {
            let monthTotalCollection = 0, monthTotalProduction = 0, monthTotalAppointment = 0;
            let monthTotalCall = 0, monthTotalVerification = 0;
            
            monthOffices.forEach(office => {
                if (!officeGoals[office]) {
                    officeGoals[office] = { collection: 0, production: 0, appointment: 0, call: 0, verification: 0 };
                }
                
                const officeCollectionGoal = getGoalForOffice(configData.goals, monthAssignments[0].department, office, 'Collection', month, year);
                const officeProductionGoal = getGoalForOffice(configData.goals, monthAssignments[0].department, office, 'Production', month, year);
                const officeAppointmentGoal = getGoalForOffice(configData.goals, monthAssignments[0].department, office, 'Appointment', month, year);
                const officeCallGoal = getGoalForOffice(configData.goals, monthAssignments[0].department, office, 'Call', month, year);
                const officeVerificationGoal = getGoalForOffice(configData.goals, monthAssignments[0].department, office, 'Verification', month, year);
                
                // Store in officeGoals for weighted performance calculation
                officeGoals[office].collection += officeCollectionGoal * daysInThisMonth;
                officeGoals[office].production += officeProductionGoal * daysInThisMonth;
                officeGoals[office].appointment += officeAppointmentGoal * daysInThisMonth;
                officeGoals[office].call += officeCallGoal * daysInThisMonth;
                officeGoals[office].verification += officeVerificationGoal * daysInThisMonth;
                
                // Sum goals for this month (will be averaged below)
                monthTotalCollection += officeCollectionGoal * daysInThisMonth;
                monthTotalProduction += officeProductionGoal * daysInThisMonth;
                monthTotalAppointment += officeAppointmentGoal * daysInThisMonth;
                monthTotalCall += officeCallGoal * daysInThisMonth;
                monthTotalVerification += officeVerificationGoal * daysInThisMonth;
            });
            
            // Calculate AVERAGE for this month and add to employee's total
            const officeCount = monthOffices.length;
            collectionGoal += monthTotalCollection / officeCount;
            productionGoal += monthTotalProduction / officeCount;
            appointmentGoal += monthTotalAppointment / officeCount;
            callGoal += monthTotalCall / officeCount;
            verificationGoal += monthTotalVerification / officeCount;
            
            console.log(`üìä Month ${month}/${year}: ${officeCount} offices, avg daily goal: ${(monthTotalCollection / officeCount / daysInThisMonth).toFixed(2)}`);
        }
    }
    
    // Move to next month
    currentDate.setMonth(currentDate.getMonth() + 1);
}
                    // Calculate state totals for percentage calculations
                    let stateCollectionTotal = 0, stateProductionTotal = 0, stateAppointmentTotal = 0, stateVerificationTotal = 0;
                    const stateTaskTotals = {};
                    
                    // Get all employees in same state
                    const employeesInState = configData.employeeCodes.filter(empCode => {
                        const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
                        return empAssignments.length > 0 && empAssignments[0].state === userState;
                    });

                    employeesInState.forEach(empName => {
                        let empFiltered = data.filter(row => {
                            const normalized = normalizeEmployeeName(row.name);
                            return normalized === empName;
                        });
                        let empFilteredInsPmt = insPmtData.filter(row => {
                            const normalized = normalizeEmployeeName(row.name);
                            return normalized === empName;
                        });

                        // Apply date filters to state totals
                        if (startDate) {
                            const startDateObj = new Date(startDate);
                            empFiltered = empFiltered.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= startDateObj;
                            });
                            empFilteredInsPmt = empFilteredInsPmt.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate >= startDateObj;
                            });
                        }

                        if (endDate) {
                            const endDateObj = new Date(endDate);
                            empFiltered = empFiltered.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate <= endDateObj;
                            });
                            empFilteredInsPmt = empFilteredInsPmt.filter(row => {
                                const rowDate = parseDate(row.date);
                                return rowDate && rowDate <= endDateObj;
                            });
                        }

                        const empAssignments = getEmployeeAssignments(configData.employees, empName, currentMonth, currentYear);
                        const empDept = empAssignments[0]?.department;
                        
                        // Sum AR collections for state
                        if (empDept === 'AR Department') {
                            empFiltered.forEach(row => {
                                const taskLower = row.task.trim().toLowerCase();
                                if (taskLower === 'total balance collected') {
                                    const amount = parseNumericValue(row.collectionAmount);
                                    if (amount > 0) stateCollectionTotal += amount;
                                }
                            });
                            empFilteredInsPmt.forEach(row => {
                                const amount = parseNumericValue(row.amount);
                                if (amount > 0) stateCollectionTotal += amount;
                            });
                        }

                        // Sum Outbound production and appointments for state
                        if (empDept === 'Outbound Department') {
                            let empFilteredProduction = productionData.filter(row => {
                                const normalized = normalizeEmployeeName(row.name);
                                return normalized === empName;
                            });

                            if (startDate) {
                                const startDateObj = new Date(startDate);
                                empFilteredProduction = empFilteredProduction.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate >= startDateObj;
                                });
                            }

                            if (endDate) {
                                const endDateObj = new Date(endDate);
                                empFilteredProduction = empFilteredProduction.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate <= endDateObj;
                                });
                            }

                            empFilteredProduction.forEach(row => {
                                const amount = parseNumericValue(row.amount);
                                if (amount > 0) stateProductionTotal += amount;
                            });

                            let empFilteredAppointments = appointmentData.filter(row => {
                                const normalized = normalizeEmployeeName(row.name);
                                return normalized === empName;
                            });

                            if (startDate) {
                                const startDateObj = new Date(startDate);
                                empFilteredAppointments = empFilteredAppointments.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate >= startDateObj;
                                });
                            }

                            if (endDate) {
                                const endDateObj = new Date(endDate);
                                empFilteredAppointments = empFilteredAppointments.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate <= endDateObj;
                                });
                            }

                            stateAppointmentTotal += empFilteredAppointments.reduce((sum, row) => sum + (row.count || 0), 0);
                        }

                        // Sum Verification counts for state
                        if (empDept === 'Verification Department') {
                            empFiltered.forEach(row => {
                                const standardTaskName = findTaskName(row.task.trim());
                                if (standardTaskName === 'Verification' || 
                                    standardTaskName === 'Verification (M)' || 
                                    standardTaskName === 'Verification (P)') {
                                    const amountValue = parseNumericValue(row.amount);
                                    if (amountValue > 0) {
                                        stateVerificationTotal += amountValue;
                                    }
                                }
                            });
                        }

                        // Sum all task counts for state percentages
                        empFiltered.forEach(row => {
                            const standardTaskName = findTaskName(row.task.trim());
                            if (standardTaskName) {
                                const amountValue = parseNumericValue(row.amount);
                                if (amountValue > 0) {
                                    stateTaskTotals[standardTaskName] = (stateTaskTotals[standardTaskName] || 0) + amountValue;
                                }
                            }
                        });
                    });

    // Calculate percentages relative to state
                    const collectionPercentage = stateCollectionTotal > 0 ? (totalCollectionAmount / stateCollectionTotal) * 100 : 0;
                    const productionPercentage = stateProductionTotal > 0 ? (totalProductionAmount / stateProductionTotal) * 100 : 0;
                    const appointmentPercentage = stateAppointmentTotal > 0 ? (totalCompletedAppointments / stateAppointmentTotal) * 100 : 0;
                    const userVerificationCount = (taskCounts['Verification'] || 0) + 
                                  (taskCounts['Verification (M)'] || 0) + 
                                  (taskCounts['Verification (P)'] || 0);
                    const verificationPercentage = stateVerificationTotal > 0 ? (userVerificationCount / stateVerificationTotal) * 100 : 0;

                    const taskPercentages = {};
                    Object.keys(taskCounts).forEach(taskName => {
                        const stateTotal = stateTaskTotals[taskName] || 0;
                        taskPercentages[taskName] = stateTotal > 0 ? (taskCounts[taskName] / stateTotal) * 100 : 0;
                    });

                    const sortedTasks = Object.entries(taskCounts).sort((a, b) => b[1] - a[1]);
                    const sortedUnlistedTasks = Object.entries(unlistedTasks).sort((a, b) => b[1] - a[1]);

                    // Calculate overall performance based on department (Option B: weighted by office goals)
                    let overallPerformance = 0;
                    if (userDepartment === 'Outbound Department') {
                        // Calculate weighted performance for each office
                        let totalWeightedPerf = 0;
                        let officeCount = 0;
                        
                        Object.keys(officeGoals).forEach(office => {
                            const officeData = officeGoals[office];
                            if (officeData.production > 0 || officeData.appointment > 0 || officeData.call > 0) {
                                // Get actual collections for this office
                                let officeProduction = productionData.filter(row => {
                                    const normalized = normalizeEmployeeName(row.name);
                                    const rowDate = parseDate(row.date);
                                    let inRange = normalized === selectedName && row.office === office;
                                    if (startDate) inRange = inRange && rowDate >= new Date(startDate);
                                    if (endDate) inRange = inRange && rowDate <= new Date(endDate);
                                    return inRange;
                                }).reduce((sum, row) => sum + parseNumericValue(row.amount), 0);
                                
                                let officeAppointments = appointmentData.filter(row => {
                                    const normalized = normalizeEmployeeName(row.name);
                                    const rowDate = parseDate(row.date);
                                    let inRange = normalized === selectedName && row.office === office;
                                    if (startDate) inRange = inRange && rowDate >= new Date(startDate);
                                    if (endDate) inRange = inRange && rowDate <= new Date(endDate);
                                    return inRange;
                                }).reduce((sum, row) => sum + (row.count || 0), 0);
                                
                                // Calls aren't tracked by office in the data, so distribute proportionally
                                const callRatio = officeData.call / callGoal;
                                const officeCalls = totalCalls * callRatio;
                                
                                const prodPerf = officeData.production > 0 ? (officeProduction / officeData.production) * 100 : 0;
                                const apptPerf = officeData.appointment > 0 ? (officeAppointments / officeData.appointment) * 100 : 0;
                                const callPerf = officeData.call > 0 ? (officeCalls / officeData.call) * 100 : 0;
                                
                                const officePerf = (prodPerf + apptPerf + callPerf) / 3;
                                totalWeightedPerf += officePerf;
                                officeCount++;
                            }
                        });
                        
                        overallPerformance = officeCount > 0 ? Math.min(100, totalWeightedPerf / officeCount) : 0;
                    } else if (userDepartment === 'AR Department') {
                        // Calculate weighted performance for each office
                        let totalWeightedPerf = 0;
                        let officeCount = 0;
                        
                        Object.keys(officeGoals).forEach(office => {
                            const officeData = officeGoals[office];
                            if (officeData.collection > 0) {
                                // Get actual collections for this office
                                // Collection data comes from multiple sources - we'll distribute proportionally
                                const collectionRatio = officeData.collection / collectionGoal;
                                const officeCollection = totalCollectionAmount * collectionRatio;
                                
                                const officePerf = (officeCollection / officeData.collection) * 100;
                                totalWeightedPerf += officePerf;
                                officeCount++;
                            }
                        });
                        
                        overallPerformance = officeCount > 0 ? Math.min(100, totalWeightedPerf / officeCount) : 0;
                    } else if (userDepartment === 'Verification Department') {
                        // Calculate weighted performance for each office
                        let totalWeightedPerf = 0;
                        let officeCount = 0;
                        
                        Object.keys(officeGoals).forEach(office => {
                            const officeData = officeGoals[office];
                            if (officeData.verification > 0) {
                                // Distribute verifications proportionally
                                const verificationRatio = officeData.verification / verificationGoal;
                                const officeVerifications = userVerificationCount * verificationRatio;
                                
                                const officePerf = (officeVerifications / officeData.verification) * 100;
                                totalWeightedPerf += officePerf;
                                officeCount++;
                            }
                        });
                        
                        overallPerformance = officeCount > 0 ? Math.min(100, totalWeightedPerf / officeCount) : 0;
                    }

                    // NEW: Prepare Pie Chart Data with scope and metric options
                    let pieChartData = [];
                    if (userDepartment === 'AR Department') {
                        const stateTotalMinusUser = stateCollectionTotal - totalCollectionAmount;
                        const allDeptTotal = configData.employeeCodes.reduce((sum, empCode) => {
                            const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
                            if (empAssignments.length > 0 && empAssignments[0].department === 'AR Department') {
                                let empData = data.filter(row => normalizeEmployeeName(row.name) === empCode);
                                let empInsPmt = insPmtData.filter(row => normalizeEmployeeName(row.name) === empCode);
                                
                                if (startDate) {
                                    const startDateObj = new Date(startDate);
                                    empData = empData.filter(row => parseDate(row.date) >= startDateObj);
                                    empInsPmt = empInsPmt.filter(row => parseDate(row.date) >= startDateObj);
                                }
                                if (endDate) {
                                    const endDateObj = new Date(endDate);
                                    empData = empData.filter(row => parseDate(row.date) <= endDateObj);
                                    empInsPmt = empInsPmt.filter(row => parseDate(row.date) <= endDateObj);
                                }
                                
                                let empCollection = 0;
                                empData.forEach(row => {
                                    if (row.task.trim().toLowerCase() === 'total balance collected') {
                                        empCollection += parseNumericValue(row.collectionAmount);
                                    }
                                });
                                empInsPmt.forEach(row => {
                                    empCollection += parseNumericValue(row.amount);
                                });
                                return sum + empCollection;
                            }
                            return sum;
                        }, 0);
                        
                        if (pieChartScope === 'state') {
                            pieChartData = [
                                { label: 'You', value: totalCollectionAmount },
                                { label: 'Rest of State', value: Math.max(0, stateTotalMinusUser) }
                            ];
                        } else {
                            pieChartData = [
                                { label: 'You', value: totalCollectionAmount },
                                { label: 'All AR Dept', value: Math.max(0, allDeptTotal - totalCollectionAmount) }
                            ];
                        }
                    } else if (userDepartment === 'Outbound Department') {
                        // Calculate totals for all metrics
                        let userMetricValue = 0, stateMetricTotal = 0, allDeptMetricTotal = 0;
                        
                        if (outboundMetric === 'production') {
                            userMetricValue = totalProductionAmount;
                            stateMetricTotal = stateProductionTotal;
                            
                            allDeptMetricTotal = configData.employeeCodes.reduce((sum, empCode) => {
                                const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
                                if (empAssignments.length > 0 && empAssignments[0].department === 'Outbound Department') {
                                    let empProduction = productionData.filter(row => normalizeEmployeeName(row.name) === empCode);
                                    if (startDate) {
                                        const startDateObj = new Date(startDate);
                                        empProduction = empProduction.filter(row => parseDate(row.date) >= startDateObj);
                                    }
                                    if (endDate) {
                                        const endDateObj = new Date(endDate);
                                        empProduction = empProduction.filter(row => parseDate(row.date) <= endDateObj);
                                    }
                                    return sum + empProduction.reduce((s, row) => s + parseNumericValue(row.amount), 0);
                                }
                                return sum;
                            }, 0);
                        } else if (outboundMetric === 'appointments') {
    userMetricValue = totalAppointments; // Use totalAppointments from Sheet 1 data
    stateMetricTotal = 0; // We'll recalculate this from Sheet 1 data
    
    // Calculate state total from Sheet 1 appointment tasks
    const employeesInState = configData.employeeCodes.filter(empCode => {
        const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
        return empAssignments.length > 0 && empAssignments[0].state === userState;
    });
    
    stateMetricTotal = employeesInState.reduce((sum, empCode) => {
        const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
        if (empAssignments[0]?.department === 'Outbound Department') {
            let empData = data.filter(row => normalizeEmployeeName(row.name) === empCode);
            if (startDate) {
                const startDateObj = new Date(startDate);
                empData = empData.filter(row => parseDate(row.date) >= startDateObj);
            }
            if (endDate) {
                const endDateObj = new Date(endDate);
                empData = empData.filter(row => parseDate(row.date) <= endDateObj);
            }
            let empAppointments = 0;
            empData.forEach(row => {
                const standardTaskName = findTaskName(row.task.trim());
                if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt' || 
                    standardTaskName === 'Inbound Text Appt' || standardTaskName === 'Outbound Text Appt') {
                    const amountValue = parseNumericValue(row.amount);
                    empAppointments += amountValue > 0 ? amountValue : 1;
                }
            });
            return sum + empAppointments;
        }
        return sum;
    }, 0);
    
    allDeptMetricTotal = configData.employeeCodes.reduce((sum, empCode) => {
        const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
        if (empAssignments.length > 0 && empAssignments[0].department === 'Outbound Department') {
            let empData = data.filter(row => normalizeEmployeeName(row.name) === empCode);
            if (startDate) {
                const startDateObj = new Date(startDate);
                empData = empData.filter(row => parseDate(row.date) >= startDateObj);
            }
            if (endDate) {
                const endDateObj = new Date(endDate);
                empData = empData.filter(row => parseDate(row.date) <= endDateObj);
            }
            let empAppointments = 0;
            empData.forEach(row => {
                const standardTaskName = findTaskName(row.task.trim());
                if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt' || 
                    standardTaskName === 'Inbound Text Appt' || standardTaskName === 'Outbound Text Appt') {
                    const amountValue = parseNumericValue(row.amount);
                    empAppointments += amountValue > 0 ? amountValue : 1;
                }
            });
            return sum + empAppointments;
        }
        return sum;
    }, 0);
} 
                        else if (outboundMetric === 'calls') {
                            userMetricValue = totalCalls;
                            
                            // Calculate state calls total
                            const employeesInState = configData.employeeCodes.filter(empCode => {
                                const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
                                return empAssignments.length > 0 && empAssignments[0].state === userState;
                            });
                            
                            stateMetricTotal = employeesInState.reduce((sum, empCode) => {
                                const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
                                if (empAssignments[0]?.department === 'Outbound Department') {
                                    let empData = data.filter(row => normalizeEmployeeName(row.name) === empCode);
                                    if (startDate) {
                                        const startDateObj = new Date(startDate);
                                        empData = empData.filter(row => parseDate(row.date) >= startDateObj);
                                    }
                                    if (endDate) {
                                        const endDateObj = new Date(endDate);
                                        empData = empData.filter(row => parseDate(row.date) <= endDateObj);
                                    }
                                    let empCalls = 0;
                                    empData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        if (standardTaskName === 'Outbound Call' || standardTaskName === 'Inbound Call') {
                                            empCalls += parseNumericValue(row.amount) || 1;
                                        }
                                    });
                                    return sum + empCalls;
                                }
                                return sum;
                            }, 0);
                            
                            allDeptMetricTotal = configData.employeeCodes.reduce((sum, empCode) => {
                                const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
                                if (empAssignments.length > 0 && empAssignments[0].department === 'Outbound Department') {
                                    let empData = data.filter(row => normalizeEmployeeName(row.name) === empCode);
                                    if (startDate) {
                                        const startDateObj = new Date(startDate);
                                        empData = empData.filter(row => parseDate(row.date) >= startDateObj);
                                    }
                                    if (endDate) {
                                        const endDateObj = new Date(endDate);
                                        empData = empData.filter(row => parseDate(row.date) <= endDateObj);
                                    }
                                    let empCalls = 0;
                                    empData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        if (standardTaskName === 'Outbound Call' || standardTaskName === 'Inbound Call') {
                                            empCalls += parseNumericValue(row.amount) || 1;
                                        }
                                    });
                                    return sum + empCalls;
                                }
                                return sum;
                            }, 0);
                        }
                        
                        if (pieChartScope === 'state') {
                            pieChartData = [
                                { label: 'You', value: userMetricValue },
                                { label: 'Rest of State', value: Math.max(0, stateMetricTotal - userMetricValue) }
                            ];
                        } else {
                            pieChartData = [
                                { label: 'You', value: userMetricValue },
                                { label: 'All Outbound Dept', value: Math.max(0, allDeptMetricTotal - userMetricValue) }
                            ];
                        }
                    } else if (userDepartment === 'Verification Department') {
                        const stateTotalMinusUser = stateVerificationTotal - userVerificationCount;
                        const allDeptTotal = configData.employeeCodes.reduce((sum, empCode) => {
                            const empAssignments = getEmployeeAssignments(configData.employees, empCode, currentMonth, currentYear);
                            if (empAssignments.length > 0 && empAssignments[0].department === 'Verification Department') {
                                let empData = data.filter(row => normalizeEmployeeName(row.name) === empCode);
                                
                                if (startDate) {
                                    const startDateObj = new Date(startDate);
                                    empData = empData.filter(row => parseDate(row.date) >= startDateObj);
                                }
                                if (endDate) {
                                    const endDateObj = new Date(endDate);
                                    empData = empData.filter(row => parseDate(row.date) <= endDateObj);
                                }
                                
                                let empVerifications = 0;
                                empData.forEach(row => {
                                    const standardTaskName = findTaskName(row.task.trim());
                                    if (standardTaskName === 'Verification' || 
                                        standardTaskName === 'Verification (M)' || 
                                        standardTaskName === 'Verification (P)') {
                                        empVerifications += parseNumericValue(row.amount);
                                    }
                                });
                                return sum + empVerifications;
                            }
                            return sum;
                        }, 0);
                        
                        if (pieChartScope === 'state') {
                            pieChartData = [
                                { label: 'You', value: userVerificationCount },
                                { label: 'Rest of State', value: Math.max(0, stateTotalMinusUser) }
                            ];
                        } else {
                            pieChartData = [
                                { label: 'You', value: userVerificationCount },
                                { label: 'All Verification Dept', value: Math.max(0, allDeptTotal - userVerificationCount) }
                            ];
                        }
                    }

                    // NEW: Prepare Radar Chart Data based on department
                    let radarChartData = [];
                    if (userDepartment === 'Verification Department') {
                        const verificationM = taskCounts['Verification (M)'] || 0;
                        const verificationP = taskCounts['Verification (P)'] || 0;
                        const otherTasks = totalTasks - verificationM - verificationP;
                        radarChartData = [
                            { label: 'Verification (M)', value: verificationM },
                            { label: 'Verification (P)', value: verificationP },
                            { label: 'Other Tasks', value: Math.max(0, otherTasks) }
                        ];
                    } else if (userDepartment === 'Outbound Department') {
                        const inboundCall = taskCounts['Inbound Call'] || 0;
                        const outboundCall = taskCounts['Outbound Call'] || 0;
                        const confirmationCalls = (taskCounts['20MIN Confirmation Call'] || 0) + 
                                                  (taskCounts['24HR Confirmation Call'] || 0) + 
                                                  (taskCounts['48HR Confirmation Call'] || 0);
                        const otherTasks = totalTasks - inboundCall - outboundCall - confirmationCalls;
                        radarChartData = [
                            { label: 'Inbound Call', value: inboundCall },
                            { label: 'Outbound Call', value: outboundCall },
                            { label: 'Confirmation Calls', value: confirmationCalls },
                            { label: 'Other Tasks', value: Math.max(0, otherTasks) }
                        ];
                    } else if (userDepartment === 'AR Department') {
                        // AR Department task categories
                        const billerTasks = (taskCounts['Batching Claims'] || 0) + 
                                           (taskCounts['Sending Private Claims'] || 0) + 
                                           (taskCounts['Sending Medicaid Claims'] || 0) +
                                           (taskCounts['Billing Call'] || 0) +
                                           (taskCounts['Outstanding Claims'] || 0);
                        const posterTasks = (taskCounts['Entering Payments'] || 0) + 
                                           (taskCounts['Entering EOBs'] || 0) +
                                           (taskCounts['Processing CC Payments'] || 0);
                        const doctorPayroll = taskCounts['Doctor Payroll'] || 0;
                        const credentialing = taskCounts['Credentialing'] || 0;
                        const otherTasks = totalTasks - billerTasks - posterTasks - doctorPayroll - credentialing;
                        radarChartData = [
                            { label: 'Biller Tasks', value: billerTasks },
                            { label: 'Poster Tasks', value: posterTasks },
                            { label: 'Doctor Payroll', value: doctorPayroll },
                            { label: 'Credentialing', value: credentialing },
                            { label: 'Other Tasks', value: Math.max(0, otherTasks) }
                        ];
                    }

    // Performance chart data generation
                    let performanceChartData = [];
                    let dateRangeType = 'daily';

                    if (startDate && endDate) {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

                        if (daysDiff <= 7) {
                            dateRangeType = 'daily';
                            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                                const dayData = filtered.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate.toDateString() === d.toDateString();
                                });

                                let dayPerformance = 0;
                                if (userDepartment === 'Outbound Department') {
                                    let dayAppointments = 0, dayCalls = 0, dayProduction = 0;
                                    dayData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        const amountValue = parseNumericValue(row.amount);
                                        if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt') dayAppointments += amountValue;
                                        if (standardTaskName === 'Outbound Call') dayCalls += amountValue;
                                    });
                                    const dayProductionData = productionData.filter(row => {
                                        const normalized = normalizeEmployeeName(row.name);
                                        const rowDate = parseDate(row.date);
                                        return normalized === selectedName && rowDate && rowDate.toDateString() === d.toDateString();
                                    });
                                    dayProduction = dayProductionData.reduce((sum, row) => sum + parseNumericValue(row.amount), 0);
                                    
                                    const avgAppGoal = appointmentGoal / numberOfDays;
                                    const avgCallGoal = callGoal / numberOfDays;
                                    const avgProdGoal = productionGoal / numberOfDays;
                                    const appointmentPerf = avgAppGoal > 0 ? (dayAppointments / avgAppGoal) * 100 : 0;
                                    const callPerf = avgCallGoal > 0 ? (dayCalls / avgCallGoal) * 100 : 0;
                                    const productionPerf = avgProdGoal > 0 ? (dayProduction / avgProdGoal) * 100 : 0;
                                    dayPerformance = Math.min(100, ((appointmentPerf + callPerf + productionPerf) / 3));
                                } else if (userDepartment === 'AR Department') {
                                    let dayCollection = 0;
                                    dayData.forEach(row => {
                                        const taskLower = row.task.trim().toLowerCase();
                                        if (taskLower === 'total balance collected') {
                                            dayCollection += parseNumericValue(row.collectionAmount);
                                        }
                                    });
                                    const dayInsPmtData = filteredInsPmt.filter(row => {
                                        const rowDate = parseDate(row.date);
                                        return rowDate && rowDate.toDateString() === d.toDateString();
                                    });
                                    dayInsPmtData.forEach(row => {
                                        dayCollection += parseNumericValue(row.amount);
                                    });
                                    const avgCollGoal = collectionGoal / numberOfDays;
                                    dayPerformance = avgCollGoal > 0 ? Math.min(100, (dayCollection / avgCollGoal) * 100) : 0;
                                } else if (userDepartment === 'Verification Department') {
                                    let dayVerifications = 0;
                                    dayData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        if (standardTaskName === 'Verification' || 
                                            standardTaskName === 'Verification (M)' || 
                                            standardTaskName === 'Verification (P)') {
                                            dayVerifications += parseNumericValue(row.amount);
                                        }
                                    });
                                    const avgVerGoal = verificationGoal / numberOfDays;
                                    dayPerformance = avgVerGoal > 0 ? Math.min(100, (dayVerifications / avgVerGoal) * 100) : 0;
                                }
                                performanceChartData.push({ label: `${d.getMonth() + 1}/${d.getDate()}`, value: dayPerformance });
                            }
                        } else if (daysDiff <= 30) {
                            dateRangeType = 'weekly';
                            const weeks = [];
                            let weekStart = new Date(start);
                            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
                            while (weekStart <= end) {
                                const weekEnd = new Date(weekStart);
                                weekEnd.setDate(weekEnd.getDate() + 6);
                                weeks.push({ start: new Date(weekStart), end: new Date(Math.min(weekEnd, end)) });
                                weekStart.setDate(weekStart.getDate() + 7);
                            }
                            weeks.forEach((week, index) => {
                                const weekData = filtered.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate >= week.start && rowDate <= week.end;
                                });
                                const weekDays = countWorkingDays(week.start, week.end);
                                let weekPerformance = 0;
                                
                                if (userDepartment === 'Outbound Department') {
                                    let weekAppointments = 0, weekCalls = 0, weekProduction = 0;
                                    weekData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        const amountValue = parseNumericValue(row.amount);
                                        if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt') weekAppointments += amountValue;
                                        if (standardTaskName === 'Outbound Call') weekCalls += amountValue;
                                    });
                                    const weekProductionData = productionData.filter(row => {
                                        const normalized = normalizeEmployeeName(row.name);
                                        const rowDate = parseDate(row.date);
                                        return normalized === selectedName && rowDate && rowDate >= week.start && rowDate <= week.end;
                                    });
                                    weekProduction = weekProductionData.reduce((sum, row) => sum + parseNumericValue(row.amount), 0);
                                    
                                    const weekAppGoal = (appointmentGoal / numberOfDays) * weekDays;
                                    const weekCallGoal = (callGoal / numberOfDays) * weekDays;
                                    const weekProdGoal = (productionGoal / numberOfDays) * weekDays;
                                    const appointmentPerf = weekAppGoal > 0 ? (weekAppointments / weekAppGoal) * 100 : 0;
                                    const callPerf = weekCallGoal > 0 ? (weekCalls / weekCallGoal) * 100 : 0;
                                    const productionPerf = weekProdGoal > 0 ? (weekProduction / weekProdGoal) * 100 : 0;
                                    weekPerformance = Math.min(100, ((appointmentPerf + callPerf + productionPerf) / 3));
                                } else if (userDepartment === 'AR Department') {
                                    let weekCollection = 0;
                                    weekData.forEach(row => {
                                        const taskLower = row.task.trim().toLowerCase();
                                        if (taskLower === 'total balance collected') {
                                            weekCollection += parseNumericValue(row.collectionAmount);
                                        }
                                    });
                                    const weekInsPmtData = filteredInsPmt.filter(row => {
                                        const rowDate = parseDate(row.date);
                                        return rowDate && rowDate >= week.start && rowDate <= week.end;
                                    });
                                    weekInsPmtData.forEach(row => {
                                        weekCollection += parseNumericValue(row.amount);
                                    });
                                    const weekCollGoal = (collectionGoal / numberOfDays) * weekDays;
                                    weekPerformance = weekCollGoal > 0 ? Math.min(100, (weekCollection / weekCollGoal) * 100) : 0;
                                } else if (userDepartment === 'Verification Department') {
                                    let weekVerifications = 0;
                                    weekData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        if (standardTaskName === 'Verification' || 
                                            standardTaskName === 'Verification (M)' || 
                                            standardTaskName === 'Verification (P)') {
                                            weekVerifications += parseNumericValue(row.amount);
                                        }
                                    });
                                    const weekVerGoal = (verificationGoal / numberOfDays) * weekDays;
                                    weekPerformance = weekVerGoal > 0 ? Math.min(100, (weekVerifications / weekVerGoal) * 100) : 0;
                                }
                                performanceChartData.push({ label: `Week ${index + 1}`, value: weekPerformance });
                            });
                        } else {
                            dateRangeType = 'monthly';
                            const months = [];
                            let monthStart = new Date(start.getFullYear(), start.getMonth(), 1);
                            while (monthStart <= end) {
                                const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
                                months.push({
                                    start: new Date(Math.max(monthStart, start)),
                                    end: new Date(Math.min(monthEnd, end)),
                                    label: monthStart.toLocaleString('default', { month: 'short', year: 'numeric' })
                                });
                                monthStart.setMonth(monthStart.getMonth() + 1);
                            }
                            months.forEach((month) => {
                                const monthData = filtered.filter(row => {
                                    const rowDate = parseDate(row.date);
                                    return rowDate && rowDate >= month.start && rowDate <= month.end;
                                });
                                const monthDays = countWorkingDays(month.start, month.end);
                                let monthPerformance = 0;
                                
                                if (userDepartment === 'Outbound Department') {
                                    let monthAppointments = 0, monthCalls = 0, monthProduction = 0;
                                    monthData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        const amountValue = parseNumericValue(row.amount);
                                        if (standardTaskName === 'Inbound Appt' || standardTaskName === 'Outbound Appt') monthAppointments += amountValue;
                                        if (standardTaskName === 'Outbound Call') monthCalls += amountValue;
                                    });
                                    const monthProductionData = productionData.filter(row => {
                                        const normalized = normalizeEmployeeName(row.name);
                                        const rowDate = parseDate(row.date);
                                        return normalized === selectedName && rowDate && rowDate >= month.start && rowDate <= month.end;
                                    });
                                    monthProduction = monthProductionData.reduce((sum, row) => sum + parseNumericValue(row.amount), 0);
                                    
                                    const monthAppGoal = (appointmentGoal / numberOfDays) * monthDays;
                                    const monthCallGoal = (callGoal / numberOfDays) * monthDays;
                                    const monthProdGoal = (productionGoal / numberOfDays) * monthDays;
                                    const appointmentPerf = monthAppGoal > 0 ? (monthAppointments / monthAppGoal) * 100 : 0;
                                    const callPerf = monthCallGoal > 0 ? (monthCalls / monthCallGoal) * 100 : 0;
                                    const productionPerf = monthProdGoal > 0 ? (monthProduction / monthProdGoal) * 100 : 0;
                                    monthPerformance = Math.min(100, ((appointmentPerf + callPerf + productionPerf) / 3));
                                } else if (userDepartment === 'AR Department') {
                                    let monthCollection = 0;
                                    monthData.forEach(row => {
                                        const taskLower = row.task.trim().toLowerCase();
                                        if (taskLower === 'total balance collected') {
                                            monthCollection += parseNumericValue(row.collectionAmount);
                                        }
                                    });
                                    const monthInsPmtData = filteredInsPmt.filter(row => {
                                        const rowDate = parseDate(row.date);
                                        return rowDate && rowDate >= month.start && rowDate <= month.end;
                                    });
                                    monthInsPmtData.forEach(row => {
                                        monthCollection += parseNumericValue(row.amount);
                                    });
                                    const monthCollGoal = (collectionGoal / numberOfDays) * monthDays;
                                    monthPerformance = monthCollGoal > 0 ? Math.min(100, (monthCollection / monthCollGoal) * 100) : 0;
                                } else if (userDepartment === 'Verification Department') {
                                    let monthVerifications = 0;
                                    monthData.forEach(row => {
                                        const standardTaskName = findTaskName(row.task.trim());
                                        if (standardTaskName === 'Verification' || 
                                            standardTaskName === 'Verification (M)' || 
                                            standardTaskName === 'Verification (P)') {
                                            monthVerifications += parseNumericValue(row.amount);
                                        }
                                    });
                                    const monthVerGoal = (verificationGoal / numberOfDays) * monthDays;
                                    monthPerformance = monthVerGoal > 0 ? Math.min(100, (monthVerifications / monthVerGoal) * 100) : 0;
                                }
                                performanceChartData.push({ label: month.label, value: monthPerformance });
                            });
                        }
                    }

    return {
                    taskCounts: sortedTasks, 
                    unlistedTasks: sortedUnlistedTasks, 
                    taskPercentages,
                    totalCollectionAmount: totalCollectionAmount.toFixed(2),
                    totalProductionAmount: totalProductionAmount.toFixed(2),
                    collectionPercentage: collectionPercentage.toFixed(1),
                    productionPercentage: productionPercentage.toFixed(1),
                    appointmentPercentage: appointmentPercentage.toFixed(1),
                    verificationPercentage: verificationPercentage.toFixed(1),
                    overallPerformance: Math.round(overallPerformance),
                    totalTasks: Math.round(totalTasks), 
                    department: userDepartment, 
                    state: userState,
                    offices: assignedOffices,
                    totalAppointments, 
                    totalCalls, 
                    totalCompletedAppointments, 
                    numberOfDays,
                    appointmentGoal: appointmentGoal,
                    callGoal: callGoal,
                    collectionGoal: collectionGoal,
                    productionGoal: productionGoal,
                    verificationCount: userVerificationCount,
                    verificationGoal: verificationGoal,
                    performanceChartData, 
                    dateRangeType,
                    pieChartData,
                    radarChartData
                };
            } catch (error) {
                console.error('Error in calculatePerformance:', error);
                setError(`Calculation error: ${error.message}`);
                return null;
            }
        };

        const perfColor = performance ? getPerformanceColor(performance.overallPerformance) : null;

        useEffect(() => {
    if (!selectedName) {
        setPerformance(null);
        return;
    }
    
    const result = calculatePerformance();
    setPerformance(result);
}, [selectedName, startDate, endDate, data, insPmtData, productionData, appointmentData, configData, pieChartScope, outboundMetric]);
        // Admin handlers
        const handleAdminClick = () => {
            setShowPasswordModal(true);
        };

        const handlePasswordSuccess = async () => {
            setShowPasswordModal(false);
            setLoadingConfig(true);
            try {
                const data = await fetchAdminConfig();
                setConfigData(data);
                setShowAdminMenu(true);
            } catch (error) {
                alert('Failed to load configuration: ' + error.message);
            } finally {
                setLoadingConfig(false);
            }
        };

        const handleAdminMenuSelect = (option) => {
            setShowAdminMenu(false);
            setAdminView(option);
        };

        const handleCloseAdminView = async () => {
            setAdminView(null);
            setShowAdminMenu(true);
            try {
                const data = await fetchAdminConfig();
                setConfigData(data);
                await fetchDataFromSheet();
            } catch (error) {
                console.error('Failed to refresh config:', error);
            }
        };

    return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-3 rounded-xl shadow-lg shadow-cyan-500/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                        <rect x="4" y="2" width="16" height="20" rx="2"/>
                                        <line x1="8" y1="6" x2="16" y2="6"/>
                                    </svg>
                                </div>
                                <h1 className="text-3xl font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">KPI Dashboard</h1>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 bg-slate-800/80 backdrop-blur px-4 py-3 rounded-xl border border-slate-600 shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                    </svg>
                                    <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-transparent text-white text-sm focus:outline-none" />
                                    <span className="text-slate-400 font-bold">-</span>
                                    <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-transparent text-white text-sm focus:outline-none" />
                                </div>

                                <div className="relative">
                                    <select value={selectedName} onChange={(e) => setSelectedName(e.target.value)} className="bg-slate-800 text-white border border-slate-600 rounded-xl px-4 py-3 pr-10 appearance-none cursor-pointer hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all shadow-lg font-medium" style={{minWidth: '160px'}}>
                                        <option value="">Select User</option>
                                        {uniqueNames.map(name => <option key={name} value={name}>{name}</option>)}
                                    </select>
                                    <svg className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>

                                <button onClick={fetchDataFromSheet} disabled={loading} className="flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-gray-600 disabled:to-gray-600 text-white rounded-xl transition-all shadow-lg shadow-cyan-500/30 font-semibold">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                    </svg>
                                    {loading ? 'Refreshing...' : 'Refresh'}
                                </button>

                                <button onClick={handleAdminClick} className="flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white rounded-xl transition-all shadow-lg shadow-amber-500/30 font-semibold">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243m16.97-1.414l-6-6m-6-6l-6 6"/>
                                    </svg>
                                    Admin
                                </button>
                            </div>
                        </div>

                        {error && <div className="mb-6 p-4 bg-red-900/50 border border-red-700 rounded-xl text-red-200 text-sm shadow-lg">{error}</div>}

                        {loading && (
                            <div className="text-center py-20">
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 inline-block shadow-2xl">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                                    <p className="text-slate-300 text-lg">Loading data...</p>
                                </div>
                            </div>
                        )}

                        {!loading && performance && selectedName && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-cyan-900/20 rounded-2xl p-6 border border-cyan-500/30 hover:border-cyan-400 hover:shadow-2xl hover:shadow-cyan-500/20 transition-all relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 w-40 h-40 bg-cyan-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-2.5 rounded-lg shadow-lg shadow-cyan-500/50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"/>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                                    </svg>
                                                </div>
                                                <h3 className="text-cyan-200 text-sm font-semibold">
                                                    {performance.department === 'AR Department' ? 'Total Collection' : performance.department === 'Outbound Department' ? 'Total Production' : 'Total Verifications'}
                                                </h3>
                                            </div>
                                            <p className="text-white text-3xl font-bold mb-2">
                                                {performance.department === 'AR Department' ? `$${parseFloat(performance.totalCollectionAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : performance.department === 'Outbound Department' ? `$${parseFloat(performance.totalProductionAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : performance.verificationCount}
                                            </p>
                                            <div className="flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                                                    <polyline points="17 6 23 6 23 12"/>
                                                </svg>
                                                <span className="text-cyan-300 text-sm font-bold">
                                                    {performance.department === 'AR Department' ? `${performance.collectionPercentage}%` : performance.department === 'Outbound Department' ? `${performance.productionPercentage}%` : `${performance.verificationPercentage}%`} of state
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-purple-900/20 rounded-2xl p-6 border border-purple-500/30 hover:border-purple-400 hover:shadow-2xl hover:shadow-purple-500/20 transition-all relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 w-40 h-40 bg-purple-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-2.5 rounded-lg shadow-lg shadow-purple-500/50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                                    </svg>
                                                </div>
                                                <h3 className="text-purple-200 text-sm font-semibold">
                                                    {performance.department === 'AR Department' ? 'Collection Goal' : performance.department === 'Outbound Department' ? 'Production Goal' : 'Verification Goal'}
                                                </h3>
                                            </div>
                                            <p className="text-white text-3xl font-bold mb-2">
                                                {performance.department === 'AR Department' && performance.collectionGoal ? `$${parseFloat(performance.collectionGoal).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : performance.department === 'Outbound Department' && performance.productionGoal ? `$${parseFloat(performance.productionGoal).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : Math.round(performance.verificationGoal || 0)}
                                            </p>
                                            <p className="text-purple-300 text-sm font-medium">
                                                {performance.offices.length > 1 ? `across ${performance.offices.length} offices` : '1 office'} ‚Ä¢ {performance.numberOfDays} {performance.numberOfDays === 1 ? 'day' : 'days'}
                                            </p>
                                            {performance.offices.length > 1 && (
                                                <p className="text-purple-400 text-xs mt-1">(weighted by office goals)</p>
                                            )}
                                        </div>
                                    </div>

                                    {performance.department === 'Outbound Department' && (
                                        <div className="bg-gradient-to-br from-slate-800 via-slate-800 to-amber-900/20 rounded-2xl p-6 border border-amber-500/30 hover:border-amber-400 hover:shadow-2xl hover:shadow-amber-500/20 transition-all relative overflow-hidden group">
                                            <div className="absolute top-0 right-0 w-40 h-40 bg-amber-500/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                            <div className="relative z-10">
                                                <div className="flex items-center gap-3 mb-4">
                                                    <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-2.5 rounded-lg shadow-lg shadow-amber-500/50">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                                            <polyline points="22 4 12 14.01 9 11.01"/>
                                                        </svg>
                                                    </div>
                                                    <h3 className="text-amber-200 text-sm font-semibold">Completed Appts</h3>
                                                </div>
                                                <p className="text-white text-3xl font-bold mb-2">{performance.totalCompletedAppointments || 0}</p>
                                                <div className="flex items-center gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                                                    </svg>
                                                    <span className="text-amber-300 text-sm font-bold">{performance.appointmentPercentage}% of state</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {perfColor && (
                                        <div className={`bg-gradient-to-br ${perfColor.bg} rounded-2xl p-6 border-2 ${perfColor.border} hover:shadow-2xl transition-all relative overflow-hidden group shadow-xl`}>
                                            <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-500"></div>
                                            <div className="relative z-10">
                                                <div className="flex items-center gap-3 mb-4">
                                                    <div className="bg-white/20 p-2.5 rounded-lg backdrop-blur">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                            <circle cx="12" cy="12" r="10"/>
                                                            <polyline points="12 6 12 12 16 14"/>
                                                        </svg>
                                                    </div>
                                                    <h3 className="text-white text-sm font-semibold">Overall Performance</h3>
                                                </div>
                                                <p className="text-white text-5xl font-black mb-2 drop-shadow-lg">{performance.overallPerformance}%</p>
                                                <p className="text-white/90 text-sm font-medium">
                                                    {performance.offices.length > 1 ? `${performance.offices.length} Offices` : `1 Office`}
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* NEW: Pie Chart and Radar Chart Section */}
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div className="lg:col-span-2 bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-600 shadow-2xl">
                                        <div className="flex items-center gap-3 mb-6">
                                            <div className="bg-gradient-to-br from-blue-500 to-cyan-600 p-2.5 rounded-lg shadow-lg shadow-blue-500/50">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 className="text-xl font-bold text-white">Performance Over Time</h3>
                                                <p className="text-slate-400 text-sm">
                                                    {performance.dateRangeType === 'daily' ? 'Daily Performance (‚â§7 days)' : performance.dateRangeType === 'weekly' ? 'Weekly Performance (‚â§30 days)' : 'Monthly Performance (>30 days)'}
                                                </p>
                                            </div>
                                        </div>
                                        <PerformanceChart performanceData={performance.performanceChartData} />
                                    </div>

                                    {performance.pieChartData && performance.pieChartData.length > 0 && (
                                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-600 shadow-2xl">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-2.5 rounded-lg shadow-lg shadow-cyan-500/50">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                            <circle cx="12" cy="12" r="10"/>
                                                            <line x1="12" y1="2" x2="12" y2="12"/>
                                                            <line x1="12" y1="12" x2="16" y2="8"/>
                                                        </svg>
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-bold text-white">Distribution</h3>
                                                        <p className="text-slate-400 text-xs">Your contribution</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="flex gap-2 mb-4">
                                                <button 
                                                    onClick={() => setPieChartScope('state')}
                                                    className={`flex-1 px-3 py-2 rounded-lg text-xs font-semibold transition-all ${pieChartScope === 'state' ? 'bg-cyan-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                                >
                                                    State
                                                </button>
                                                <button 
                                                    onClick={() => setPieChartScope('overall')}
                                                    className={`flex-1 px-3 py-2 rounded-lg text-xs font-semibold transition-all ${pieChartScope === 'overall' ? 'bg-cyan-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                                >
                                                    Overall
                                                </button>
                                            </div>
                                            
                                            {performance.department === 'Outbound Department' && (
                                                <div className="flex gap-2 mb-4">
                                                    <button 
                                                        onClick={() => setOutboundMetric('production')}
                                                        className={`flex-1 px-2 py-1.5 rounded-lg text-xs font-semibold transition-all ${outboundMetric === 'production' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                                    >
                                                        Production
                                                    </button>
                                                    <button 
                                                        onClick={() => setOutboundMetric('calls')}
                                                        className={`flex-1 px-2 py-1.5 rounded-lg text-xs font-semibold transition-all ${outboundMetric === 'calls' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                                    >
                                                        Calls
                                                    </button>
                                                    <button 
                                                        onClick={() => setOutboundMetric('appointments')}
                                                        className={`flex-1 px-2 py-1.5 rounded-lg text-xs font-semibold transition-all ${outboundMetric === 'appointments' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                                    >
                                                        Appts
                                                    </button>
                                                </div>
                                            )}
                                            
                                            <PieChart data={performance.pieChartData} />
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div className="lg:col-span-2 bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-600 shadow-2xl">
                                        <div className="flex items-center gap-3 mb-6">
                                            <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-2.5 rounded-lg shadow-lg shadow-purple-500/50">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                                </svg>
                                            </div>
                                            <h3 className="text-xl font-bold text-white">Top Tasks</h3>
                                        </div>
                                        <div className="space-y-2 max-h-80 overflow-y-auto custom-scrollbar pr-2">
                                            {performance.taskCounts.map(([taskName, count], index) => (
                                                <div key={taskName} className="bg-slate-700/40 rounded-lg p-3 hover:bg-slate-700/60 transition-all border border-slate-600/50 hover:border-slate-500">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <div className="flex-1 min-w-0">
                                                            <h4 className="text-white font-medium text-sm truncate">{taskName}</h4>
                                                            <div className="flex items-center gap-2 mt-1">
                                                                <span className="text-slate-400 text-xs">{Math.round(count)}</span>
                                                                <span className="text-slate-600">‚Ä¢</span>
                                                                <span className="text-cyan-400 text-xs font-semibold">{performance.taskPercentages[taskName]?.toFixed(1) || 0}% of state</span>
                                                            </div>
                                                        </div>
                                                        <div className="text-right shrink-0">
                                                            <div className="bg-cyan-500/10 px-2 py-1 rounded text-cyan-300 text-xs font-bold">#{index + 1}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}

                                            {performance.unlistedTasks.length > 0 && (
                                                <>
                                                    <div className="pt-3 pb-1">
                                                        <h4 className="text-amber-400 font-semibold text-xs uppercase tracking-wide">Other Tasks</h4>
                                                    </div>
                                                    {performance.unlistedTasks.map(([taskName, count]) => (
                                                        <div key={taskName} className="bg-amber-900/20 rounded-lg p-3 hover:bg-amber-900/30 transition-all border border-amber-700/30">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex-1 pr-4">
                                                                    <h4 className="text-amber-200 font-medium text-sm">{taskName}</h4>
                                                                    <div className="flex items-center gap-2 mt-1">
                                                                        <span className="text-amber-400/70 text-xs">{Math.round(count)}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </>
                                            )}

                                            {performance.taskCounts.length === 0 && performance.unlistedTasks.length === 0 && (
                                                <div className="text-center py-8 text-slate-400"><p className="text-sm">No tasks found</p></div>
                                            )}
                                        </div>
                                    </div>

                                    {performance.radarChartData && performance.radarChartData.length > 0 && (
                                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-600 shadow-2xl">
                                            <div className="flex items-center gap-3 mb-6">
                                                <div className="bg-gradient-to-br from-purple-500 to-pink-600 p-2.5 rounded-lg shadow-lg shadow-purple-500/50">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h3 className="text-lg font-bold text-white">Task Breakdown</h3>
                                                    <p className="text-slate-400 text-xs">
                                                        {performance.department === 'AR Department' ? 'AR Categories' : 
                                                         performance.department === 'Outbound Department' ? 'Call Types' : 
                                                         'Verification Types'}
                                                    </p>
                                                </div>
                                            </div>
                                            <RadarChart data={performance.radarChartData} />
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {!loading && !selectedName && (
                            <div className="text-center py-20">
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 inline-block shadow-2xl">
                                    <div className="bg-gradient-to-br from-blue-600/30 to-blue-500/20 p-4 rounded-full inline-block mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                    </div>
                                    <p className="text-slate-300 mt-4 text-lg">Select an employee to view performance data</p>
                                </div>
                            </div>
                        )}
                    </div>

    {showPasswordModal && (
                        <PasswordModal 
                            onClose={() => setShowPasswordModal(false)}
                            onSuccess={handlePasswordSuccess}
                        />
                    )}

                    {showAdminMenu && (
                        <AdminMenu 
                            onClose={() => setShowAdminMenu(false)}
                            onSelectOption={handleAdminMenuSelect}
                        />
                    )}

                    {adminView === 'goals' && (
                        <GoalManagement 
                            onClose={handleCloseAdminView}
                            configData={configData}
                        />
                    )}

                    {adminView === 'employees' && (
                        <EmployeeAssignment 
                            onClose={handleCloseAdminView}
                            configData={configData}
                        />
                    )}

                    {adminView === 'add-employee' && (
                        <AddEmployee onClose={handleCloseAdminView} />
                    )}

                    {adminView === 'add-office' && (
                        <AddOffice onClose={handleCloseAdminView} />
                    )}

                    {adminView === 'delete-employee' && (
                        <DeleteEmployee 
                            onClose={handleCloseAdminView}
                            configData={configData}
                            onRefresh={async () => {
                                const data = await fetchAdminConfig();
                                setConfigData(data);
                                await fetchDataFromSheet();
                            }}
                        />
                    )}

                    {adminView === 'delete-office' && (
                        <DeleteOffice 
                            onClose={handleCloseAdminView}
                            configData={configData}
                            onRefresh={async () => {
                                const data = await fetchAdminConfig();
                                setConfigData(data);
                                await fetchDataFromSheet();
                            }}
                        />
                    )}

                    {loadingConfig && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                            <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-12 border border-slate-600 shadow-2xl">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                                <p className="text-slate-300 text-lg">Loading configuration...</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<PerformanceTracker />, document.getElementById('root'));
    </script>
</body>
</html>
















